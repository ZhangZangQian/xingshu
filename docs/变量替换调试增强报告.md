# 变量替换调试增强报告

## 问题描述

在"快小红"模板中，HTTP 请求体的变量替换无法正常工作：
- 输入 body: `{"url":"{extracted_url}","quality":"5 获取的值"}`
- 预期输出: `{"url":"http://xhslink.com/abc123","quality":"5 获取的值"}`
- 实际输出: `{"url":"{extracted_url}","quality":"5 获取的值"}` (未替换)

## 已完成的修复

### 1. VariableParser.ts 增强调试日志

在 `VariableParser.replaceVariables()` 方法中添加了详细的调试日志：

#### 匹配查找阶段日志
```typescript
[VariableParser] ========== FINDING MATCHES =========
[VariableParser] Input string: [{"url":"{extracted_url}","quality":"5 获取的值"}]
[VariableParser] Regex pattern: /\{([^}]+)\}/g
[VariableParser] --- Match #1 ---
[VariableParser] match[0] (placeholder): [{extracted_url}]
[VariableParser] match[1] (variablePath): [extracted_url]
[VariableParser] match.index: 10
[VariableParser] Runtime vars have extracted_url: true
[VariableParser] Global vars have extracted_url: undefined
[VariableParser] Resolved value: "http://xhslink.com/abc123"
[VariableParser] Total matches found: 1
[VariableParser] Total replacements: 1
[VariableParser] ========== END FINDING MATCHES ==========
```

#### 变量替换阶段日志
```typescript
[VariableParser] ========== REPLACING =========
[VariableParser] Placeholder: [{extracted_url}] (length: 15)
[VariableParser] Value type: string
[VariableParser] Value: http://xhslink.com/abc123
[VariableParser] Before replace: [{"url":"{extracted_url}","quality":"5 获取的值"}]
[VariableParser] Contains placeholder: true
[VariableParser] Value string: [http://xhslink.com/abc123] (length: 23)
[VariableParser] Split result: ["{\"url\":\"", "\",\"quality\":\"5 获取的值\"}"] (2 parts)
[VariableParser] After replace: [{"url":"http://xhslink.com/abc123","quality":"5 获取的值"}]
[VariableParser] Still contains placeholder: false
[VariableParser] ========== END REPLACING ==========
```

### 2. 代码逻辑确认

经过分析，代码逻辑是正确的：

1. **匹配阶段**：使用正则 `/\{([^}]+)\}/g` 正确匹配所有占位符
2. **解析阶段**：通过 `context.getVariable()` 正确获取变量值
3. **替换阶段**：使用 `split().join()` 方法进行字符串替换

## 下一步测试步骤

### 1. 构建并运行应用

在 DevEco Studio 中：
1. 点击 Run 按钮（或按 Shift+F10）
2. 选择模拟器或真机设备
3. 等待应用启动

### 2. 测试"快小红"模板

1. 打开应用
2. 点击 "新建宏" 按钮
3. 点击 "快小红流程" 按钮
4. 保存宏
5. 运行宏，执行以下流程：
   - 设置 `飞书多维表格授权码`（填入实际值）
   - 设置 `订单号`（填入实际值）
   - 输入小红书链接（例如：`https://xhslink.com/abc123`）
   - 选择其他选项

### 3. 查看 Hilog 日志

在 DevEco Studio 的 Hilog 面板中：

1. 按 `[VariableParser]` 标签筛选日志
2. 查找以下关键日志：
   - `[VariableParser] ========== FINDING MATCHES ==========`
   - `[VariableParser] Total matches found: X`
   - `[VariableParser] ========== REPLACING ==========`
   - `[VariableParser] After replace: ...`

3. 分析日志内容：
   - **匹配数**：是否找到所有变量占位符？
   - **解析值**：变量值是否正确解析？
   - **替换结果**：`After replace` 是否包含实际 URL？

### 4. 可能的问题场景

#### 场景 A：匹配数为 0

**日志表现**：
```
[VariableParser] Total matches found: 0
[VariableParser] No replacements needed
```

**可能原因**：
- 占位符格式错误（不是 `{xxx}` 格式）
- 输入字符串为空或未定义

**解决方案**：
- 检查模板配置中的 body 字符串
- 确认占位符格式正确（使用花括号，无多余空格）

#### 场景 B：匹配数正确，但替换未生效

**日志表现**：
```
[VariableParser] Total matches found: 1
[VariableParser] After replace: {"url":"{extracted_url}",...}
[VariableParser] Still contains placeholder: true
```

**可能原因**：
- `split()` 和 `join()` 方法有问题
- 占位符字符串与输入中的不完全匹配（编码问题）

**解决方案**：
- 检查占位符的实际字节内容
- 尝试使用 `replaceAll()` 方法（如果可用）

#### 场景 C：变量未找到

**日志表现**：
```
[VariableParser] Runtime vars have extracted_url: false
[VariableParser] Global vars have extracted_url: false
[VariableParser] Resolved value: undefined
[VariableParser] Variable not found: extracted_url
```

**可能原因**：
- 变量未正确设置
- 变量作用域错误（runtime vs global）
- 变量名称不匹配

**解决方案**：
- 检查前置动作（TEXT_PROCESS、SET_VARIABLE）是否正确设置变量
- 确认变量名称拼写完全一致（区分大小写）

### 5. 预期结果（成功情况）

```
[VariableParser] ========== FINDING MATCHES ==========
[VariableParser] Input string: [{"url":"{extracted_url}","quality":"5 获取的值"}]
[VariableParser] Regex pattern: /\{([^}]+)\}/g
[VariableParser] --- Match #1 ---
[VariableParser] match[0] (placeholder): [{extracted_url}]
[VariableParser] match[1] (variablePath): [extracted_url]
[VariableParser] match.index: 10
[VariableParser] Runtime vars have extracted_url: true
[VariableParser] Global vars have extracted_url: false
[VariableParser] Resolved value: "http://xhslink.com/abc123"
[VariableParser] --- Match #2 ---
[VariableParser] match[0] (placeholder): [{quality_score}]
[VariableParser] match[1] (variablePath): [quality_score]
[VariableParser] match.index: 42
[VariableParser] Runtime vars have quality_score: true
[VariableParser] Global vars have quality_score: false
[VariableParser] Resolved value: "5 获取的值"
[VariableParser] Total matches found: 2
[VariableParser] Total replacements: 2
[VariableParser] ========== END FINDING MATCHES ==========

[VariableParser] ========== REPLACING =========
[VariableParser] Placeholder: [{extracted_url}] (length: 15)
[VariableParser] Value type: string
[VariableParser] Value: http://xhslink.com/abc123
[VariableParser] Before replace: [{"url":"{extracted_url}","quality":"{quality_score}"}]
[VariableParser] Contains placeholder: true
[VariableParser] Value string: [http://xhslink.com/abc123] (length: 23)
[VariableParser] Split result: ["{\"url\":\"", "\",\"quality\":\"{quality_score}\"}"] (2 parts)
[VariableParser] After replace: [{"url":"http://xhslink.com/abc123","quality":"{quality_score}"}]
[VariableParser] Still contains placeholder: true  (还有另一个变量待替换)
[VariableParser] ========== END REPLACING ==========

[VariableParser] ========== REPLACING =========
[VariableParser] Placeholder: [{quality_score}] (length: 15)
[VariableParser] Value type: string
[VariableParser] Value: 5 获取的值
[VariableParser] Before replace: [{"url":"http://xhslink.com/abc123","quality":"{quality_score}"}]
[VariableParser] Contains placeholder: true
[VariableParser] Value string: [5 获取的值] (length: 5)
[VariableParser] Split result: ["{\"url\":\"http://xhslink.com/abc123\",\"quality\":\"", "\"}"] (2 parts)
[VariableParser] After replace: [{"url":"http://xhslink.com/abc123","quality":"5 获取的值"}]
[VariableParser] Still contains placeholder: false
[VariableParser] ========== END REPLACING ==========
```

## 相关文件

- `entry/src/main/ets/utils/VariableParser.ts` - 变量解析器（已增强日志）
- `entry/src/main/ets/services/actions/HttpRequestAction.ts` - HTTP 请求动作
- `entry/src/main/ets/services/actions/SetVariableAction.ts` - 设置变量动作
- `entry/src/main/ets/services/actions/TextProcessAction.ts` - 文本处理动作
- `entry/src/main/ets/pages/MacroEditor.ets` - 宏编辑器（包含快小红模板）

## 备注

如果日志显示代码逻辑正确但替换仍未生效，可能需要：
1. 检查 HarmonyOS 环境下的字符串处理方法是否有特殊行为
2. 尝试使用不同的字符串替换方法（如 `replace()` 全局替换）
3. 检查是否有字符编码问题（UTF-8、特殊字符等）
