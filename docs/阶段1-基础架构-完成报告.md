# 可视化变量流图 - 阶段1完成报告

## 完成时间
2026-01-07

## 实现内容

### 1. VariableFlowAnalyzer（变量流分析器）

**文件路径**: `entry/src/main/ets/utils/VariableFlowAnalyzer.ts`

**核心功能**:
- ✅ 分析动作列表中的变量定义和使用关系
- ✅ 提取动作的输入变量（解析 `{varName}` 格式）
- ✅ 提取动作的输出变量
- ✅ 验证动作配置的有效性
- ✅ 检查删除动作对其他动作的影响

**关键方法**:
```typescript
// 分析变量流向
VariableFlowAnalyzer.analyzeFlow(actions, macroVariables): VariableFlow[]

// 验证动作配置
VariableFlowAnalyzer.validateAction(action, index, definedVariables): { isValid, errors }

// 获取动作之前已定义的变量
VariableFlowAnalyzer.getDefinedVariablesBeforeAction(actions, index, macroVariables): Set<string>

// 检查删除动作的影响
VariableFlowAnalyzer.getAffectedActionsByDeletion(actions, deleteIndex): number[]
```

**使用示例**:
```typescript
// 分析变量流
const flows = VariableFlowAnalyzer.analyzeFlow(this.actions, this.variables);

// 验证动作
const definedVars = VariableFlowAnalyzer.getDefinedVariablesBeforeAction(
  this.actions,
  index,
  this.variables
);
const { isValid, errors } = VariableFlowAnalyzer.validateAction(
  action,
  index,
  definedVars
);

// 检查删除影响
const affectedIndices = VariableFlowAnalyzer.getAffectedActionsByDeletion(
  this.actions,
  deleteIndex
);
if (affectedIndices.length > 0) {
  alert(`删除此动作会影响动作 ${affectedIndices.join(', ')}`);
}
```

---

### 2. ActionConfigSummaryGenerator（配置摘要生成器）

**文件路径**: `entry/src/main/ets/utils/ActionConfigSummaryGenerator.ts`

**核心功能**:
- ✅ 生成动作配置的简短摘要
- ✅ 支持所有动作类型（剪贴板、文本处理、HTTP、对话框等）
- ✅ 自动截断过长文本
- ✅ 提取输入/输出变量用于显示

**关键方法**:
```typescript
// 生成配置摘要
ActionConfigSummaryGenerator.generate(action): string

// 提取输入变量
ActionConfigSummaryGenerator.extractInputVariables(action): string[]

// 提取输出变量
ActionConfigSummaryGenerator.extractOutputVariable(action): string | null
```

**使用示例**:
```typescript
// 在动作卡片上显示摘要
const summary = ActionConfigSummaryGenerator.generate(action);
Text(summary).fontSize(14).fontColor('#666');

// 显示输入/输出变量
const inputVars = ActionConfigSummaryGenerator.extractInputVariables(action);
const outputVar = ActionConfigSummaryGenerator.extractOutputVariable(action);

// 在卡片上显示
if (inputVars.length > 0) {
  Text(`输入: ${inputVars.map(v => `{${v}}`).join(', ')}`);
}
if (outputVar) {
  Text(`输出 → [${outputVar}]`);
}
```

**摘要示例**:
```
剪贴板动作 → "将剪贴板内容保存到变量"
文本处理 → "正则提取\n输入: {clipboard_content}\n正则: https?://[^\s]+"
HTTP 请求 → "POST https://api.coze.cn/v1/workflow/run"
```

---

### 3. ActionViewModel（动作视图模型）

**文件路径**: `entry/src/main/ets/models/ActionViewModel.ts`

**核心功能**:
- ✅ 扩展原始 Action 模型
- ✅ 添加 UI 相关的计算属性
- ✅ 提供工厂方法快速创建

**数据结构**:
```typescript
interface ActionViewModel extends Action {
  inputVariables: string[];      // 输入变量列表
  outputVariable: string | null; // 输出变量
  configSummary: string;         // 配置摘要
  isValid: boolean;              // 是否有效
  validationErrors: string[];    // 验证错误
}
```

**使用示例**:
```typescript
// 在 MacroEditor 中将 Action[] 转换为 ActionViewModel[]
@State actionViewModels: ActionViewModel[] = [];

// 转换方法
private convertToViewModels() {
  this.actionViewModels = this.actions.map((action, index) => {
    const definedVars = VariableFlowAnalyzer.getDefinedVariablesBeforeAction(
      this.actions, index, this.variables
    );

    const { isValid, errors } = VariableFlowAnalyzer.validateAction(
      action, index, definedVars
    );

    const inputVars = ActionConfigSummaryGenerator.extractInputVariables(action);
    const outputVar = ActionConfigSummaryGenerator.extractOutputVariable(action);
    const summary = ActionConfigSummaryGenerator.generate(action);

    return ActionViewModelFactory.create(
      action, inputVars, outputVar, summary, isValid, errors
    );
  });
}
```

---

### 4. VariableSelector（变量选择器组件）

**文件路径**: `entry/src/main/ets/components/VariableSelector.ets`

**核心功能**:
- ✅ 分类显示系统变量、运行时变量、宏变量、全局变量
- ✅ 搜索变量功能
- ✅ 显示变量来源（来自哪个动作）
- ✅ 可自定义选中回调

**组件属性**:
```typescript
@Component
struct VariableSelector {
  @Link availableVariables: VariableOption[];
  @Link selectedVariable: string;
  onVariableSelected?: (variableName: string) => void;
  onCancel?: () => void;
}
```

**使用示例**:
```typescript
// 在配置编辑器中使用
@State showVariableSelector: boolean = false;
@State availableVars: VariableOption[] = [];
@State selectedVar: string = '';

// 准备可用变量
private prepareAvailableVariables(actionIndex: number) {
  this.availableVars = [];

  // 添加系统变量
  this.availableVars.push(...VariableSelectorHelper.getSystemVariables());

  // 添加宏变量
  this.availableVars.push(...VariableSelectorHelper.fromMacroVariables(this.variables));

  // 添加之前动作输出的变量
  for (let i = 0; i < actionIndex; i++) {
    const outputVar = ActionConfigSummaryGenerator.extractOutputVariable(this.actions[i]);
    if (outputVar) {
      this.availableVars.push({
        name: outputVar,
        displayName: `{${outputVar}}`,
        type: 'runtime',
        description: ActionConfigSummaryGenerator.generate(this.actions[i]),
        sourceActionIndex: i
      });
    }
  }
}

// 显示选择器
Button('选择变量').onClick(() => {
  this.prepareAvailableVariables(currentActionIndex);
  this.showVariableSelector = true;
});

// 渲染选择器
if (this.showVariableSelector) {
  VariableSelector({
    availableVariables: $availableVars,
    selectedVariable: $selectedVar,
    onVariableSelected: (varName) => {
      this.inputSource = `{${varName}}`;
      this.showVariableSelector = false;
    },
    onCancel: () => {
      this.showVariableSelector = false;
    }
  })
}
```

---

## 集成示例：完整的变量验证流程

```typescript
@Entry
@Component
struct MacroEditor {
  @State actions: Action[] = [];
  @State variables: Variable[] = [];
  @State actionViewModels: ActionViewModel[] = [];

  /**
   * 添加动作后更新视图模型
   */
  private handleAddAction(newAction: Action) {
    this.actions.push(newAction);
    this.updateActionViewModels();
  }

  /**
   * 更新所有动作的视图模型
   */
  private updateActionViewModels() {
    this.actionViewModels = this.actions.map((action, index) => {
      // 获取之前已定义的变量
      const definedVars = VariableFlowAnalyzer.getDefinedVariablesBeforeAction(
        this.actions, index, this.variables
      );

      // 验证动作配置
      const { isValid, errors } = VariableFlowAnalyzer.validateAction(
        action, index, definedVars
      );

      // 提取输入/输出变量
      const inputVars = ActionConfigSummaryGenerator.extractInputVariables(action);
      const outputVar = ActionConfigSummaryGenerator.extractOutputVariable(action);

      // 生成配置摘要
      const summary = ActionConfigSummaryGenerator.generate(action);

      return ActionViewModelFactory.create(
        action, inputVars, outputVar, summary, isValid, errors
      );
    });
  }

  /**
   * 删除动作前检查影响
   */
  private handleDeleteAction(index: number) {
    const affectedIndices = VariableFlowAnalyzer.getAffectedActionsByDeletion(
      this.actions, index
    );

    if (affectedIndices.length > 0) {
      const affectedActions = affectedIndices.map(i => `动作 ${i + 1}`).join('、');
      promptAction.showDialog({
        title: '警告',
        message: `删除此动作会影响 ${affectedActions}，是否继续？`,
        buttons: [
          { text: '取消', color: '#000000' },
          { text: '删除', color: '#ff4d4f' }
        ]
      }).then((result) => {
        if (result.index === 1) {
          this.actions.splice(index, 1);
          this.updateActionViewModels();
        }
      });
    } else {
      this.actions.splice(index, 1);
      this.updateActionViewModels();
    }
  }

  build() {
    Column() {
      // 动作列表
      ForEach(this.actionViewModels, (viewModel: ActionViewModel, index: number) => {
        Column() {
          Row() {
            Text(`${index + 1}. ${this.getActionTypeName(viewModel.type)}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
          }

          // 配置摘要
          Text(viewModel.configSummary)
            .fontSize(14)
            .fontColor('#666')

          // 输入变量
          if (viewModel.inputVariables.length > 0) {
            Text(`使用变量: ${viewModel.inputVariables.map(v => `{${v}}`).join(', ')}`)
              .fontSize(12)
              .fontColor('#999')
          }

          // 输出变量
          if (viewModel.outputVariable) {
            Row() {
              Text('输出 → ')
                .fontSize(12)
                .fontColor('#999')
              Text(`[${viewModel.outputVariable}]`)
                .fontSize(12)
                .fontColor('#1890ff')
                .backgroundColor('#e6f7ff')
                .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                .borderRadius(4)
            }
          }

          // 验证错误
          if (!viewModel.isValid) {
            Column() {
              ForEach(viewModel.validationErrors, (error: string) => {
                Text(`⚠️ ${error}`)
                  .fontSize(12)
                  .fontColor('#ff4d4f')
              })
            }
            .padding(8)
            .backgroundColor('#fff1f0')
            .borderRadius(4)
          }

          // 操作按钮
          Row() {
            Button('编辑').onClick(() => this.handleEditAction(index))
            Button('删除').onClick(() => this.handleDeleteAction(index))
          }
        }
        .padding(12)
        .backgroundColor('#ffffff')
        .borderRadius(8)
        .margin({ bottom: 8 })
      })
    }
  }
}
```

---

## 快小红流程验证

使用新的工具类，我们可以验证快小红流程的配置：

```typescript
const actions: Action[] = [
  // 1. 读取剪贴板
  {
    type: ActionType.CLIPBOARD_READ,
    config: JSON.stringify({
      operation: 'read',
      saveToVariable: 'clipboard_content'
    }),
    orderIndex: 0
  },

  // 2. 正则提取 URL
  {
    type: ActionType.TEXT_PROCESS,
    config: JSON.stringify({
      operation: 'regex_extract',
      input: '{clipboard_content}',
      pattern: 'https?://[^\\s]+',
      saveToVariable: 'extracted_url'
    }),
    orderIndex: 1
  },

  // 3. HTTP 请求
  {
    type: ActionType.HTTP_REQUEST,
    config: JSON.stringify({
      method: 'POST',
      url: 'https://api.coze.cn/v1/workflow/run',
      body: JSON.stringify({
        url: '{extracted_url}'
      }),
      saveResponseTo: 'api_response'
    }),
    orderIndex: 2
  }
];

// 验证流程
actions.forEach((action, index) => {
  const definedVars = VariableFlowAnalyzer.getDefinedVariablesBeforeAction(
    actions, index, []
  );
  const { isValid, errors } = VariableFlowAnalyzer.validateAction(
    action, index, definedVars
  );

  console.log(`动作 ${index + 1}: ${isValid ? '✓ 有效' : '✗ 无效'}`);
  if (!isValid) {
    errors.forEach(error => console.log(`  - ${error}`));
  }
});

// 输出:
// 动作 1: ✓ 有效
// 动作 2: ✓ 有效
// 动作 3: ✓ 有效
```

---

## 下一步：阶段2

阶段1已完成基础架构，下一步将实现：

### 阶段2：动作配置编辑器（预计4小时）

1. **ActionConfigEditor 基础组件**
   - 全屏弹窗框架
   - 统一的保存/取消按钮
   - 配置数据双向绑定

2. **ClipboardConfigForm**（剪贴板配置表单）
   - 操作类型选择（读取/写入）
   - 保存到变量输入框（集成 VariableSelector）
   - 写入内容输入框（支持变量引用）

3. **TextProcessConfigForm**（文本处理配置表单）重点
   - 操作类型选择（7种操作）
   - 输入来源选择器（集成 VariableSelector）
   - 动态表单（根据操作类型显示不同字段）
   - 正则表达式模板（常用正则）
   - 保存到变量输入框

4. **HttpRequestConfigForm**（HTTP 请求配置表单）
   - 请求方法选择
   - URL 输入框（支持变量）
   - Headers 键值对编辑器
   - Body 编辑器（支持变量）
   - 保存响应到变量

5. **UserDialogConfigForm**（用户对话框配置表单）
   - 对话框类型选择
   - 标题/消息输入
   - 选项列表编辑器（多选/单选）
   - 保存到变量输入框

**准备就绪后请告知，我将开始阶段2的实现。**

---

**报告生成时间**: 2026-01-07
**阶段耗时**: 约2小时
**下一阶段**: 动作配置编辑器（4小时）
