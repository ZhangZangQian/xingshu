# 宏卡片正方形布局优化

## 优化日期
2025-01-11

## 问题描述
1. 宏卡片仍过宽，希望呈现正方形外观
2. 禁用图标（开关）被右侧遮挡，无法正常显示

## 优化内容

### 1. 网格卡片布局重构

#### 布局变更

**优化前（横向布局）**
```
┌─────────────────────────┐
│ ┌──┐ 标题      ⚪     │  <-- Row 布局
│ │📱│                   │      图标左，内容右
│ └──┘ 描述              │
│      标签              │
└─────────────────────────┘
```

**优化后（纵向布局）**
```
┌──────────┐
│    ⚪   │  <-- Stack 布局
│  ┌────┐ │     开关浮动在右上
│  │ 📱 │ │
│  └────┘ │
│  标题   │  <-- Column 纵向
│  标签   │     布局
└──────────┘
```

#### 组件结构变更

**优化前**
```typescript
Column() {
  Row() {  // 横向布局
    图标容器
    Column() {
      标题 + 开关
      描述
      标签
    }
  }
}
```

**优化后**
```typescript
Stack() {  // 层叠布局
  Column() {  // 纵向布局
    图标容器
    标题（居中）
    标签（居中）
  }
  Toggle() {  // 浮动在右上
    开关
  }
}
```

### 2. 尺寸调整

| 项目 | 优化前 | 优化后 | 说明 |
|------|--------|--------|------|
| 布局方式 | 横向 (Row) | 纵向 (Column) | 更紧凑 |
| 图标尺寸 | 52×52px | 60×60px | 更突出 |
| 图标圆角 | 12px | 14px | 更柔和 |
| 图标字号 | 32px | 36px | 更清晰 |
| 卡片内边距 | 10px | 12px | 更舒适 |
| 标题字号 | 15px | 14px | 略微缩小 |
| 标题对齐 | 左对齐 | 居中 | 正方形布局 |
| 标签字号 | 10px | 9px | 更紧凑 |
| 标签间距 | 6px | 4px | 更紧凑 |
| 标签内边距 | 6px/2px | 5px/2px | 更紧凑 |
| 开关位置 | 标题右侧 | 右上角浮动 | 避免遮挡 |
| 开关尺寸 | 28×18px | 28×18px | 保持不变 |

### 3. 交互优化

#### 开关按钮防冒泡

**优化前**
```typescript
Toggle({ type: ToggleType.Switch, isOn: this.macro.enabled })
  .onChange((isOn: boolean) => {
    this.onToggle(this.macro.id, isOn);
  })
```

**优化后**
```typescript
Toggle({ type: ToggleType.Switch, isOn: this.macro.enabled })
  .margin({ top: 6, right: 6 })
  .onChange((isOn: boolean) => {
    this.onToggle(this.macro.id, isOn);
  })
  .zIndex(10)  // 确保在最上层
  .onClick((event: ClickEvent) => {
    event.stopPropagation();  // 防止冒泡到卡片
  })
```

#### 视觉层次

```
zIndex 层级：
┌─────────────────────┐
│ 10: Toggle (开关)   │  <-- 最上层，优先交互
├─────────────────────┤
│  0: 卡片主体        │  <-- 下层
└─────────────────────┘
```

### 4. Grid 布局调整

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| 列间距 | 10px | 12px |
| 行间距 | 10px | 12px |
| 高度设置 | 未设置 | 100% |

## 代码实现

### MacroCard.ets - buildGridCard()

```typescript
@Builder
buildGridCard() {
  Stack({ alignContent: Alignment.TopEnd }) {
    // 卡片主体（纵向布局）
    Column() {
      // 图标容器
      Column() {
        Text(this.getMacroIcon())
          .fontSize(36)  // 增大
          .fontColor('#FFFFFF')
      }
      .width(60)  // 增大
      .height(60)
      .borderRadius(14)  // 更圆润
      .backgroundColor(this.getMacroColor())
      .shadow({
        radius: 8,
        color: '#26000000',
        offsetX: 0,
        offsetY: 3
      })
      .justifyContent(FlexAlign.Center)
      .margin({ bottom: 12 })

      // 内容区（标题 + 标签）
      Column({ space: 8 }) {
        Text(this.macro.name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .textAlign(TextAlign.Center)  // 居中
          .width('100%')

        Row({ space: 4 }) {
          ForEach(this.getTriggerTags().slice(0, 2), (tag: TriggerTag) => {
            Row({ space: 3 }) {
              Text(tag.icon)
                .fontSize(9)
              Text(tag.text)
                .fontSize(9)
                .fontColor('#AEAEB2')
            }
            .padding({ left: 5, right: 5, top: 2, bottom: 2 })
            .borderRadius(4)
            .backgroundColor('#F2F2F7')
          })
        }
        .justifyContent(FlexAlign.Center)  // 居中
        .width('100%')
      }
      .alignItems(HorizontalAlign.Center)
      .width('100%')
    }
    .padding(12)
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#14000000',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.onTrigger(this.macro.id);
    })

    // 开关按钮（右上角浮动）
    Toggle({ type: ToggleType.Switch, isOn: this.macro.enabled })
      .width(28)
      .height(18)
      .margin({ top: 6, right: 6 })
      .onChange((isOn: boolean) => {
        this.onToggle(this.macro.id, isOn);
      })
      .zIndex(10)  // 确保在最上层
      .onClick((event: ClickEvent) => {
        event.stopPropagation();  // 防止冒泡
      })
  }
}
```

### MacrosTab.ets - Grid 布局

```typescript
Grid() {
  ForEach(this.macros, (macro: Macro) => {
    GridItem() {
      MacroCard({
        macro: macro,
        viewMode: this.viewMode,
        onToggle: (id: number, enabled: boolean) => {
          this.handleToggleMacro(id, enabled);
        },
        onTrigger: (id: number) => {
          this.handleTriggerMacro(id);
        },
        onEdit: (id: number) => {
          this.handleEditMacro(id);
        },
        onDelete: (id: number) => {
          this.handleDeleteMacro(id);
        },
        onMore: (id: number) => {
          this.handleMoreMacro(id);
        }
      })
    }
  }, (macro: Macro) => macro.id.toString())
}
.columnsTemplate('1fr 1fr')
.columnsGap(12)  // 间距适当
.rowsGap(12)
.padding({ left: 16, right: 16, top: 12, bottom: 80 })
.width('100%')
.height('100%')  // 确保 Grid 正确计算高度
```

## 设计效果

### 正方形比例

假设屏幕宽度 375px：
- 左右边距：16px + 16px = 32px
- 列间距：12px
- 可用宽度：375 - 32 - 12 = 331px
- 单列宽度：331 / 2 = 165.5px

卡片高度计算（近似）：
- 顶部内边距：12px
- 图标容器：60px
- 图标下边距：12px
- 标题（2行）：约 32px
- 内容间距：8px
- 标签：约 20px
- 底部内边距：12px
- **总高度：约 156px**

宽高比：165.5 / 156 ≈ 1.06（接近正方形）

### 与设计方案对比

**设计方案中的快捷指令风格卡片**：
```
┌─────────────────────────────────┐
│  ┌─────┐  快小红宏    ⋯ 🔴   │  <-- 横向布局
│  │ 📱  │                         │
│  └─────┘                         │
│  从小红书采集内容到飞书          │
│  多维表格                         │
│  ⏱️ 定时 · 🔔 通知                │
└─────────────────────────────────┘
```

**实际优化后的卡片**：
```
┌──────────┐
│    ⚪   │  <-- 开关在右上
│  ┌────┐ │
│  │ 📱 │ │  <-- 图标居中
│  └────┘ │
│  快小红  │  <-- 标题居中
│  ⏱️定时  │  <-- 标签居中
└──────────┘
```

**差异说明**：
- 设计方案：横向布局，适合列表模式
- 实际实现：纵向布局，适合网格模式，接近正方形

## 技术要点

### 1. Stack 层叠布局
- `alignContent: Alignment.TopEnd` - 开关对齐到右上角
- 子组件按定义顺序层叠，zIndex 控制显示层级

### 2. Toggle 防冒泡
- `.onClick((event: ClickEvent) => { event.stopPropagation(); })`
- 确保点击开关不会触发卡片点击事件

### 3. 纵向居中
- `.textAlign(TextAlign.Center)` - 文本居中
- `.justifyContent(FlexAlign.Center)` - 容器居中
- `.alignItems(HorizontalAlign.Center)` - 子元素居中

## 测试建议

### 视觉测试
- [ ] 检查卡片是否接近正方形
- [ ] 确认开关按钮在右上角正常显示
- [ ] 验证图标、标题、标签居中对齐
- [ ] 检查不同内容长度下的显示效果

### 交互测试
- [ ] 点击卡片主体执行宏
- [ ] 点击开关切换启用/禁用
- [ ] 确认开关点击不会触发卡片点击
- [ ] 验证开关不会被遮挡

### 响应式测试
- [ ] 小屏幕（375px）显示效果
- [ ] 大屏幕（428px）显示效果
- [ ] 横屏模式显示效果

## 后续优化建议

1. **卡片高度自适应**
   - 根据标题行数动态调整高度
   - 确保所有卡片高度一致

2. **响应式图标大小**
   - 大屏幕：增大图标尺寸
   - 小屏幕：保持当前尺寸

3. **长标题处理**
   - 超过 2 行使用省略号
   - 考虑添加全屏查看详情功能

4. **空状态图标**
   - 默认图标使用更通用的图标
   - 支持用户自定义图标

## 文件变更清单

| 文件 | 修改类型 | 变更内容 |
|------|----------|----------|
| `components/MacroCard.ets` | 修改 | 重构 buildGridCard 为纵向布局 |
| `pages/MacrosTab.ets` | 修改 | 调整 Grid 间距和高度 |

## 总结

通过将网格卡片从横向布局改为纵向布局，并使用 Stack 实现开关浮动在右上角，成功实现了：
1. ✅ 卡片呈现接近正方形的外观
2. ✅ 开关按钮不再被遮挡，可正常显示和交互
3. ✅ 内容居中对齐，视觉更平衡
4. ✅ 优化了防冒泡逻辑，交互更准确

卡片现在更符合用户预期的正方形设计，同时保持了良好的交互体验。
