# 可视化变量流图 - 阶段2完成报告

## 完成时间
2026-01-07

## 实现内容

### 1. ActionConfigEditor（动作配置编辑器框架）

**文件路径**: `entry/src/main/ets/components/ActionConfigEditor.ets`

**核心功能**:
- ✅ 全屏CustomDialog弹窗框架
- ✅ 统一的保存/取消按钮
- ✅ 配置数据双向绑定（通过 @Link）
- ✅ 根据动作类型显示不同配置表单
- ✅ 统一的配置验证逻辑

**使用示例**:
```typescript
@State editingAction: Action = { ... };
@State availableVars: VariableOption[] = [];

actionConfigDialogController: CustomDialogController = new CustomDialogController({
  builder: ActionConfigEditor({
    action: $editingAction,
    availableVariables: $availableVars,
    isEditMode: true,
    onSave: (action: Action) => {
      // 保存动作配置
      this.updateAction(action);
    },
    onCancel: () => {
      // 取消编辑
    }
  }),
  autoCancel: false,
  customStyle: true
});

// 打开编辑器
this.actionConfigDialogController.open();
```

---

### 2. 剪贴板配置表单

**支持配置**:
- ✅ 操作类型选择（读取/写入）
- ✅ 读取模式：保存到变量名输入
- ✅ 写入模式：写入内容输入（支持变量引用）
- ✅ 实时切换表单字段

**UI 预览**:
```
┌────────────────────────────────┐
│  操作类型 *                     │
│  [读取] [写入]                  │
│                                │
│  保存到变量 *                   │
│  ┌──────────────────────────┐ │
│  │ clipboard_content        │ │
│  └──────────────────────────┘ │
│  变量命名规则：字母开头...      │
└────────────────────────────────┘
```

---

### 3. 文本处理配置表单（最复杂）

**支持配置**:
- ✅ 7种操作类型选择（正则提取、替换、分割、大小写转换、URL编解码）
- ✅ 输入来源配置（支持变量引用）
- ✅ 正则提取：正则表达式输入 + 常用模板 + 捕获组索引
- ✅ 文本替换：搜索值 + 替换值
- ✅ 文本分割：分隔符配置
- ✅ 保存结果到变量

**特色功能**:
- **正则模板库**：URL、邮箱、手机号、数字等常用正则
- **动态表单**：根据操作类型自动显示/隐藏相关配置项
- **变量选择器按钮**（待集成）

**UI 预览**:
```
┌──────────────────────────────────┐
│  操作类型 *                       │
│  [正则提取] [文本替换]            │
│  [文本分割] [转大写] ...          │
│                                  │
│  输入来源 *                       │
│  ┌────────────────┬──────────┐  │
│  │ {clipboard...  │ 选择变量 │  │
│  └────────────────┴──────────┘  │
│                                  │
│  正则表达式 *                     │
│  ┌──────────────────────────┐   │
│  │ https?://[^\s]+          │   │
│  └──────────────────────────┘   │
│  常用模板:                       │
│  [URL] [邮箱] [手机号] [数字]    │
│                                  │
│  捕获组索引                      │
│  ┌──────────────────────────┐   │
│  │ 0（默认：完整匹配）       │   │
│  └──────────────────────────┘   │
│                                  │
│  保存结果到变量 *                 │
│  ┌──────────────────────────┐   │
│  │ extracted_url            │   │
│  └──────────────────────────┘   │
└──────────────────────────────────┘
```

---

### 4. HTTP 请求配置表单

**支持配置**:
- ✅ 请求方法选择（GET/POST/PUT/DELETE）
- ✅ URL 输入（支持变量引用）
- ✅ Content-Type 配置
- ✅ 请求体编辑（仅 POST/PUT 显示，支持变量引用）
- ✅ 超时时间配置
- ✅ 保存响应到变量

**UI 预览**:
```
┌──────────────────────────────────┐
│  请求方法 *                       │
│  [GET] [POST] [PUT] [DELETE]     │
│                                  │
│  URL *                           │
│  ┌──────────────────────────┐   │
│  │ https://api.coze.cn/...  │   │
│  └──────────────────────────┘   │
│  支持引用变量，例如：.../{url}   │
│                                  │
│  Content-Type                    │
│  ┌──────────────────────────┐   │
│  │ application/json         │   │
│  └──────────────────────────┘   │
│                                  │
│  请求体（Body）                  │
│  ┌──────────────────────────┐   │
│  │ {                        │   │
│  │   "url": "{extracted...", │   │
│  │   "quality": "{quality}" │   │
│  │ }                        │   │
│  └──────────────────────────┘   │
│  支持引用变量，例如：{"url": ... │
│                                  │
│  保存响应到变量                   │
│  ┌──────────────────────────┐   │
│  │ api_response             │   │
│  └──────────────────────────┘   │
└──────────────────────────────────┘
```

---

### 5. 用户对话框配置表单

**支持配置**:
- ✅ 4种对话框类型（确认、单选、多选、文本输入）
- ✅ 标题和消息配置
- ✅ 选项列表编辑（单选/多选，每行一个选项）
- ✅ 文本输入：占位符和默认值
- ✅ 保存到变量

**UI 预览**:
```
┌──────────────────────────────────┐
│  对话框类型 *                     │
│  [确认对话框] [单选对话框]        │
│  [多选对话框] [文本输入]          │
│                                  │
│  对话框标题 *                     │
│  ┌──────────────────────────┐   │
│  │ 请选择爆款标记            │   │
│  └──────────────────────────┘   │
│                                  │
│  提示消息                        │
│  ┌──────────────────────────┐   │
│  │ 选择内容的火爆程度        │   │
│  └──────────────────────────┘   │
│                                  │
│  选项列表 *                      │
│  ┌──────────────────────────┐   │
│  │ 普通款                    │   │
│  │ 潜力款                    │   │
│  │ 大爆款                    │   │
│  └──────────────────────────┘   │
│  每行输入一个选项                 │
│                                  │
│  保存到变量                      │
│  ┌──────────────────────────┐   │
│  │ quality                  │   │
│  └──────────────────────────┘   │
└──────────────────────────────────┘
```

---

## 完整的快小红流程配置示例

使用新的配置编辑器，用户可以这样配置快小红流程：

### 动作 1：读取剪贴板
```
操作类型：读取
保存到变量：clipboard_content
```

### 动作 2：文本处理 - 正则提取
```
操作类型：正则提取
输入来源：{clipboard_content}
正则表达式：https?://[^\s]+
捕获组索引：0
保存到变量：extracted_url
```

### 动作 3：用户对话框 - 单选
```
对话框类型：单选对话框
标题：请选择爆款标记
选项列表：
  普通款
  潜力款
  大爆款
保存到变量：quality
```

### 动作 4：用户对话框 - 多选
```
对话框类型：多选对话框
标题：请选择分类标签
选项列表：
  时尚美妆
  旅游出行
  美食消费
  学习教育
  ...（40+ 个选项）
保存到变量：labels
```

### 动作 5：HTTP POST 请求
```
请求方法：POST
URL：https://api.coze.cn/v1/workflow/run
Content-Type：application/json
请求体：
{
  "workflow_id": "7550495126771449906",
  "parameters": {
    "url": "{extracted_url}",
    "quality": "{quality}",
    "label": "{labels}"
  }
}
保存响应：api_response
```

### 动作 6：打开 URL
```
URL：https://example.feishu.cn/base/xxx
打开方式：浏览器
```

---

## 技术亮点

### 1. 响应式表单
- 根据选择的操作类型自动显示/隐藏相关配置项
- 避免用户看到不相关的配置选项

### 2. 用户友好的输入
- 常用正则表达式模板（一键应用）
- 选项列表支持多行文本输入（每行一个选项）
- 占位符提示和说明文本

### 3. 变量引用支持
- 所有文本输入框都支持 `{varName}` 格式的变量引用
- 提供"选择变量"按钮（待集成 VariableSelector）

### 4. 配置验证
- 保存时自动验证必填字段
- 显示详细的错误提示

---

## 下一步：阶段3

**阶段3：可视化流程图**（预计3小时）

将实现：
1. **改造 MacroEditor 动作列表 UI**
   - 显示配置摘要（使用 ActionConfigSummaryGenerator）
   - 显示输入/输出变量标签
   - 显示验证错误提示

2. **添加"编辑"按钮**
   - 点击编辑按钮打开 ActionConfigEditor
   - 保存后自动更新动作列表

3. **变量流向可视化**
   - 使用 Unicode 箭头显示变量流向
   - 高亮显示输入/输出变量

4. **删除确认**
   - 删除动作前检查影响
   - 提示会影响哪些后续动作

---

## 使用指南（供阶段3集成）

### 在 MacroEditor 中集成配置编辑器

```typescript
@Entry
@Component
struct MacroEditor {
  @State actions: Action[] = [];
  @State variables: Variable[] = [];
  @State editingAction: Action | null = null;
  @State availableVars: VariableOption[] = [];

  actionConfigDialogController: CustomDialogController | null = null;

  /**
   * 编辑动作配置
   */
  private handleEditAction(index: number) {
    this.editingAction = { ...this.actions[index] };

    // 准备可用变量列表
    this.prepareAvailableVariables(index);

    // 创建并打开配置编辑器
    this.actionConfigDialogController = new CustomDialogController({
      builder: ActionConfigEditor({
        action: $editingAction,
        availableVariables: $availableVars,
        isEditMode: true,
        onSave: (action: Action) => {
          this.actions[index] = action;
          this.actionConfigDialogController = null;
        },
        onCancel: () => {
          this.actionConfigDialogController = null;
        }
      }),
      autoCancel: false,
      customStyle: true
    });

    this.actionConfigDialogController.open();
  }

  /**
   * 准备可用变量列表
   */
  private prepareAvailableVariables(actionIndex: number) {
    this.availableVars = [];

    // 添加系统变量
    this.availableVars.push(...VariableSelectorHelper.getSystemVariables());

    // 添加宏变量
    this.availableVars.push(...VariableSelectorHelper.fromMacroVariables(this.variables));

    // 添加之前动作输出的变量
    for (let i = 0; i < actionIndex; i++) {
      const outputVar = ActionConfigSummaryGenerator.extractOutputVariable(this.actions[i]);
      if (outputVar) {
        this.availableVars.push({
          name: outputVar,
          displayName: `{${outputVar}}`,
          type: 'runtime',
          description: ActionConfigSummaryGenerator.generate(this.actions[i]),
          sourceActionIndex: i
        });
      }
    }
  }
}
```

---

**报告生成时间**: 2026-01-07
**阶段耗时**: 约4小时
**下一阶段**: 可视化流程图（3小时）

**准备就绪后请告知，我将开始阶段3的实现。**
