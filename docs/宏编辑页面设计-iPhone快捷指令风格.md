# 鸿蒙宏 - 宏编辑页面设计（参考 iPhone 快捷指令）

## 一、iPhone 快捷指令编辑器特点总结

### 1.1 核心设计特点

从 iPhone 快捷指令编辑器中学习到的关键设计：

1. **拖放式编辑器**
   - 从动作库拖拽动作到编辑区
   - 动作可以自由排序
   - 支持在动作之间插入新动作

2. **底部动作面板**
   - 动作库固定在底部
   - 可向上拖拽展开
   - 支持搜索和分类浏览
   - 比 Workflow 的侧滑导航更直观

3. **简洁的视觉设计**
   - 动作卡片：圆角、阴影、清晰的图标
   - 流程线：连接动作的视觉引导
   - 颜色编码：不同类型动作使用不同颜色

4. **智能变量系统**
   - Magic Variables（魔法变量）
   - 变量自动传递
   - 支持变量转换类型

## 二、鸿蒙宏编辑器设计

### 2.1 页面布局

```
┌────────────────────────────────────────────┐
│  ← 快小红宏           [完成] [▶️] │  <-- 顶部导航栏
├────────────────────────────────────────────┤
│                                    │
│  ┌──────────────────────────────┐      │
│  │  📋 读取剪贴板           │      │  <-- 动作 1
│  │  {剪贴板内容}             │      │
│  └──────────────────────────────┘      │
│              ↓                       │  <-- 流程线
│  ┌──────────────────────────────┐      │
│  │  ✂️ 正则提取 URL          │      │  <-- 动作 2
│  │  提取模式: (https?://).*  │      │
│  │  保存到变量: {url}         │      │
│  └──────────────────────────────┘      │
│              ↓                       │
│  ┌──────────────────────────────┐      │
│  │  💬 用户对话框              │      │  <-- 动作 3
│  │  标题: 选择分类            │      │
│  │  选项: 工作, 生活, 学习     │      │
│  │  保存到变量: {category}     │      │
│  └──────────────────────────────┘      │
│              ↓                       │
│  ┌──────────────────────────────┐      │
│  │  🌐 HTTP 请求             │      │  <-- 动作 4
│  │  URL: https://api.feishu.cn │      │
│  │  方法: POST                │      │
│  │  请求体: {              │      │
│  │    "url": "{url}",        │      │
│  │    "category": "{category}" │      │
│  │  }                        │      │
│  └──────────────────────────────┘      │
│                                    │
│                                    │
│         [+ 添加步骤]                 │  <-- 底部添加按钮
│                                    │
├────────────────────────────────────────────┤
│  🔍 搜索动作...   [动作库]       │  <-- 底部动作面板
└────────────────────────────────────────────┘
```

### 2.2 组件详解

#### 2.2.1 顶部导航栏

```
┌──────────────────────────────────────────┐
│  ← 快小红宏       [完成] [▶️]  │
└──────────────────────────────────────────┘
```

**视觉规范：**
```typescript
TopBar {
  高度：44px + 状态栏 48px
  背景：BG_PRIMARY + 毛玻璃效果

  左侧：
    - 返回按钮：<（20px），TEXT_PRIMARY

  中间：
    - 标题：H3_SIZE (17px), H3_WEIGHT (600), TEXT_PRIMARY
    - 可编辑：点击可修改宏名称

  右侧：
    - 完成按钮：PRIMARY_BLUE, BODY_SIZE (15px), Semibold
    - 运行按钮：▶️ (20px), PRIMARY_BLUE, 圆形背景
      - 点击：立即执行宏
      - 状态：运行中显示加载动画
}
```

**交互行为：**
- 点击返回：弹出确认对话框（未保存时）
- 点击完成：保存并返回
- 点击运行：立即执行宏，显示执行日志

#### 2.2.2 动作列表区（主编辑区）

```
┌──────────────────────────────────────┐
│  📋 读取剪贴板           │
│  {剪贴板内容}             │
└──────────────────────────────────────┘
              ↓
┌──────────────────────────────────────┐
│  ✂️ 正则提取 URL          │
│  提取模式: (https?://).*  │
│  保存到变量: {url}         │
└──────────────────────────────────────┘
```

**视觉规范：**
```typescript
ActionList {
  背景：BG_SECONDARY
  内边距：PAGE_PADDING_H (16px)
  间距：CARD_SPACING (16px)

  动作卡片：
    - 背景：BG_PRIMARY
    - 圆角：12px
    - 阴影：0 2px 8px SHADOW_LIGHT
    - 内边距：CARD_PADDING (16px)
    - 最小高度：80px

  流程线：
    - 类型：箭头 ↓ 或虚线
    - 颜色：BG_TERTIARY
    - 高度：12px（卡片间距）
    - 居中对齐

  拖拽状态：
    - 拖拽中的卡片：scale 1.02, 阴影加深
    - 目标位置：显示插入指示线
    - 邻接卡片：自动让位（200ms 过渡）

  变量高亮：
    - 格式：{变量名}
    - 颜色：PRIMARY_BLUE
    - 背景：PRIMARY_BLUE 10%
    - 圆角：4px
    - 内边距：2px 6px
}
```

**交互行为：**
- 长按动作：进入拖拽模式
- 拖拽动作：在动作之间重新排序
- 点击动作：展开配置面板
- 左滑动作：显示删除按钮
- 点击变量：弹出变量选择器

#### 2.2.3 底部添加按钮

```
┌──────────────────────────────────────────┐
│         [+ 添加步骤]                 │
└──────────────────────────────────────────┘
```

**视觉规范：**
```typescript
AddButton {
  位置：动作列表底部
  高度：56px
  背景：BG_PRIMARY
  边框：顶部 1px PRIMARY_BORDER

  内容：
    - 图标：+ (20px), PRIMARY_BLUE
    - 文字："添加步骤", BODY_SIZE (15px), PRIMARY_BLUE
    - 间距：8px

  点击效果：
    - 背景：PRIMARY_BLUE 10%
    - 缩放：0.98（100ms）
}
```

#### 2.2.4 底部动作面板

```
┌──────────────────────────────────────────┐
│  🔍 搜索动作...   [动作库]       │
│                                    │
│  ┌────┬────┬────┬────┐        │
│  │应用 │网络 │通知│系统 │       │  <-- 分类标签
│  └────┴────┴────┴────┘        │
│                                    │
│  ┌────────────────────┐  ┌────────┐ │
│  │ 📋 读取剪贴板    │  │ ⏰ 定时 │ │  <-- 动作网格
│  └────────────────────┘  └────────┘ │
│  ┌────────────────────┐  ┌────────┐ │
│  │ ✂️ 正则提取      │  │ 🔔 发送通知│ │
│  └────────────────────┘  └────────┘ │
│                                    │
│  [上滑以展开更多动作]              │
└──────────────────────────────────────────┘
```

**视觉规范：**
```typescript
ActionPanel {
  位置：底部固定
  高度：50%（默认）→ 70%（展开）
  背景：BG_PRIMARY + 毛玻璃效果
  阴影：0 -4px 20px SHADOW_DARK
  边框：顶部 1px BG_TERTIARY
  圆角：顶部 16px

  搜索栏：
    - 高度：36px
    - 背景：BG_TERTIARY
    - 圆角：10px
    - 占位符："搜索动作...", TEXT_TERTIARY, CAPTION_SIZE
    - 图标：🔍 (16px), TEXT_TERTIARY
    - 内边距：左右 12px

  分类标签：
    - 布局：横向滚动
    - 高度：40px
    - 标签：
      - 背景：BG_TERTIARY
      - 圆角：8px
      - 内边距：8px 16px
      - 字体：BODY_SIZE (15px), TEXT_PRIMARY
      - 选中：PRIMARY_BLUE 背景, 白色文字

  动作网格：
    - 列数：2 列（手机）/ 3 列（平板）
    - 间距：12px
    - 卡片：
      - 高度：80px
      - 背景：BG_SECONDARY
      - 圆角：10px
      - 内边距：12px
      - 图标：32px, PRIMARY_BLUE
      - 标题：CAPTION_SIZE (13px), TEXT_PRIMARY, 最大 2 行
      - 点击：背景 PRIMARY_BLUE 10%

  展开按钮：
    - 高度：48px
    - 背景：BG_PRIMARY
    - 文字："上滑以展开更多动作", CAPTION_SIZE, TEXT_TERTIARY
    - 图标：⬆️ (16px)
}
```

**交互行为：**
- 点击面板：上滑展开（50% → 70%）
- 点击动作：拖拽到编辑区
- 点击分类：筛选动作
- 搜索动作：实时过滤
- 下滑面板：收起（70% → 50%）

#### 2.2.5 动作配置面板（弹出）

```
┌──────────────────────────────────────────┐
│  HTTP 请求          [取消] [确定]  │  <-- 配置标题 + 按钮
├──────────────────────────────────────────┤
│                                    │
│  URL                              │  <-- 输入字段
│  ┌──────────────────────────────┐     │
│  │ https://api.feishu.cn    │     │
│  └──────────────────────────────┘     │
│                                    │
│  请求方法                          │  <-- 选择字段
│  ┌──────────────────────────────┐     │
│  │  [POST ▼]               │     │
│  └──────────────────────────────┘     │
│                                    │
│  请求头（可选）                    │
│  ┌──────────────────────────────┐     │
│  │ Content-Type: application/json│     │
│  └──────────────────────────────┘     │
│                                    │
│  [+ 添加请求头]                     │  <-- 添加按钮
│                                    │
│  请求体                            │
│  ┌──────────────────────────────┐     │
│  │ {                          │     │
│  │   "url": "{url}",         │     │
│  │   "category": "{category}"  │     │
│  │ }                          │     │
│  └──────────────────────────────┘     │
│                                    │
│  保存输出到变量                   │  <-- 变量保存
│  ┌──────────────────────────────┐     │
│  │ [response ▼]            │     │
│  └──────────────────────────────┘     │
└──────────────────────────────────────────┘
```

**视觉规范：**
```typescript
ActionConfigPanel {
  位置：底部弹出（从屏幕底部）
  高度：屏幕 80%
  背景：BG_PRIMARY
  圆角：顶部 16px
  阴影：0 -4px 24px SHADOW_DARK

  标题栏：
    - 高度：56px
    - 边框：底部 1px BG_TERTIARY
    - 标题：H3_SIZE (17px), H3_WEIGHT (600)
    - 按钮："取消"(TEXT_SECONDARY), "确定"(PRIMARY_BLUE)

  表单区域：
    - 背景：BG_PRIMARY
    - 滚动：支持滚动
    - 内边距：16px

  字段组：
    - 标题：CAPTION_SIZE (13px), TEXT_SECONDARY
    - 间距：4px

  输入框：
    - 高度：44px
    - 背景：BG_SECONDARY
    - 圆角：8px
    - 边框：1px BG_TERTIARY
    - 内边距：12px
    - 字体：BODY_SIZE (15px), TEXT_PRIMARY
    - 占位符：TEXT_TERTIARY
    - 焦点：边框 PRIMARY_BLUE

  选择框：
    - 高度：44px
    - 背景：BG_SECONDARY
    - 圆角：8px
    - 下拉箭头：▼ (16px), TEXT_TERTIARY

  变量引用：
    - 格式：{变量名}
    - 高亮：PRIMARY_BLUE, 背景 PRIMARY_BLUE 10%
    - 点击：弹出变量选择器

  多行输入（JSON 编辑器）：
    - 高度：120px
    - 背景：BG_SECONDARY
    - 圆角：8px
    - 字体：等宽（便于编辑 JSON）
    - 行高：1.5
}
```

**交互行为：**
- 点击动作：弹出配置面板
- 点击外部区域：关闭面板
- 下滑面板：关闭面板
- 点击变量：弹出变量选择器
- 长按变量：显示变量详情
- 拖拽变量：复制到其他字段

## 三、动作分类（参考快捷指令）

### 3.1 分类结构

```typescript
ACTION_CATEGORIES = {
  'app': {
    icon: 'app.fill',
    name: '应用',
    actions: ['launch_app', 'open_url', 'open_file']
  },
  'network': {
    icon: 'wifi.fill',
    name: '网络',
    actions: ['http_request', 'web_scrape', 'api_call']
  },
  'notification': {
    icon: 'bell.fill',
    name: '通知',
    actions: ['send_notification', 'show_dialog', 'toast']
  },
  'clipboard': {
    icon: 'doc.on.clipboard.fill',
    name: '剪贴板',
    actions: ['read_clipboard', 'set_clipboard', 'clipboard_history']
  },
  'text': {
    icon: 'text.alignleft.fill',
    name: '文本',
    actions: ['regex_extract', 'text_replace', 'text_format', 'split_text']
  },
  'system': {
    icon: 'gearshape.fill',
    name: '系统',
    actions: ['get_time', 'get_location', 'battery_status', 'wifi_ssid']
  },
  'scripting': {
    icon: 'chevron.left.forwardslash.chevron.right',
    name: '脚本',
    actions: ['if_condition', 'repeat_loop', 'set_variable', 'get_variable']
  },
  'media': {
    icon: 'photo.fill',
    name: '媒体',
    actions: ['take_photo', 'save_image', 'crop_image', 'resize_image']
  }
}
```

### 3.2 动作列表示例

#### 网络动作
```
🌐 HTTP 请求
  发送网络请求并获取响应

📄 网页抓取
  从网页提取内容

🔗 URL 方案
  打开应用或网页
```

#### 文本处理动作
```
✂️ 正则提取
  使用正则表达式提取文本

🔄 文本替换
  查找并替换文本

📝 文本格式
  格式化文本（大小写、日期等）

✂️ 分割文本
  按分隔符分割文本
```

#### 通知动作
```
🔔 发送通知
  显示系统通知

💬 用户对话框
  显示选择对话框

💭 输入对话框
  显示文本输入对话框

📢 播放提示
  播放提示音和震动
```

#### 系统动作
```
⏰ 获取当前时间
  获取当前时间戳

📍 获取位置
  获取当前位置

🔋 获取 Wi-Fi SSID
  获取当前 Wi-Fi 名称

🔋 获取网络状态
  检测网络连接状态
```

#### 脚本动作
```
❓ 条件判断
  如果...则...否则...

🔄 重复循环
  重复执行动作列表

💾 设置变量
  设置变量值

📖 获取变量
   获取变量值
```

## 四、变量系统设计

### 4.1 变量类型

```typescript
VARIABLE_TYPES = {
  'text': {
    name: '文本',
    icon: 'text.alignleft',
    color: '#007DFF'
  },
  'number': {
    name: '数字',
    icon: 'number',
    color: '#34C759'
  },
  'boolean': {
    name: '布尔值',
    icon: 'checkmark.circle.fill',
    color: '#AF52DE'
  },
  'list': {
    name: '列表',
    icon: 'list.bullet',
    color: '#FF9500'
  },
  'dictionary': {
    name: '字典',
    icon: 'doc.plaintext',
    color: '#5AC8FA'
  },
  'image': {
    name: '图片',
    icon: 'photo',
    color: '#FF3B30'
  }
}
```

### 4.2 变量引用格式

```
{variable_name}           // 普通变量引用
{system:current_time}    // 系统变量
{input:text}           // 输入变量
{output:http_response}  // 输出变量
```

### 4.3 变量选择器

```
┌──────────────────────────────────────────┐
│  选择变量          [取消] [确定]  │
├──────────────────────────────────────────┤
│  🔍 搜索变量...                  │  <-- 搜索栏
│                                    │
│  ┌────────────────────────────┐       │
│  │ 文本变量                    │  <-- 分类
│  ├────────────────────────────┤       │
│  │ • {url}                      │
│  │   类型: 文本                 │
│  │   来源: 正则提取            │
│  ├────────────────────────────┤       │
│  │ • {category}                  │
│  │   类型: 文本                 │
│  │   来源: 用户对话框          │
│  └────────────────────────────┘       │
│                                    │
│  ┌────────────────────────────┐       │
│  │ 系统变量                    │
│  ├────────────────────────────┤       │
│  │ • {system:current_time}        │
│  │ • {system:wifi_ssid}          │
│  │ • {system:battery_level}        │
│  └────────────────────────────┘       │
│                                    │
│  [新建变量]                       │
└──────────────────────────────────────────┘
```

## 五、触发器设计

### 5.1 触发器类型

```typescript
TRIGGER_TYPES = {
  'manual': {
    icon: 'hand.tap.fill',
    name: '手动触发',
    description: '手动运行宏'
  },
  'timing': {
    icon: 'clock.fill',
    name: '定时触发',
    description: '在指定时间运行'
  },
  'network': {
    icon: 'wifi.fill',
    name: '网络触发',
    description: '连接到特定网络时运行'
  },
  'notification': {
    icon: 'bell.fill',
    name: '通知触发',
    description: '接收到特定通知时运行'
  },
  'location': {
    icon: 'location.fill',
    name: '位置触发',
    description: '到达或离开特定位置时运行'
  },
  'bluetooth': {
    icon: 'antenna.radiowaves.left.and.right',
    name: '蓝牙触发',
    description: '连接到特定蓝牙设备时运行'
  }
}
```

### 5.2 触发器配置面板

```
┌──────────────────────────────────────────┐
│  定时触发器          [取消] [确定]  │
├──────────────────────────────────────────┤
│                                    │
│  触发时间                        │
│  ┌──────────────────────────────┐     │
│  │ 08:30                      │     │
│  └──────────────────────────────┘     │
│                                    │
│  重复周期                          │
│  ┌──────────────────────────────┐     │
│  │  [每天 ▼]                │     │
│  └──────────────────────────────┘     │
│                                    │
│  启用                              │
│  ┌──────────────────────────────┐     │
│  │  [☑] 周一到周五           │     │
│  │  [☑] 周末                 │     │
│  └──────────────────────────────┘     │
│                                    │
│  提前提醒                          │
│  ┌──────────────────────────────┐     │
│  │ [开启 ⏲]                 │     │
│  └──────────────────────────────┘     │
│  ┌──────────────────────────────┐     │
│  │  5 分钟                    │     │
│  └──────────────────────────────┘     │
└──────────────────────────────────────────┘
```

## 六、快捷键和手势

### 6.1 快捷键

```typescript
SHORTCUTS = {
  'save': 'Ctrl/Cmd + S',          // 保存
  'run': 'Ctrl/Cmd + R',          // 运行
  'undo': 'Ctrl/Cmd + Z',         // 撤销
  'redo': 'Ctrl/Cmd + Shift + Z',  // 重做
  'delete_action': 'Delete',       // 删除选中动作
  'copy_action': 'Ctrl/Cmd + C',  // 复制动作
  'paste_action': 'Ctrl/Cmd + V',  // 粘贴动作
  'search_action': 'Ctrl/Cmd + F',  // 搜索动作
  'close_panel': 'Escape',           // 关闭面板
}
```

### 6.2 手势操作

```typescript
GESTURES = {
  'drag_to_reorder': '长按动作 -> 拖拽排序',      // 拖拽排序
  'swipe_to_delete': '左滑动作 -> 显示删除',      // 滑动删除
  'tap_to_configure': '点击动作 -> 配置面板',       // 点击配置
  'long_press_menu': '长按动作 -> 上下文菜单',   // 长按菜单
  'pinch_to_zoom': '双指捏合 -> 缩放编辑器',      // 缩放编辑器
  'swipe_panel': '上滑面板 -> 展开/收起',       // 滑动面板
  'pull_to_refresh': '下拉 -> 刷新动作库',        // 下拉刷新
}
```

## 七、动画规范

### 7.1 动作拖拽动画

```typescript
DragAnimation {
  拖拽开始：
    - 选中卡片：scale 1.02, 阴影加深
    - 其他卡片：opacity 0.5

  拖拽中：
    - 目标位置：显示插入指示线
    - 指示线：PRIMARY_BLUE, 高度 2px
    - 响应时间：实时

  拖拽结束：
    - 动画：Spring（弹性）
    - 持续时间：300ms
    - 缓动函数：cubic-bezier(0.175, 0.885, 0.32, 1.275)
}
```

### 7.2 面板弹出动画

```typescript
PanelAnimation {
  打开：
    - 位移：Y 100% → 0%
    - 遮罩：opacity 0 → 0.5（同步）
    - 背景：BG_PRIMARY
    - 持续时间：250ms
    - 缓动函数：ease-out

  关闭：
    - 位移：Y 0% → 100%
    - 遮罩：opacity 0.5 → 0（同步）
    - 持续时间：200ms
    - 缓动函数：ease-in
}
```

### 7.3 动作添加动画

```typescript
AddActionAnimation {
  步骤 1 - 拖拽中：
    - 动作卡片：跟随手指
    - 目标位置：显示插入指示线

  步骤 2 - 放开时：
    - 动作插入：动画到正确位置
    - 持续时间：300ms, spring

  步骤 3 - 流程线更新：
    - 流程线：自动连接
    - 箭头：重新渲染
    - 过渡：200ms, ease-out
}
```

## 八、性能优化

### 8.1 虚拟滚动

```typescript
VirtualScroll {
  场景：动作数量 > 50 时启用
  缓冲区：上下各 10 个动作
  渲染优化：
    - 仅渲染可见区域内的动作
    - 使用 GPU 加速动画
    - 避免重复渲染

  滚动性能：
    - 目标：60fps
    - 预加载：提前 3-5 个动作
}
```

### 8.2 懒加载

```typescript
LazyLoad {
  动作图标：
    - 仅在滚动到可见区域时加载
    - 使用占位符：灰色方块
    - 优先级：当前可见 > 即将可见

  动作配置：
    - 按需加载
    - 预加载常用动作
}
```

## 九、错误处理

### 9.1 验证提示

```
┌──────────────────────────────────────────┐
│            ⚠️                     │
│                                    │
│       URL 格式不正确                │
│                                    │
│  请输入有效的 HTTP 或 HTTPS URL     │
│                                    │
│         [确定]                    │
└──────────────────────────────────────────┘
```

**视觉规范：**
```typescript
ValidationErrorDialog {
  背景：BG_PRIMARY
  圆角：12px
  阴影：0 4px 16px SHADOW_MEDIUM

  图标：⚠️ (48px), WARNING
  标题：H3_SIZE (17px), TEXT_PRIMARY, 最大 2 行
  描述：CAPTION_SIZE (13px), TEXT_SECONDARY

  按钮：
    - 高度：44px
    - 背景：PRIMARY_BLUE
    - 文字："确定", 白色
    - 圆角：8px
}
```

### 9.2 执行错误展示

```
┌──────────────────────────────────────────┐
│  执行失败 - 动作 3/4           │
├──────────────────────────────────────────┤
│  ❌ HTTP 请求失败               │
│                                    │
│  错误: 网络连接超时             │
│  状态码: 504                   │
│                                    │
│  ┌──────────────────────────────┐     │
│  │ [查看日志]                 │     │
│  └──────────────────────────────┘     │
│                                    │
│  [重试]              [忽略]       │
└──────────────────────────────────────────┘
```

## 十、开发检查清单

### 页面组件
- [ ] 顶部导航栏实现
- [ ] 动作列表区实现
- [ ] 底部添加按钮实现
- [ ] 底部动作面板实现
- [ ] 动作配置面板实现
- [ ] 变量选择器实现
- [ ] 触发器配置面板实现

### 功能实现
- [ ] 拖拽排序功能完成
- [ ] 动作搜索功能完成
- [ ] 动作分类筛选完成
- [ ] 变量引用解析完成
- [ ] 变量高亮显示完成
- [ ] 执行功能完成
- [ ] 保存功能完成
- [ ] 撤销/重做功能完成

### 动作实现（优先级）
- [ ] 读取剪贴板
- [ ] 设置剪贴板
- [ ] 正则提取
- [ ] 文本替换
- [ ] HTTP 请求
- [ ] 发送通知
- [ ] 用户对话框
- [ ] 输入对话框
- [ ] 获取当前时间
- [ ] 获取网络状态
- [ ] 条件判断
- [ ] 重复循环
- [ ] 设置变量
- [ ] 获取变量

### 交互优化
- [ ] 拖拽动画优化
- [ ] 面板弹出动画
- [ ] 长按震动反馈
- [ ] 点击声音反馈
- [ ] 快捷键支持
- [ ] 手势操作优化

### 性能优化
- [ ] 虚拟滚动实现
- [ ] 图标懒加载
- [ ] 动画 GPU 加速
- [ ] 内存泄漏检查
- [ ] 渲染性能优化

### 测试
- [ ] 单元测试（组件逻辑）
- [ ] 集成测试（拖拽、保存、执行）
- [ ] 性能测试（> 100 个动作）
- [ ] 兼容性测试（不同屏幕尺寸）

---

**文档版本**：v1.0
**创建日期**：2025-01-11
**设计师**：OpenCode AI
**适用平台**：HarmonyOS NEXT API 12+
**参考**：iPhone Shortcuts App 编辑器
