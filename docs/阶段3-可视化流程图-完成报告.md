# 可视化变量流图 - 阶段3完成报告

## 完成时间
2026-01-07

## 实现内容

### 1. 改造 MacroEditor 的动作列表 UI

**文件路径**: `entry/src/main/ets/pages/MacroEditor.ets`

**核心变更**:

1. **引入必要的依赖** (第1-9行)
   ```typescript
   import { ActionViewModel, ActionViewModelFactory } from '../models/ActionViewModel';
   import { VariableFlowAnalyzer } from '../utils/VariableFlowAnalyzer';
   import { ActionConfigSummaryGenerator } from '../utils/ActionConfigSummaryGenerator';
   ```

2. **添加视图模型状态** (第24-25行)
   ```typescript
   @State actionViewModels: ActionViewModel[] = []; // 动作视图模型
   @State highlightedVariable: string = ''; // 当前高亮的变量名
   ```

3. **实现视图模型更新方法** (第180-212行)
   ```typescript
   private updateActionViewModels() {
     this.actionViewModels = this.actions.map((action, index) => {
       // 获取之前已定义的变量
       const definedVars = VariableFlowAnalyzer.getDefinedVariablesBeforeAction(
         this.actions, index, this.variables
       );

       // 验证动作配置
       const { isValid, errors } = VariableFlowAnalyzer.validateAction(
         action, index, definedVars
       );

       // 提取输入/输出变量和生成摘要
       const inputVars = ActionConfigSummaryGenerator.extractInputVariables(action);
       const outputVar = ActionConfigSummaryGenerator.extractOutputVariable(action);
       const summary = ActionConfigSummaryGenerator.generate(action);

       return ActionViewModelFactory.create(
         action, inputVars, outputVar, summary, isValid, errors
       );
     });
   }
   ```

4. **在所有动作操作后自动更新视图模型**
   - `loadMacro()` - 加载宏后更新 (第64行)
   - `addNotificationAction()` - 添加动作后更新 (第412行)
   - `addClipboardReadAction()` - 添加动作后更新 (第431行)
   - `addHttpRequestAction()` - 添加动作后更新 (第455行)
   - `addOpenUrlAction()` - 添加动作后更新 (第474行)
   - `addTextProcessAction()` - 添加动作后更新 (第496行)
   - `deleteAction()` - 删除动作后更新 (第526、535行)
   - `moveActionUp()` - 上移动作后更新 (第551行)
   - `moveActionDown()` - 下移动作后更新 (第567行)

---

### 2. 添加动作卡片样式（输入/输出变量标签）

**UI 结构** (第920-1146行)

#### 动作卡片布局

```
┌─────────────────────────────────────────────┐
│ [序号] 动作类型         [编辑]              │
│ 配置摘要（最多2行）                         │
│                                             │
│ 使用变量: {var1} {var2}                     │  ← 输入变量标签（绿色）
│ 输出 → [output_var]                         │  ← 输出变量标签（蓝色）
│                                             │
│ ⚠️ 验证错误信息（如果有）                    │  ← 错误提示（红色）
│                                             │
│ [↑] [↓]                     [删除]          │  ← 操作按钮
└─────────────────────────────────────────────┘
```

#### 关键特性

1. **序号圆圈** (第939-947行)
   - 有效动作：蓝色背景 (`#007DFF`)
   - 无效动作：红色背景 (`#ff4d4f`)
   - 白色文字，圆形样式

2. **配置摘要** (第954-960行)
   - 自动生成的动作配置描述
   - 最多显示2行，超出部分省略
   - 灰色字体 (`#666666`)

3. **输入变量标签** (第995-1022行)
   - 绿色主题 (`#52c41a` / `#f6ffed`)
   - 显示格式：`{varName}`
   - 支持多个变量，自动换行
   - 支持点击高亮

4. **输出变量标签** (第1024-1047行)
   - 蓝色主题 (`#1890ff` / `#e6f7ff`)
   - 显示格式：`[varName]`
   - 粗体字体
   - 支持点击高亮

5. **验证错误提示** (第1049-1065行)
   - 红色背景 (`#fff1f0`)
   - 红色边框 (`#ffa39e`)
   - 显示所有验证错误信息
   - 带 ⚠️ 图标

6. **卡片边框** (第1118-1121行)
   - 有效动作：1px 灰色边框 (`#e8e8e8`)
   - 无效动作：2px 红色边框 (`#ff4d4f`)

---

### 3. 实现变量流向连线（使用 Unicode 箭头）

**连线逻辑** (第1123-1173行)

#### 三种连线类型

1. **变量传递连线** (第1128-1154行)
   - 当前动作有输出变量 **且** 下一个动作使用了该变量
   - 显示：蓝色箭头 `↓` + 变量标签
   - 变量标签居中显示，浮动在箭头上方
   - 支持点击高亮

   ```
   动作 1: 输出 → [clipboard_content]
            ↓
      {clipboard_content}  ← 变量标签（可点击）
            ↓
   动作 2: 使用变量: {clipboard_content}
   ```

2. **普通连线（有输出但未被使用）** (第1155-1163行)
   - 当前动作有输出变量，但下一个动作没有使用
   - 显示：灰色箭头 `↓`
   - 字体较小

3. **普通连线（无输出）** (第1164-1172行)
   - 当前动作没有输出变量
   - 显示：灰色箭头 `↓`
   - 字体较小

#### 实现细节

```typescript
// 变量流向连线
if (index < this.actionViewModels.length - 1) {
  if (viewModel.outputVariable) {
    const nextViewModel = this.actionViewModels[index + 1];
    if (nextViewModel.inputVariables.includes(viewModel.outputVariable)) {
      // 显示变量传递连线（带变量标签）
      Row() {
        Text('↓')
          .fontSize(20)
          .fontColor(this.highlightedVariable === viewModel.outputVariable ? '#52c41a' : '#1890ff')

        Text(`{${viewModel.outputVariable}}`)
          .fontSize(11)
          .fontColor(this.highlightedVariable === viewModel.outputVariable ? '#ffffff' : '#1890ff')
          .backgroundColor(this.highlightedVariable === viewModel.outputVariable ? '#52c41a' : '#e6f7ff')
          .position({ x: '50%', y: 10 })
          .translate({ x: '-50%', y: 0 })
          .onClick(() => this.handleVariableClick(viewModel.outputVariable!))
      }
    } else {
      // 显示普通连线
      Text('↓').fontSize(16).fontColor('#d9d9d9')
    }
  } else {
    // 无输出变量，显示普通连线
    Text('↓').fontSize(16).fontColor('#d9d9d9')
  }
}
```

---

### 4. 添加变量追踪高亮功能

**实现要点** (第214-225行 + 变量标签样式)

#### 状态管理

```typescript
@State highlightedVariable: string = ''; // 当前高亮的变量名
```

#### 点击处理方法

```typescript
private handleVariableClick(varName: string) {
  if (this.highlightedVariable === varName) {
    // 如果点击的是已高亮的变量，取消高亮
    this.highlightedVariable = '';
  } else {
    // 否则高亮该变量
    this.highlightedVariable = varName;
  }
}
```

#### 高亮样式（3个位置）

1. **输入变量标签** (第1003-1017行)
   - 未高亮：绿色文字 + 浅绿背景 (`#52c41a` / `#f6ffed`)
   - 高亮时：白色文字 + 深绿背景 (`#ffffff` / `#52c41a`)
   - 边框加粗：1px → 2px

2. **输出变量标签** (第1031-1044行)
   - 未高亮：蓝色文字 + 浅蓝背景 (`#1890ff` / `#e6f7ff`)
   - 高亮时：白色文字 + 深蓝背景 (`#ffffff` / `#1890ff`)
   - 边框加粗：1px → 2px

3. **连线上的变量标签** (第1136-1150行)
   - 未高亮：蓝色箭头 + 蓝色标签
   - 高亮时：绿色箭头 + 绿色标签（与输入变量一致）

#### 使用场景

用户点击任何变量标签（输入、输出或连线上的），所有相关位置都会高亮：

```
示例：点击 {clipboard_content}

动作 1: 读取剪贴板
        输出 → [clipboard_content]  ← 蓝色标签

              ↓ {clipboard_content}  ← 绿色高亮（因为被点击）

动作 2: 文本处理
        使用变量: {clipboard_content}  ← 绿色高亮

              ↓

动作 3: HTTP 请求
        使用变量: {clipboard_content}  ← 绿色高亮
```

---

## 增强的删除保护

**改进的删除动作逻辑** (第503-537行)

```typescript
private deleteAction(index: number) {
  // 检查是否会影响其他动作
  const affectedIndices = VariableFlowAnalyzer.getAffectedActionsByDeletion(
    this.actions,
    index
  );

  if (affectedIndices.length > 0) {
    const affectedActions = affectedIndices.map(i => `动作 ${i + 1}`).join('、');
    promptAction.showDialog({
      title: '警告',
      message: `删除此动作会影响 ${affectedActions}，是否继续？`,
      buttons: [
        { text: '取消', color: '#000000' },
        { text: '删除', color: '#ff4d4f' }
      ]
    }).then((result) => {
      if (result.index === 1) {
        // 用户确认后删除
        this.actions.splice(index, 1);
        this.actions.forEach((action, idx) => {
          action.orderIndex = idx;
        });
        this.updateActionViewModels();
      }
    });
  } else {
    // 无影响，直接删除
    this.actions.splice(index, 1);
    this.actions.forEach((action, idx) => {
      action.orderIndex = idx;
    });
    this.updateActionViewModels();
  }
}
```

**保护机制**:
- 删除前自动检查是否有其他动作依赖此动作的输出变量
- 如果有依赖，弹窗警告并列出受影响的动作
- 用户确认后才执行删除操作

---

## 完整的可视化效果示例

### 快小红流程可视化

```
┌─────────────────────────────────────────────┐
│ [1] 读取剪贴板                       [编辑] │
│ 将剪贴板内容保存到变量                      │
│ 输出 → [clipboard_content]                  │
│ [↑] [↓]                     [删除]          │
└─────────────────────────────────────────────┘
              ↓ {clipboard_content}
┌─────────────────────────────────────────────┐
│ [2] 文本处理 - 正则提取              [编辑] │
│ 正则提取                                    │
│ 输入: {clipboard_content}                   │
│ 正则: https?://[^\s]+                      │
│                                             │
│ 使用变量: {clipboard_content}               │
│ 输出 → [extracted_url]                      │
│ [↑] [↓]                     [删除]          │
└─────────────────────────────────────────────┘
              ↓ {extracted_url}
┌─────────────────────────────────────────────┐
│ [3] 用户对话框 - 单选                [编辑] │
│ 单选对话框: 选择爆款标记                    │
│ 输出 → [quality]                            │
│ [↑] [↓]                     [删除]          │
└─────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────┐
│ [4] 用户对话框 - 多选                [编辑] │
│ 多选对话框: 选择分类标签                    │
│ 输出 → [labels]                             │
│ [↑] [↓]                     [删除]          │
└─────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────┐
│ [5] HTTP POST 请求                   [编辑] │
│ POST https://api.coze.cn/v1/workflow/run    │
│                                             │
│ 使用变量: {extracted_url} {quality} {labels}│
│ 输出 → [api_response]                       │
│ [↑] [↓]                     [删除]          │
└─────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────┐
│ [6] 打开 URL                         [编辑] │
│ https://example.feishu.cn/base/xxx          │
│ [↑] [↓]                     [删除]          │
└─────────────────────────────────────────────┘
```

### 验证错误示例

```
┌─────────────────────────────────────────────┐
│ [2] 文本处理 - 正则提取              [编辑] │  ← 红色边框
│ 正则提取                                    │
│ 输入: {unknown_var}                         │
│                                             │
│ 使用变量: {unknown_var}                     │
│ 输出 → [extracted_url]                      │
│                                             │
│ ┌─────────────────────────────────────────┐ │
│ │ ⚠️ 变量 {unknown_var} 未定义             │ │  ← 错误提示
│ │ ⚠️ 输入来源不能为空                      │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ [↑] [↓]                     [删除]          │
└─────────────────────────────────────────────┘
```

---

## 技术亮点

### 1. 响应式设计
- 使用 `@State` 装饰器实现自动 UI 更新
- 任何动作操作后自动重新计算视图模型
- 变量高亮状态实时同步到所有相关标签

### 2. 性能优化
- 视图模型按需计算，缓存结果
- 只在必要时（添加/删除/移动动作）更新
- 使用 ForEach 优化列表渲染

### 3. 用户体验
- 实时验证，即时反馈
- 删除保护，防止误操作
- 变量追踪，清晰流向
- 视觉引导，易于理解

### 4. 代码可维护性
- 分离关注点：视图模型 vs 数据模型
- 工具类封装：分析、生成、验证逻辑独立
- 命名清晰：方法名、变量名符合语义

---

## 与设计方案的对比

| 设计方案 | 实现情况 | 备注 |
|---------|---------|------|
| 动作卡片样式 | ✅ 完全实现 | 超出预期，增加了圆形序号 |
| 输入/输出变量标签 | ✅ 完全实现 | 使用颜色区分（绿色/蓝色） |
| 变量流向连线 | ✅ 使用 Unicode 箭头 | 简洁高效，比 Canvas 更轻量 |
| 变量追踪高亮 | ✅ 完全实现 | 点击变量高亮所有相关位置 |
| 删除动作影响提示 | ✅ 完全实现 | 集成到 deleteAction() |

**额外实现的功能**:
- 动作验证状态视觉反馈（红色边框）
- 配置摘要自动生成并显示
- 变量标签可点击交互
- 连线上的变量标签也支持高亮

---

## 已知限制和改进方向

### 当前限制
1. **连线样式**: 使用 Unicode 箭头而非 Canvas 绘制
   - 优点：简单、性能好、易维护
   - 缺点：无法绘制复杂的曲线连接

2. **编辑功能**: "编辑" 按钮点击后显示 Toast（待实现）
   - 需要集成 ActionConfigEditor 组件
   - 参考阶段2的实现

### 后续改进方向（阶段4）
1. 添加动作时自动推荐变量名
2. 拖拽调整动作顺序时自动重新验证
3. 删除动作时提示影响的下游动作（✅ 已实现）
4. 添加"快速创建快小红流程"模板

---

## 文件清单

### 修改的文件
- `entry/src/main/ets/pages/MacroEditor.ets` (主要改动)
  - 添加导入：ActionViewModel、VariableFlowAnalyzer、ActionConfigSummaryGenerator
  - 添加状态：actionViewModels、highlightedVariable
  - 添加方法：updateActionViewModels()、handleVariableClick()
  - 改造 UI：动作列表区域（第920-1177行）
  - 增强方法：deleteAction()、所有添加动作方法

### 依赖的文件（阶段1已创建）
- `entry/src/main/ets/models/ActionViewModel.ts`
- `entry/src/main/ets/utils/VariableFlowAnalyzer.ts`
- `entry/src/main/ets/utils/ActionConfigSummaryGenerator.ts`
- `entry/src/main/ets/components/VariableSelector.ets`

---

**报告生成时间**: 2026-01-07
**阶段耗时**: 约1.5小时（提前完成！）
**下一阶段**: 阶段4 - 交互优化（2小时）
