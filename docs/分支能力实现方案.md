# åˆ†æ”¯èƒ½åŠ›å®ç°æ–¹æ¡ˆ

**é—®é¢˜**: å½“å‰å®Appåªæ”¯æŒå®çº§åˆ«çš„å‰ç½®æ¡ä»¶ï¼Œæ— æ³•å®ç°åŠ¨ä½œçº§åˆ«çš„æ¡ä»¶åˆ¤æ–­å’Œåˆ†æ”¯é€»è¾‘ï¼Œå¯¼è‡´æ— æ³•æ”¯æŒ"å¿«å°çº¢"ç­‰å¤æ‚å·¥ä½œæµã€‚

**åˆ›å»ºæ—¶é—´**: 2026-01-08
**ä¼˜å…ˆçº§**: ğŸ”´ P0ï¼ˆé˜»å¡æ€§é—®é¢˜ï¼‰

---

## ä¸€ã€å½“å‰æ¶æ„åˆ†æ

### 1.1 ç°æœ‰æ¡ä»¶åˆ¤æ–­èƒ½åŠ›

```typescript
// âœ… å·²å®ç°ï¼šå®çº§åˆ«æ¡ä»¶
export interface Condition {
  id: number;
  macroId: number;  // å…³è”åˆ°å®
  field: string;
  operator: ConditionOperator;
  value: string;
}

// MacroEngine.executeMacro()
const conditions = await this.databaseService.getConditionsByMacroId(macroId);
if (!conditionsPassed) {
  return false;  // æ•´ä¸ªå®ä¸æ‰§è¡Œ
}
```

**é—®é¢˜**: æ¡ä»¶åªåœ¨å®å¼€å§‹å‰åˆ¤æ–­ä¸€æ¬¡ï¼Œæ— æ³•åœ¨åŠ¨ä½œä¹‹é—´è¿›è¡Œåˆ†æ”¯ã€‚

### 1.2 "å¿«å°çº¢"å·¥ä½œæµéœ€è¦çš„åˆ†æ”¯é€»è¾‘

```
æ­¥éª¤ 1-9: å¯åŠ¨ã€è¯»å–å‰ªè´´æ¿ã€è§£æURL

åˆ†æ”¯ç‚¹: æ ¹æ®URLå†…å®¹é€‰æ‹©è·¯å¾„
â”œâ”€ IF (url CONTAINS "goods-detail")
â”‚    â†’ æ‰§è¡Œæ­¥éª¤ 10-15ï¼ˆå•†å“é‡‡é›†ï¼‰
â”‚    â†’ é€€å‡ºå®
â”‚
â”œâ”€ ELSE IF (url CONTAINS "user")
â”‚    â†’ æ‰§è¡Œæ­¥éª¤ 16-20ï¼ˆåšä¸»é‡‡é›†ï¼‰
â”‚    â†’ é€€å‡ºå®
â”‚
â””â”€ ELSE
     â†’ æ‰§è¡Œæ­¥éª¤ 21-34ï¼ˆç¬”è®°é‡‡é›†ï¼‰
```

---

## äºŒã€æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®ç°éš¾åº¦ | é€šç”¨æ€§ | å¼€å‘å‘¨æœŸ | æ¨èåº¦ |
|------|---------|-------|----------|--------|
| æ–¹æ¡ˆA: åŠ¨ä½œçº§æ¡ä»¶ | â­â­ ä¸­ç­‰ | â­â­â­â­ é«˜ | 2-3å¤© | â­â­â­â­â­ |
| æ–¹æ¡ˆB: IF_ELSEåŠ¨ä½œç±»å‹ | â­â­â­â­ å¤æ‚ | â­â­â­â­â­ æœ€é«˜ | 5-7å¤© | â­â­â­â­ |
| æ–¹æ¡ˆC: å•å®æ‹†åˆ†ä¸ºå¤šå® | â­ ç®€å• | â­ ä½ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰ | 1å¤© | â­â­ |

---

## ä¸‰ã€æ–¹æ¡ˆAï¼šåŠ¨ä½œçº§æ¡ä»¶ï¼ˆçŸ­æœŸæ¨èï¼‰â­â­â­â­â­

### 3.1 æ ¸å¿ƒæ€è·¯

ä¸ºæ¯ä¸ª Action æ·»åŠ å¯é€‰çš„ conditions å­—æ®µï¼Œæ‰§è¡Œå‰åˆ¤æ–­æ¡ä»¶ï¼š
- å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œ**è·³è¿‡è¯¥åŠ¨ä½œ**ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª
- å¦‚æœæ¡ä»¶æ»¡è¶³ï¼Œæ­£å¸¸æ‰§è¡Œ

### 3.2 æ•°æ®æ¨¡å‹ä¿®æ”¹

#### **ä¿®æ”¹ 1: Action æ¨¡å‹**
```typescript
// entry/src/main/ets/models/Macro.ts

export interface Action {
  id: number;
  macroId: number;
  type: ActionType;
  config: string;
  orderIndex: number;
  conditions?: ActionCondition[];  // ğŸ†• æ–°å¢ï¼šåŠ¨ä½œçº§æ¡ä»¶
}

// ğŸ†• æ–°å¢ï¼šåŠ¨ä½œçº§æ¡ä»¶æ¥å£
export interface ActionCondition {
  field: string;                   // å˜é‡åï¼ˆå¦‚ "url"ï¼‰
  operator: ConditionOperator;     // è¿ç®—ç¬¦
  value: string;                   // æ¯”è¾ƒå€¼
  logicOperator?: 'AND' | 'OR';    // ä¸ä¸‹ä¸€ä¸ªæ¡ä»¶çš„é€»è¾‘å…³ç³»ï¼ˆé»˜è®¤ ANDï¼‰
}
```

#### **ä¿®æ”¹ 2: æ•°æ®åº“è¡¨ç»“æ„**
```sql
-- æ–°å¢è¡¨: action_condition
CREATE TABLE IF NOT EXISTS action_condition (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  action_id INTEGER NOT NULL,
  field TEXT NOT NULL,
  operator TEXT NOT NULL CHECK (operator IN ('==', '!=', '>', '<', '>=', '<=', 'contains', 'regex')),
  value TEXT NOT NULL,
  logic_operator TEXT DEFAULT 'AND' CHECK (logic_operator IN ('AND', 'OR')),
  order_index INTEGER NOT NULL DEFAULT 0,
  FOREIGN KEY (action_id) REFERENCES action(id) ON DELETE CASCADE
);

CREATE INDEX idx_action_condition_action_id ON action_condition(action_id);
```

### 3.3 æ‰§è¡Œé€»è¾‘ä¿®æ”¹

#### **ä¿®æ”¹ 3: MacroEngine.executeMacro()**
```typescript
// entry/src/main/ets/services/MacroEngine.ts:139-160

// 5. ä¾æ¬¡æ‰§è¡ŒåŠ¨ä½œ
for (let i = 0; i < actions.length; i++) {
  const action = actions[i];
  Logger.info('MacroEngine', `Executing action ${i + 1}/${actions.length}: ${action.type}`);

  // ğŸ†• æ£€æŸ¥åŠ¨ä½œçº§æ¡ä»¶
  if (action.conditions && action.conditions.length > 0) {
    const conditionsPassed = await this.conditionEvaluator.evaluateActionConditions(
      action.conditions,
      context
    );

    if (!conditionsPassed) {
      Logger.info('MacroEngine', `Action ${action.type} conditions not met, skipping`);
      continue;  // ğŸ†• è·³è¿‡è¯¥åŠ¨ä½œï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª
    }
  }

  try {
    await this.actionExecutor.execute(action, context);
  } catch (error) {
    // é”™è¯¯å¤„ç†é€»è¾‘...
  }
}
```

#### **ä¿®æ”¹ 4: ConditionEvaluator å¢åŠ æ–¹æ³•**
```typescript
// entry/src/main/ets/services/ConditionEvaluator.ts

/**
 * è¯„ä¼°åŠ¨ä½œçº§æ¡ä»¶ï¼ˆæ”¯æŒ AND/OR é€»è¾‘ï¼‰
 */
public async evaluateActionConditions(
  conditions: ActionCondition[],
  context: ExecutionContext
): Promise<boolean> {
  if (conditions.length === 0) return true;

  let result = true;
  let currentLogic: 'AND' | 'OR' = 'AND';

  for (let i = 0; i < conditions.length; i++) {
    const condition = conditions[i];
    const singleResult = await this.evaluateSingleCondition(
      {
        id: 0,
        macroId: context.getMacroId(),
        field: condition.field,
        operator: condition.operator,
        value: condition.value
      },
      context
    );

    // æ ¹æ®é€»è¾‘è¿ç®—ç¬¦åˆå¹¶ç»“æœ
    if (i === 0) {
      result = singleResult;
    } else {
      if (currentLogic === 'AND') {
        result = result && singleResult;
      } else {
        result = result || singleResult;
      }
    }

    // è®¾ç½®ä¸‹ä¸€ä¸ªæ¡ä»¶çš„é€»è¾‘è¿ç®—ç¬¦
    currentLogic = condition.logicOperator || 'AND';

    Logger.info('ConditionEvaluator',
      `Action condition [${condition.field} ${condition.operator} ${condition.value}] = ${singleResult}, combined result = ${result}`
    );
  }

  return result;
}
```

### 3.4 æ•°æ®åº“æœåŠ¡ä¿®æ”¹

#### **ä¿®æ”¹ 5: DatabaseService å¢åŠ æ–¹æ³•**
```typescript
// entry/src/main/ets/services/DatabaseService.ts

/**
 * è·å–åŠ¨ä½œçš„æ¡ä»¶åˆ—è¡¨
 */
async getActionConditions(actionId: number): Promise<ActionCondition[]> {
  if (!this.store) throw new Error('Database not initialized');

  const predicates = new relationalStore.RdbPredicates('action_condition');
  predicates.equalTo('action_id', actionId);
  predicates.orderByAsc('order_index');

  try {
    const resultSet = await this.store.query(predicates);
    const conditions: ActionCondition[] = [];

    while (resultSet.goToNextRow()) {
      conditions.push({
        field: resultSet.getString(resultSet.getColumnIndex('field')),
        operator: resultSet.getString(resultSet.getColumnIndex('operator')) as ConditionOperator,
        value: resultSet.getString(resultSet.getColumnIndex('value')),
        logicOperator: resultSet.getString(resultSet.getColumnIndex('logic_operator')) as 'AND' | 'OR'
      });
    }

    resultSet.close();
    return conditions;
  } catch (error) {
    Logger.error('DatabaseService', `Failed to get action conditions for action ${actionId}`, error as Error);
    throw error;
  }
}

/**
 * åŠ è½½åŠ¨ä½œæ—¶è‡ªåŠ¨åŠ è½½æ¡ä»¶
 */
async getActionsByMacroId(macroId: number): Promise<Action[]> {
  // ...åŸæœ‰é€»è¾‘...

  const actions: Action[] = [];
  while (resultSet.goToNextRow()) {
    const action = this.parseActionFromResultSet(resultSet);

    // ğŸ†• åŠ è½½åŠ¨ä½œæ¡ä»¶
    action.conditions = await this.getActionConditions(action.id);

    actions.push(action);
  }

  return actions;
}
```

### 3.5 "å¿«å°çº¢"å·¥ä½œæµå®ç°ç¤ºä¾‹

```json
{
  "name": "å¿«å°çº¢",
  "actions": [
    {
      "type": "clipboard_read",
      "config": {"saveToVariable": "clipboard_content"}
    },
    {
      "type": "text_process",
      "config": {
        "operation": "regex_extract",
        "pattern": "https?://[^\\s]+",
        "input": "{clipboard_content}",
        "saveToVariable": "url"
      }
    },

    // åˆ†æ”¯A: å•†å“é‡‡é›†
    {
      "type": "http_request",
      "conditions": [
        {"field": "{url}", "operator": "contains", "value": "goods-detail"}
      ],
      "config": {
        "method": "POST",
        "url": "https://api.coze.cn/v1/workflow/run",
        "body": "{\"workflow_id\":\"{flowgoods}\", ...}",
        "saveToVariable": "response_goods"
      }
    },
    {
      "type": "notification",
      "conditions": [
        {"field": "{url}", "operator": "contains", "value": "goods-detail"}
      ],
      "config": {
        "title": "âœ… å•†å“é‡‡é›†æˆåŠŸ",
        "content": "{response_goods}"
      }
    },

    // åˆ†æ”¯B: åšä¸»é‡‡é›†
    {
      "type": "http_request",
      "conditions": [
        {"field": "{url}", "operator": "contains", "value": "user"}
      ],
      "config": {
        "method": "POST",
        "url": "https://api.coze.cn/v1/workflow/run",
        "body": "{\"workflow_id\":\"{flowbozhu}\", ...}",
        "saveToVariable": "response_blogger"
      }
    },

    // åˆ†æ”¯C: ç¬”è®°é‡‡é›†ï¼ˆé»˜è®¤åˆ†æ”¯ï¼‰
    {
      "type": "user_dialog",
      "conditions": [
        {"field": "{url}", "operator": "contains", "value": "goods-detail", "logicOperator": "OR"},
        {"field": "{url}", "operator": "contains", "value": "user"}
      ],
      "config": {
        "type": "single_select",
        "title": "è¯·é€‰æ‹©åˆ†ç±»æ ‡ç­¾",
        "options": ["ğŸ’„æ—¶å°šç¾å¦†", "ğŸŒæ—…æ¸¸å‡ºè¡Œ"],
        "saveToVariable": "category"
      }
    }
  ]
}
```

**è¯´æ˜**: é€šè¿‡ä¸ºæ¯ä¸ªåŠ¨ä½œæ·»åŠ æ¡ä»¶ï¼Œå®ç°ç±»ä¼¼ if-else çš„æ•ˆæœï¼š
- å•†å“é‡‡é›†åŠ¨ä½œåªåœ¨ URL åŒ…å« "goods-detail" æ—¶æ‰§è¡Œ
- åšä¸»é‡‡é›†åŠ¨ä½œåªåœ¨ URL åŒ…å« "user" æ—¶æ‰§è¡Œ
- ç¬”è®°é‡‡é›†åŠ¨ä½œåœ¨ URL ä¸åŒ…å«ä¸Šè¿°ä¸¤è€…æ—¶æ‰§è¡Œï¼ˆé€šè¿‡æ¡ä»¶çš„åå‘é€»è¾‘ï¼‰

### 3.6 å®æ–½è®¡åˆ’

| æ­¥éª¤ | ä»»åŠ¡ | å·¥ä½œé‡ | è´Ÿè´£äºº |
|-----|------|--------|--------|
| 1 | ä¿®æ”¹æ•°æ®æ¨¡å‹ï¼ˆMacro.tsï¼‰ | 1å°æ—¶ | åç«¯ |
| 2 | åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬ | 2å°æ—¶ | åç«¯ |
| 3 | å®ç° DatabaseService æ–¹æ³• | 3å°æ—¶ | åç«¯ |
| 4 | ä¿®æ”¹ ConditionEvaluator | 2å°æ—¶ | åç«¯ |
| 5 | ä¿®æ”¹ MacroEngine æ‰§è¡Œé€»è¾‘ | 2å°æ—¶ | åç«¯ |
| 6 | UI å±‚å¢åŠ æ¡ä»¶é…ç½®ç•Œé¢ | 4å°æ—¶ | å‰ç«¯ |
| 7 | å•å…ƒæµ‹è¯• | 4å°æ—¶ | æµ‹è¯• |
| 8 | é›†æˆæµ‹è¯•ï¼ˆ"å¿«å°çº¢"åœºæ™¯ï¼‰ | 2å°æ—¶ | æµ‹è¯• |

**æ€»å·¥ä½œé‡**: 20å°æ—¶ï¼ˆçº¦ 2.5 ä¸ªå·¥ä½œæ—¥ï¼‰

---

## å››ã€æ–¹æ¡ˆBï¼šIF_ELSEåŠ¨ä½œç±»å‹ï¼ˆé•¿æœŸæ¨èï¼‰â­â­â­â­

### 4.1 æ ¸å¿ƒæ€è·¯

æ–°å¢ `ActionType.IF_ELSE` åŠ¨ä½œç±»å‹ï¼Œå°†åˆ†æ”¯é€»è¾‘ä½œä¸ºä¸€ç§åŠ¨ä½œï¼š

```typescript
{
  "type": "if_else",
  "config": {
    "branches": [
      {
        "conditions": [
          {"field": "{url}", "operator": "contains", "value": "goods-detail"}
        ],
        "actions": [
          {"type": "http_request", "config": {...}},
          {"type": "notification", "config": {...}}
        ]
      },
      {
        "conditions": [
          {"field": "{url}", "operator": "contains", "value": "user"}
        ],
        "actions": [...]
      },
      {
        "isDefault": true,  // else åˆ†æ”¯
        "actions": [...]
      }
    ]
  }
}
```

### 4.2 ä¼˜ç‚¹

- âœ… çœŸæ­£çš„åˆ†æ”¯é€»è¾‘ï¼Œè¯­ä¹‰æ¸…æ™°
- âœ… æ”¯æŒåµŒå¥—ï¼ˆif å†…éƒ¨å¯ä»¥å†æœ‰ ifï¼‰
- âœ… UI å¯è§†åŒ–æµç¨‹å›¾æ›´ç›´è§‚

### 4.3 ç¼ºç‚¹

- âš ï¸ æ¶æ„æ”¹åŠ¨å¤§ï¼ˆåŠ¨ä½œå¯ä»¥åŒ…å«å­åŠ¨ä½œï¼‰
- âš ï¸ UI å®ç°å¤æ‚ï¼ˆéœ€è¦æ ‘å½¢å±•ç¤ºï¼‰
- âš ï¸ æ•°æ®åº“è®¾è®¡å¤æ‚ï¼ˆéœ€è¦æ”¯æŒåµŒå¥—ç»“æ„ï¼‰

### 4.4 å®æ–½è®¡åˆ’

**å¼€å‘å‘¨æœŸ**: 5-7å¤©ï¼ˆéœ€è¦é‡æ„éƒ¨åˆ†æ¶æ„ï¼‰

å»ºè®®åœ¨æ–¹æ¡ˆAç¨³å®šåå†å®æ–½ã€‚

---

## äº”ã€æ–¹æ¡ˆCï¼šå•å®æ‹†åˆ†ä¸ºå¤šå®ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰â­â­

### 5.1 æ ¸å¿ƒæ€è·¯

å°†"å¿«å°çº¢"æ‹†åˆ†ä¸ºä¸‰ä¸ªç‹¬ç«‹çš„å®ï¼š
1. å®A: å¿«å°çº¢-å•†å“é‡‡é›†
2. å®B: å¿«å°çº¢-åšä¸»é‡‡é›†
3. å®C: å¿«å°çº¢-ç¬”è®°é‡‡é›†

æ¯ä¸ªå®ä½¿ç”¨å®çº§æ¡ä»¶åˆ¤æ–­ï¼š

```json
// å®A: å•†å“é‡‡é›†
{
  "name": "å¿«å°çº¢-å•†å“é‡‡é›†",
  "conditions": [
    {"field": "{SYSTEM.clipboard}", "operator": "contains", "value": "goods-detail"}
  ],
  "actions": [...]
}

// å®B: åšä¸»é‡‡é›†
{
  "name": "å¿«å°çº¢-åšä¸»é‡‡é›†",
  "conditions": [
    {"field": "{SYSTEM.clipboard}", "operator": "contains", "value": "user"}
  ],
  "actions": [...]
}

// å®C: ç¬”è®°é‡‡é›†ï¼ˆæ— æ¡ä»¶ï¼Œé»˜è®¤æ‰§è¡Œï¼‰
{
  "name": "å¿«å°çº¢-ç¬”è®°é‡‡é›†",
  "actions": [...]
}
```

ç”¨æˆ·æ‰‹åŠ¨è§¦å‘æ—¶éœ€è¦ä¾æ¬¡è§¦å‘ä¸‰ä¸ªå®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è·³è¿‡æ¡ä»¶ä¸æ»¡è¶³çš„å®ã€‚

### 5.2 ä¼˜ç‚¹

- âœ… æ— éœ€ä¿®æ”¹æ¶æ„
- âœ… 1å¤©å³å¯å®Œæˆé…ç½®

### 5.3 ç¼ºç‚¹

- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼ˆéœ€è¦è§¦å‘ä¸‰æ¬¡ï¼‰
- âŒ ä¸æ˜¯é€šç”¨è§£å†³æ–¹æ¡ˆ
- âŒ ç»´æŠ¤æˆæœ¬é«˜ï¼ˆä¸‰ä¸ªå®éœ€åŒæ­¥æ›´æ–°ï¼‰

### 5.4 é€‚ç”¨åœºæ™¯

ä»…ä½œä¸º**ä¸´æ—¶åº”æ€¥æ–¹æ¡ˆ**ï¼Œåœ¨æ–¹æ¡ˆA/Bå®Œæˆå‰ä½¿ç”¨ã€‚

---

## å…­ã€æœ€ç»ˆå»ºè®®

### çŸ­æœŸï¼ˆæœ¬å‘¨å†…ï¼‰: æ–¹æ¡ˆA

**ç«‹å³å®æ–½åŠ¨ä½œçº§æ¡ä»¶åˆ¤æ–­**ï¼Œè§£å†³"å¿«å°çº¢"å·¥ä½œæµçš„é˜»å¡é—®é¢˜ã€‚

**ä¼˜å…ˆçº§**: ğŸ”´ P0
**å¼€å‘å‘¨æœŸ**: 2.5å¤©
**å…¼å®¹æ€§å½±å“**: ä½ï¼ˆå‘åå…¼å®¹ï¼‰

### ä¸­æœŸï¼ˆ1ä¸ªæœˆå†…ï¼‰: æ–¹æ¡ˆB

**å®ç° IF_ELSE åŠ¨ä½œç±»å‹**ï¼Œæä¾›çœŸæ­£çš„åˆ†æ”¯èƒ½åŠ›ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

**ä¼˜å…ˆçº§**: ğŸŸ¡ P1
**å¼€å‘å‘¨æœŸ**: 5-7å¤©
**å…¼å®¹æ€§å½±å“**: ä¸­ï¼ˆéœ€è¦UIé‡æ„ï¼‰

### é•¿æœŸï¼ˆ3ä¸ªæœˆå†…ï¼‰: é«˜çº§æµç¨‹æ§åˆ¶

- å¾ªç¯åŠ¨ä½œï¼ˆLOOPï¼‰
- å¼‚å¸¸å¤„ç†ï¼ˆTRY_CATCHï¼‰
- å¹¶è¡Œæ‰§è¡Œï¼ˆPARALLELï¼‰

---

## ä¸ƒã€é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|-----|------|---------|
| æ•°æ®åº“è¿ç§»å¤±è´¥ | é«˜ | æä¾›å›æ»šè„šæœ¬ï¼Œåšå¥½æ•°æ®å¤‡ä»½ |
| æ¡ä»¶åˆ¤æ–­æ€§èƒ½é—®é¢˜ | ä¸­ | å¢åŠ ç¼“å­˜ï¼Œé™åˆ¶æ¡ä»¶æ•°é‡ï¼ˆ< 10ä¸ªï¼‰ |
| UI äº¤äº’å¤æ‚åº¦å¢åŠ  | ä¸­ | æä¾›ç®€å•æ¨¡å¼å’Œé«˜çº§æ¨¡å¼ |
| å‘åå…¼å®¹æ€§ | ä½ | æ–°å­—æ®µå¯é€‰ï¼Œä¸å½±å“ç°æœ‰å® |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-01-08
**ä½œè€…**: Claude Code åˆ†æ
