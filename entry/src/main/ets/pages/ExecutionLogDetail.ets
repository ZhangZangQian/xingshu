import { ExecutionLog, ActionExecutionLog, Action } from '../models/Macro';
import { DatabaseService } from '../services/DatabaseService';
import { ActionTypes } from '../constants/ActionTypes';
import Logger from '../utils/Logger';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';

/**
 * ÊâßË°åÊó•ÂøóËØ¶ÊÉÖÈ°µ
 */
@Entry
@Component
struct ExecutionLogDetailPage {
  @State logId: number = 0;
  @State executionLog: ExecutionLog | null = null;
  @State actionLogs: ActionExecutionLog[] = [];
  @State actions: Map<number, Action> = new Map();
  @State loading: boolean = true;
  @State showDetails: Map<number, boolean> = new Map();
  private databaseService: DatabaseService = DatabaseService.getInstance();

  async aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    this.logId = params?.logId as number || 0;

    if (this.logId > 0) {
      await this.loadData();
    } else {
      promptAction.showToast({ message: 'Êó•Âøó ID Êó†Êïà' });
      router.back();
    }
  }

  /**
   * Âä†ËΩΩÊï∞ÊçÆ
   */
  private async loadData() {
    try {
      this.loading = true;

      // Âä†ËΩΩÊâßË°åÊó•Âøó
      this.executionLog = await this.databaseService.getExecutionLogById(this.logId);

      if (!this.executionLog) {
        promptAction.showToast({ message: 'Êú™ÊâæÂà∞Êó•ÂøóËÆ∞ÂΩï' });
        router.back();
        return;
      }

      // Âä†ËΩΩÂä®‰ΩúÊâßË°åÊó•Âøó
      this.actionLogs = await this.databaseService.getActionExecutionLogsByExecutionLogId(this.logId);

      // Âä†ËΩΩÊâÄÊúâÂÖ≥ËÅîÁöÑÂä®‰Ωú‰ø°ÊÅØ
      const actionIds = this.actionLogs.map(log => log.actionId);
      for (const actionId of actionIds) {
        try {
          const action = await this.databaseService.getActionById(actionId);
          if (action) {
            this.actions.set(actionId, action);
          }
        } catch (error) {
          const errorMsg = (error as Error).message || 'Unknown error';
          Logger.warn('ExecutionLogDetail', `Failed to load action ${actionId}: ${errorMsg}`);
        }
      }

      // ÈªòËÆ§Â±ïÂºÄÂ§±Ë¥•ÁöÑÂä®‰Ωú
      this.actionLogs.forEach(log => {
        if (log.status === 'failed') {
          this.showDetails.set(log.id, true);
        }
      });

      Logger.info('ExecutionLogDetail', `Loaded ${this.actionLogs.length} action logs`);
    } catch (error) {
      Logger.error('ExecutionLogDetail', 'Failed to load data', error as Error);
      promptAction.showToast({ message: 'Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•' });
    } finally {
      this.loading = false;
    }
  }

  /**
   * ËøîÂõû
   */
  private handleBack() {
    router.back();
  }

  /**
   * ÂàáÊç¢ËØ¶ÊÉÖÂ±ïÂºÄÁä∂ÊÄÅ
   */
  private toggleDetails(logId: number) {
    const current = this.showDetails.get(logId) || false;
    this.showDetails.set(logId, !current);
  }

  /**
   * Ê†ºÂºèÂåñÊó∂Èó¥Êà≥
   */
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    const milliseconds = String(date.getMilliseconds()).padStart(3, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
  }

  /**
   * Ê†ºÂºèÂåñÊó∂Èó¥Êà≥ÔºàÁü≠Ê†ºÂºèÔºâ
   */
  private formatShortTime(timestamp: number): string {
    const date = new Date(timestamp);
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    const milliseconds = String(date.getMilliseconds()).padStart(3, '0');
    return `${hours}:${minutes}:${seconds}.${milliseconds}`;
  }

  /**
   * Ëé∑ÂèñÁä∂ÊÄÅÈ¢úËâ≤
   */
  private getStatusColor(status: string): string {
    switch (status) {
      case 'success':
        return '#52c41a';
      case 'failed':
        return '#ff4d4f';
      case 'partial':
        return '#faad14';
      default:
        return '#999999';
    }
  }

  /**
   * Ëé∑ÂèñÁä∂ÊÄÅÊñáÊú¨
   */
  private getStatusText(status: string): string {
    switch (status) {
      case 'success':
        return 'ÊàêÂäü';
      case 'failed':
        return 'Â§±Ë¥•';
      case 'partial':
        return 'ÈÉ®ÂàÜÂ§±Ë¥•';
      default:
        return 'Êú™Áü•';
    }
  }

  /**
   * Ëé∑ÂèñÂä®‰ΩúÁ±ªÂûãÊñáÊú¨
   */
  private getActionTypeText(actionType: string): string {
    return ActionTypes.getDisplayName(actionType);
  }

  /**
   * Ëé∑ÂèñËß¶ÂèëÁ±ªÂûãÊñáÊú¨
   */
  private getTriggerTypeText(triggerType: string): string {
    switch (triggerType) {
      case 'time':
        return 'ÂÆöÊó∂Ëß¶Âèë';
      case 'network':
        return 'ÁΩëÁªúËß¶Âèë';
      case 'manual':
        return 'ÊâãÂä®Ëß¶Âèë';
      case 'clipboard':
        return 'Ââ™Ë¥¥ÊùøËß¶Âèë';
      default:
        return triggerType;
    }
  }

  /**
   * Ê†ºÂºèÂåñ JSON Êï∞ÊçÆ
   */
  private formatJsonData(jsonStr: string | undefined): string {
    if (!jsonStr) return 'Êó†';
    try {
      const data: ESObject = JSON.parse(jsonStr);
      return JSON.stringify(data, null, 2);
    } catch {
      return jsonStr;
    }
  }

  /**
   * Ëé∑ÂèñÂä®‰ΩúÈÖçÁΩÆ
   */
  private getAction(actionId: number): Action | undefined {
    return this.actions.get(actionId);
  }

  /**
   * Ê£ÄÊü•ÊòØÂê¶ÊòæÁ§∫ËØ¶ÊÉÖ
   */
  private shouldShowDetail(logId: number): boolean {
    return this.showDetails.get(logId) || false;
  }

  build() {
    Column() {
      // È°∂ÈÉ®Ê†áÈ¢òÊ†è
      Row() {
        Button() {
          Row({ space: 4 }) {
            Text('‚Üê')
              .fontSize(20)
              .fontColor('#007DFF')
            Text('ËøîÂõû')
              .fontSize(16)
              .fontColor('#007DFF')
          }
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.handleBack();
        })

        Text('ÊâßË°åÊó•ÂøóËØ¶ÊÉÖ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
          .textAlign(TextAlign.Center)

        // Âç†‰ΩçÔºå‰øùÊåÅÂ∏ÉÂ±ÄÂØπÁß∞
        Text('')
          .width(60)
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#ffffff')
      .border({ width: { bottom: 1 }, color: '#E5E5E5' })

      if (this.loading) {
        Column() {
          LoadingProgress()
            .width(48)
            .height(48)
            .color('#007DFF')

          Text('Âä†ËΩΩ‰∏≠...')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.executionLog) {
        Scroll() {
          Column({ space: 16 }) {
            // ÊâßË°åÊó•ÂøóÊ¶ÇËßàÂç°Áâá
            Column({ space: 12 }) {
              // Áä∂ÊÄÅÂõæÊ†áÂíåÊ†áÈ¢ò
              Row() {
                Text(this.getStatusText(this.executionLog.status) === 'ÊàêÂäü' ? '‚úì' :
                     this.getStatusText(this.executionLog.status) === 'Â§±Ë¥•' ? '‚úó' : '!')
                  .fontSize(32)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ffffff')
                  .width(56)
                  .height(56)
                  .borderRadius(28)
                  .backgroundColor(this.getStatusColor(this.executionLog.status))
                  .textAlign(TextAlign.Center)

                Column({ space: 6 }) {
                  Text(this.getStatusText(this.executionLog.status))
                    .fontSize(20)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.getStatusColor(this.executionLog.status))

                  Text(`ËÄóÊó∂ ${this.executionLog.duration}ms`)
                    .fontSize(14)
                    .fontColor('#999999')
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
                .margin({ left: 16 })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#ffffff')
              .borderRadius({ topLeft: 12, topRight: 12 })

              // ËØ¶ÁªÜ‰ø°ÊÅØ
              Column({ space: 10 }) {
                Row() {
                  Text('Ëß¶ÂèëÊñπÂºè')
                    .fontSize(14)
                    .fontColor('#666666')
                    .width(80)

                  Text(this.getTriggerTypeText(this.executionLog.triggerType))
                    .fontSize(14)
                    .fontColor('#333333')
                    .fontWeight(FontWeight.Medium)
                    .layoutWeight(1)
                }
                .width('100%')

                Row() {
                  Text('ÊâßË°åÊó∂Èó¥')
                    .fontSize(14)
                    .fontColor('#666666')
                    .width(80)

                  Text(this.formatTime(this.executionLog.executedAt))
                    .fontSize(14)
                    .fontColor('#333333')
                    .fontWeight(FontWeight.Medium)
                    .layoutWeight(1)
                }
                .width('100%')

                if (this.executionLog.errorMessage) {
                  Column({ space: 8 }) {
                    Text('ÈîôËØØ‰ø°ÊÅØ')
                      .fontSize(14)
                      .fontColor('#666666')
                      .fontWeight(FontWeight.Medium)

                    Text(this.executionLog.errorMessage)
                      .fontSize(14)
                      .fontColor('#ff4d4f')
                      .lineHeight(22)
                      .padding(12)
                      .backgroundColor('#FFF1F0')
                      .borderRadius(6)
                      .width('100%')
                  }
                  .width('100%')
                  .alignItems(HorizontalAlign.Start)
                }
              }
              .width('100%')
              .padding(16)
              .padding({ top: 0 })
              .backgroundColor('#FAFAFA')
              .borderRadius({ bottomLeft: 12, bottomRight: 12 })
            }
            .width('100%')
            .shadow({
              radius: 6,
              color: 'rgba(0, 0, 0, 0.08)',
              offsetX: 0,
              offsetY: 2
            })

            // Âä®‰ΩúÊâßË°åÊó•ÂøóÊ†áÈ¢ò
            Row() {
              Text('Âä®‰ΩúÊâßË°åËØ¶ÊÉÖ')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')

              Blank()

              Text(`${this.actionLogs.length} ‰∏™Âä®‰Ωú`)
                .fontSize(14)
                .fontColor('#999999')
            }
            .width('100%')
            .padding({ left: 4, right: 4 })

            // Âä®‰ΩúÊâßË°åÊó•ÂøóÂàóË°®
            if (this.actionLogs.length === 0) {
              Column() {
                Text('üìù')
                  .fontSize(48)
                  .margin({ bottom: 12 })

                Text('ÊöÇÊó†Âä®‰ΩúÊâßË°åËÆ∞ÂΩï')
                  .fontSize(14)
                  .fontColor('#999999')
              }
              .width('100%')
              .padding({ top: 32, bottom: 32 })
              .justifyContent(FlexAlign.Center)
            } else {
              Column({ space: 12 }) {
                ForEach(this.actionLogs, (actionLog: ActionExecutionLog, index: number) => {
                  Column({ space: 0 }) {
                    // Êó∂Èó¥Á∫øËäÇÁÇπÂíåÂü∫Êú¨‰ø°ÊÅØ
                    Row() {
                      // Êó∂Èó¥Á∫ø
                      Column({ space: 0 }) {
                        if (index === 0) {
                          Text('')
                            .width(2)
                            .height(16)
                        }
                        // Áä∂ÊÄÅËäÇÁÇπ
                        Column() {
                          Text(actionLog.status === 'success' ? '‚úì' : '‚úó')
                            .fontSize(14)
                            .fontWeight(FontWeight.Bold)
                            .fontColor('#ffffff')
                            .width(24)
                            .height(24)
                            .borderRadius(12)
                            .backgroundColor(this.getStatusColor(actionLog.status))
                            .textAlign(TextAlign.Center)
                        }
                        .width(24)
                        .height(24)
                        // ËøûÊé•Á∫ø
                        if (index < this.actionLogs.length - 1) {
                          Text('')
                            .width(2)
                            .height(32)
                            .backgroundColor('#E5E5E5')
                            .margin({ top: 4 })
                        }
                      }
                      .width(24)
                      .alignItems(HorizontalAlign.Center)

                      // Âä®‰Ωú‰ø°ÊÅØ
                      Column({ space: 8 }) {
                        Row({ space: 12 }) {
                          // Â∫èÂè∑
                          Text(`${index + 1}.`)
                            .fontSize(14)
                            .fontColor('#999999')
                            .fontWeight(FontWeight.Medium)
                            .width(24)

                          // Âä®‰ΩúÁ±ªÂûã
                          Text(this.getActionTypeText(actionLog.actionType))
                            .fontSize(15)
                            .fontWeight(FontWeight.Bold)
                            .fontColor('#333333')
                            .layoutWeight(1)

                          // Áä∂ÊÄÅÊ†áÁ≠æ
                          Text(actionLog.status === 'success' ? 'ÊàêÂäü' : 'Â§±Ë¥•')
                            .fontSize(12)
                            .fontColor(this.getStatusColor(actionLog.status))
                            .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                            .backgroundColor(this.getStatusColor(actionLog.status) + '15')
                            .borderRadius(10)
                        }
                        .width('100%')

                        // Êó∂Èó¥ÂíåËÄóÊó∂
                        Row({ space: 16 }) {
                          Text(`‚è± ${actionLog.duration}ms`)
                            .fontSize(12)
                            .fontColor('#999999')

                          Text(`üïê ${this.formatShortTime(actionLog.executedAt)}`)
                            .fontSize(12)
                            .fontColor('#999999')
                        }

                        // ÈîôËØØ‰ø°ÊÅØ
                        if (actionLog.errorMessage) {
                          Text(actionLog.errorMessage)
                            .fontSize(13)
                            .fontColor('#ff4d4f')
                            .lineHeight(20)
                            .padding(10)
                            .backgroundColor('#FFF1F0')
                            .borderRadius(6)
                            .width('100%')
                        }
                      }
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)
                      .margin({ left: 16 })

                      // Â±ïÂºÄÊåâÈíÆ
                      Button(this.shouldShowDetail(actionLog.id) ? 'Êî∂Ëµ∑' : 'ËØ¶ÊÉÖ')
                        .fontSize(12)
                        .fontColor('#007DFF')
                        .backgroundColor(Color.Transparent)
                        .onClick(() => {
                          this.toggleDetails(actionLog.id);
                        })
                    }
                    .width('100%')
                    .padding(16)
                    .onClick(() => {
                      this.toggleDetails(actionLog.id);
                    })

                    // ËØ¶ÁªÜ‰ø°ÊÅØÔºàÂèØÂ±ïÂºÄÔºâ
                    if (this.shouldShowDetail(actionLog.id)) {
                      Column({ space: 12 }) {
                        // ËæìÂÖ•Êï∞ÊçÆ
                        Column({ space: 6 }) {
                          Text('ËæìÂÖ•Êï∞ÊçÆ')
                            .fontSize(13)
                            .fontColor('#666666')
                            .fontWeight(FontWeight.Medium)

                          Text(this.formatJsonData(actionLog.inputData))
                            .fontSize(12)
                            .fontColor('#333333')
                            .fontFamily('monospace')
                            .lineHeight(18)
                            .padding(12)
                            .backgroundColor('#F5F7FA')
                            .borderRadius(6)
                            .width('100%')
                            .maxLines(20)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                        }
                        .width('100%')
                        .alignItems(HorizontalAlign.Start)

                        // ËæìÂá∫Êï∞ÊçÆ
                        if (actionLog.outputData) {
                          Column({ space: 6 }) {
                            Text('ËæìÂá∫Êï∞ÊçÆ')
                              .fontSize(13)
                              .fontColor('#666666')
                              .fontWeight(FontWeight.Medium)

                            Text(this.formatJsonData(actionLog.outputData))
                              .fontSize(12)
                              .fontColor('#333333')
                              .fontFamily('monospace')
                              .lineHeight(18)
                              .padding(12)
                              .backgroundColor('#F5F7FA')
                              .borderRadius(6)
                              .width('100%')
                              .maxLines(20)
                              .textOverflow({ overflow: TextOverflow.Ellipsis })
                          }
                          .width('100%')
                          .alignItems(HorizontalAlign.Start)
                        }
                      }
                      .width('100%')
                      .padding(16)
                      .padding({ top: 0 })
                      .backgroundColor('#FAFAFA')
                      .borderRadius(8)
                    }
                  }
                  .width('100%')
                  .backgroundColor('#ffffff')
                  .borderRadius(12)
                  .shadow({
                    radius: 4,
                    color: 'rgba(0, 0, 0, 0.06)',
                    offsetX: 0,
                    offsetY: 1
                  })
                }, (actionLog: ActionExecutionLog) => actionLog.id.toString())
              }
              .width('100%')
            }

            // Â∫ïÈÉ®ÁïôÁôΩ
            Text('')
              .height(16)
          }
          .padding(16)
          .width('100%')
        }
        .flexGrow(1)
        .scrollBar(BarState.Auto)
        .backgroundColor('#F5F7FA')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
  }

  /**
   * ‰ø°ÊÅØË°åÁªÑ‰ª∂
   */
  @Builder
  InfoRow(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor('#666666')
        .width(80)

      Text(value)
        .fontSize(14)
        .fontColor('#333333')
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
    }
    .width('100%')
  }
}
