import { ExecutionLog, ActionExecutionLog, Action } from '../models/Macro';
import { DatabaseService } from '../services/DatabaseService';
import { ClipboardService } from '../services/ClipboardService';
import { ActionTypes } from '../constants/ActionTypes';
import Logger from '../utils/Logger';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';

/**
 * æ‰§è¡Œæ—¥å¿—è¯¦æƒ…é¡µ
 */
@Entry
@Component
struct ExecutionLogDetailPage {
  @State logId: number = 0;
  @State executionLog: ExecutionLog | null = null;
  @State actionLogs: ActionExecutionLog[] = [];
  @State actions: Map<number, Action> = new Map();
  @State loading: boolean = true;
  @State showDetails: Map<number, boolean> = new Map();
  private databaseService: DatabaseService = DatabaseService.getInstance();
  private clipboardService: ClipboardService = ClipboardService.getInstance();

  async aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    this.logId = params?.logId as number || 0;

    if (this.logId > 0) {
      await this.loadData();
    } else {
      promptAction.showToast({ message: 'æ—¥å¿— ID æ— æ•ˆ' });
      router.back();
    }
  }

  /**
   * åŠ è½½æ•°æ®
   */
  private async loadData() {
    try {
      this.loading = true;

      // åŠ è½½æ‰§è¡Œæ—¥å¿—
      this.executionLog = await this.databaseService.getExecutionLogById(this.logId);

      if (!this.executionLog) {
        promptAction.showToast({ message: 'æœªæ‰¾åˆ°æ—¥å¿—è®°å½•' });
        router.back();
        return;
      }

      // åŠ è½½åŠ¨ä½œæ‰§è¡Œæ—¥å¿—
      this.actionLogs = await this.databaseService.getActionExecutionLogsByExecutionLogId(this.logId);

      // åŠ è½½æ‰€æœ‰å…³è”çš„åŠ¨ä½œä¿¡æ¯
      const actionIds = this.actionLogs.map(log => log.actionId);
      for (const actionId of actionIds) {
        try {
          const action = await this.databaseService.getActionById(actionId);
          if (action) {
            this.actions.set(actionId, action);
          }
        } catch (error) {
          const errorMsg = (error as Error).message || 'Unknown error';
          Logger.warn('ExecutionLogDetail', `Failed to load action ${actionId}: ${errorMsg}`);
        }
      }

      // é»˜è®¤å±•å¼€å¤±è´¥çš„åŠ¨ä½œ
      this.actionLogs.forEach(log => {
        if (log.status === 'failed') {
          this.showDetails.set(log.id, true);
        }
      });

      Logger.info('ExecutionLogDetail', `Loaded ${this.actionLogs.length} action logs`);
    } catch (error) {
      Logger.error('ExecutionLogDetail', 'Failed to load data', error as Error);
      promptAction.showToast({ message: 'åŠ è½½æ•°æ®å¤±è´¥' });
    } finally {
      this.loading = false;
    }
  }

  /**
   * è¿”å›
   */
  private handleBack() {
    router.back();
  }

  /**
   * åˆ‡æ¢è¯¦æƒ…å±•å¼€çŠ¶æ€
   */
  private toggleDetails(logId: number) {
    const current = this.showDetails.get(logId) || false;
    this.showDetails.set(logId, !current);
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´æˆ³
   */
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    const milliseconds = String(date.getMilliseconds()).padStart(3, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´æˆ³ï¼ˆçŸ­æ ¼å¼ï¼‰
   */
  private formatShortTime(timestamp: number): string {
    const date = new Date(timestamp);
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    const milliseconds = String(date.getMilliseconds()).padStart(3, '0');
    return `${hours}:${minutes}:${seconds}.${milliseconds}`;
  }

  /**
   * è·å–çŠ¶æ€é¢œè‰²
   */
  private getStatusColor(status: string): string {
    switch (status) {
      case 'success':
        return '#52c41a';
      case 'failed':
        return '#ff4d4f';
      case 'partial':
        return '#faad14';
      default:
        return '#999999';
    }
  }

  /**
   * è·å–çŠ¶æ€æ–‡æœ¬
   */
  private getStatusText(status: string): string {
    switch (status) {
      case 'success':
        return 'æˆåŠŸ';
      case 'failed':
        return 'å¤±è´¥';
      case 'partial':
        return 'éƒ¨åˆ†å¤±è´¥';
      default:
        return 'æœªçŸ¥';
    }
  }

  /**
   * è·å–åŠ¨ä½œç±»å‹æ–‡æœ¬
   */
  private getActionTypeText(actionType: string): string {
    return ActionTypes.getDisplayName(actionType);
  }

  /**
   * è·å–è§¦å‘ç±»å‹æ–‡æœ¬
   */
  private getTriggerTypeText(triggerType: string): string {
    switch (triggerType) {
      case 'time':
        return 'å®šæ—¶è§¦å‘';
      case 'network':
        return 'ç½‘ç»œè§¦å‘';
      case 'manual':
        return 'æ‰‹åŠ¨è§¦å‘';
      case 'clipboard':
        return 'å‰ªè´´æ¿è§¦å‘';
      default:
        return triggerType;
    }
  }

  /**
   * æ ¼å¼åŒ– JSON æ•°æ®
   */
  private formatJsonData(jsonStr: string | undefined): string {
    if (!jsonStr) return 'æ— ';
    try {
      const data: ESObject = JSON.parse(jsonStr);
      return JSON.stringify(data, null, 2);
    } catch {
      return jsonStr;
    }
  }

  /**
   * è·å–åŠ¨ä½œé…ç½®
   */
  private getAction(actionId: number): Action | undefined {
    return this.actions.get(actionId);
  }

  /**
    * æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºè¯¦æƒ…
    */
  private shouldShowDetail(logId: number): boolean {
    return this.showDetails.get(logId) || false;
  }

  /**
    * å¤åˆ¶æ•°æ®åˆ°å‰ªè´´æ¿
    */
  private async copyData(data: string, dataType: string): Promise<void> {
    try {
      await this.clipboardService.writeText(data);
      promptAction.showToast({ message: `${dataType} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿` });
      Logger.info('ExecutionLogDetail', `Copied ${dataType}: ${data.substring(0, 50)}...`);
    } catch (error) {
      const errorMsg = (error as Error).message || 'Unknown error';
      Logger.error('ExecutionLogDetail', `Failed to copy ${dataType}: ${errorMsg}`);
      promptAction.showToast({ message: `å¤åˆ¶å¤±è´¥: ${errorMsg}` });
    }
  }


  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Button() {
          Row({ space: 4 }) {
            Text('â†')
              .fontSize(20)
              .fontColor('#007DFF')
            Text('è¿”å›')
              .fontSize(16)
              .fontColor('#007DFF')
          }
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.handleBack();
        })

        Text('æ‰§è¡Œæ—¥å¿—è¯¦æƒ…')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒå¸ƒå±€å¯¹ç§°
        Text('')
          .width(60)
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#ffffff')
      .border({ width: { bottom: 1 }, color: '#E5E5E5' })

      if (this.loading) {
        Column() {
          LoadingProgress()
            .width(48)
            .height(48)
            .color('#007DFF')

          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.executionLog) {
        Scroll() {
          Column({ space: 16 }) {
            // æ‰§è¡Œæ—¥å¿—æ¦‚è§ˆå¡ç‰‡
            Column({ space: 12 }) {
              // çŠ¶æ€å›¾æ ‡å’Œæ ‡é¢˜
              Row() {
                Text(this.getStatusText(this.executionLog.status) === 'æˆåŠŸ' ? 'âœ“' :
                     this.getStatusText(this.executionLog.status) === 'å¤±è´¥' ? 'âœ—' : '!')
                  .fontSize(32)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ffffff')
                  .width(56)
                  .height(56)
                  .borderRadius(28)
                  .backgroundColor(this.getStatusColor(this.executionLog.status))
                  .textAlign(TextAlign.Center)

                Column({ space: 6 }) {
                  Text(this.getStatusText(this.executionLog.status))
                    .fontSize(20)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.getStatusColor(this.executionLog.status))

                  Text(`è€—æ—¶ ${this.executionLog.duration}ms`)
                    .fontSize(14)
                    .fontColor('#999999')
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
                .margin({ left: 16 })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#ffffff')
              .borderRadius({ topLeft: 12, topRight: 12 })

              // è¯¦ç»†ä¿¡æ¯
              Column({ space: 10 }) {
                Row() {
                  Text('è§¦å‘æ–¹å¼')
                    .fontSize(14)
                    .fontColor('#666666')
                    .width(80)

                  Text(this.getTriggerTypeText(this.executionLog.triggerType))
                    .fontSize(14)
                    .fontColor('#333333')
                    .fontWeight(FontWeight.Medium)
                    .layoutWeight(1)
                }
                .width('100%')

                Row() {
                  Text('æ‰§è¡Œæ—¶é—´')
                    .fontSize(14)
                    .fontColor('#666666')
                    .width(80)

                  Text(this.formatTime(this.executionLog.executedAt))
                    .fontSize(14)
                    .fontColor('#333333')
                    .fontWeight(FontWeight.Medium)
                    .layoutWeight(1)
                }
                .width('100%')

                if (this.executionLog.errorMessage) {
                  Column({ space: 8 }) {
                    Text('é”™è¯¯ä¿¡æ¯')
                      .fontSize(14)
                      .fontColor('#666666')
                      .fontWeight(FontWeight.Medium)

                    Text(this.executionLog.errorMessage)
                      .fontSize(14)
                      .fontColor('#ff4d4f')
                      .lineHeight(22)
                      .padding(12)
                      .backgroundColor('#FFF1F0')
                      .borderRadius(6)
                      .width('100%')
                  }
                  .width('100%')
                  .alignItems(HorizontalAlign.Start)
                }
              }
              .width('100%')
              .padding(16)
              .padding({ top: 0 })
              .backgroundColor('#FAFAFA')
              .borderRadius({ bottomLeft: 12, bottomRight: 12 })
            }
            .width('100%')
            .shadow({
              radius: 6,
              color: 'rgba(0, 0, 0, 0.08)',
              offsetX: 0,
              offsetY: 2
            })

            // åŠ¨ä½œæ‰§è¡Œæ—¥å¿—æ ‡é¢˜
            Row() {
              Text('åŠ¨ä½œæ‰§è¡Œè¯¦æƒ…')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')

              Blank()

              Text(`${this.actionLogs.length} ä¸ªåŠ¨ä½œ`)
                .fontSize(14)
                .fontColor('#999999')
            }
            .width('100%')
            .padding({ left: 4, right: 4 })

            // åŠ¨ä½œæ‰§è¡Œæ—¥å¿—åˆ—è¡¨
            if (this.actionLogs.length === 0) {
              Column() {
                Text('ğŸ“')
                  .fontSize(48)
                  .margin({ bottom: 12 })

                Text('æš‚æ— åŠ¨ä½œæ‰§è¡Œè®°å½•')
                  .fontSize(14)
                  .fontColor('#999999')
              }
              .width('100%')
              .padding({ top: 32, bottom: 32 })
              .justifyContent(FlexAlign.Center)
            } else {
              Column({ space: 12 }) {
                ForEach(this.actionLogs, (actionLog: ActionExecutionLog, index: number) => {
                  Column({ space: 0 }) {
                    // æ—¶é—´çº¿èŠ‚ç‚¹å’ŒåŸºæœ¬ä¿¡æ¯
                    Row() {
                      // æ—¶é—´çº¿
                      Column({ space: 0 }) {
                        if (index === 0) {
                          Text('')
                            .width(2)
                            .height(16)
                        }
                        // çŠ¶æ€èŠ‚ç‚¹
                        Column() {
                          Text(actionLog.status === 'success' ? 'âœ“' : 'âœ—')
                            .fontSize(14)
                            .fontWeight(FontWeight.Bold)
                            .fontColor('#ffffff')
                            .width(24)
                            .height(24)
                            .borderRadius(12)
                            .backgroundColor(this.getStatusColor(actionLog.status))
                            .textAlign(TextAlign.Center)
                        }
                        .width(24)
                        .height(24)
                        // è¿æ¥çº¿
                        if (index < this.actionLogs.length - 1) {
                          Text('')
                            .width(2)
                            .height(32)
                            .backgroundColor('#E5E5E5')
                            .margin({ top: 4 })
                        }
                      }
                      .width(24)
                      .alignItems(HorizontalAlign.Center)

                      // åŠ¨ä½œä¿¡æ¯
                      Column({ space: 8 }) {
                        Row({ space: 12 }) {
                          // åºå·
                          Text(`${index + 1}.`)
                            .fontSize(14)
                            .fontColor('#999999')
                            .fontWeight(FontWeight.Medium)
                            .width(24)

                          // åŠ¨ä½œç±»å‹
                          Text(this.getActionTypeText(actionLog.actionType))
                            .fontSize(15)
                            .fontWeight(FontWeight.Bold)
                            .fontColor('#333333')
                            .layoutWeight(1)

                          // çŠ¶æ€æ ‡ç­¾
                          Text(actionLog.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥')
                            .fontSize(12)
                            .fontColor(this.getStatusColor(actionLog.status))
                            .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                            .backgroundColor(this.getStatusColor(actionLog.status) + '15')
                            .borderRadius(10)
                        }
                        .width('100%')

                        // æ—¶é—´å’Œè€—æ—¶
                        Row({ space: 16 }) {
                          Text(`â± ${actionLog.duration}ms`)
                            .fontSize(12)
                            .fontColor('#999999')

                          Text(`ğŸ• ${this.formatShortTime(actionLog.executedAt)}`)
                            .fontSize(12)
                            .fontColor('#999999')
                        }

                        // é”™è¯¯ä¿¡æ¯
                        if (actionLog.errorMessage) {
                          Text(actionLog.errorMessage)
                            .fontSize(13)
                            .fontColor('#ff4d4f')
                            .lineHeight(20)
                            .padding(10)
                            .backgroundColor('#FFF1F0')
                            .borderRadius(6)
                            .width('100%')
                        }
                      }
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)
                      .margin({ left: 16 })

                      // å±•å¼€æŒ‰é’®
                      Button(this.shouldShowDetail(actionLog.id) ? 'æ”¶èµ·' : 'è¯¦æƒ…')
                        .fontSize(12)
                        .fontColor('#007DFF')
                        .backgroundColor(Color.Transparent)
                        .onClick(() => {
                          this.toggleDetails(actionLog.id);
                        })
                    }
                    .width('100%')
                    .padding(16)
                    .onClick(() => {
                      this.toggleDetails(actionLog.id);
                    })

                    // è¯¦ç»†ä¿¡æ¯ï¼ˆå¯å±•å¼€ï¼‰
                    if (this.shouldShowDetail(actionLog.id)) {
                      Column({ space: 12 }) {
                         // è¾“å…¥æ•°æ®
                        Column({ space: 6 }) {
                          Row() {
                            Text('è¾“å…¥æ•°æ®')
                              .fontSize(13)
                              .fontColor('#666666')
                              .fontWeight(FontWeight.Medium)
                              .layoutWeight(1)

                            Button('å¤åˆ¶')
                              .fontSize(11)
                              .fontColor('#007DFF')
                              .backgroundColor(Color.Transparent)
                              .height(28)
                              .onClick(() => {
                                this.copyData(this.formatJsonData(actionLog.inputData), 'è¾“å…¥æ•°æ®');
                              })
                          }
                          .width('100%')

                          Text(this.formatJsonData(actionLog.inputData))
                            .fontSize(12)
                            .fontColor('#333333')
                            .fontFamily('monospace')
                            .lineHeight(18)
                            .padding(12)
                            .backgroundColor('#F5F7FA')
                            .borderRadius(6)
                            .width('100%')
                        }
                        .width('100%')
                        .alignItems(HorizontalAlign.Start)

                         // è¾“å‡ºæ•°æ®
                        if (actionLog.outputData) {
                          Column({ space: 6 }) {
                            Row() {
                              Text('è¾“å‡ºæ•°æ®')
                                .fontSize(13)
                                .fontColor('#666666')
                                .fontWeight(FontWeight.Medium)
                                .layoutWeight(1)

                              Button('å¤åˆ¶')
                                .fontSize(11)
                                .fontColor('#007DFF')
                                .backgroundColor(Color.Transparent)
                                .height(28)
                                .onClick(() => {
                                  this.copyData(this.formatJsonData(actionLog.outputData), 'è¾“å‡ºæ•°æ®');
                                })
                            }
                            .width('100%')

                            Text(this.formatJsonData(actionLog.outputData))
                              .fontSize(12)
                              .fontColor('#333333')
                              .fontFamily('monospace')
                              .lineHeight(18)
                              .padding(12)
                              .backgroundColor('#F5F7FA')
                              .borderRadius(6)
                              .width('100%')
                          }
                          .width('100%')
                          .alignItems(HorizontalAlign.Start)
                        }
                      }
                      .width('100%')
                      .padding(16)
                      .padding({ top: 0 })
                      .backgroundColor('#FAFAFA')
                      .borderRadius(8)
                    }
                  }
                  .width('100%')
                  .backgroundColor('#ffffff')
                  .borderRadius(12)
                  .shadow({
                    radius: 4,
                    color: 'rgba(0, 0, 0, 0.06)',
                    offsetX: 0,
                    offsetY: 1
                  })
                }, (actionLog: ActionExecutionLog) => actionLog.id.toString())
              }
              .width('100%')
            }

            // åº•éƒ¨ç•™ç™½
            Text('')
              .height(16)
          }
          .padding(16)
          .width('100%')
        }
        .flexGrow(1)
        .scrollBar(BarState.Auto)
        .backgroundColor('#F5F7FA')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
  }

  /**
   * ä¿¡æ¯è¡Œç»„ä»¶
   */
  @Builder
  InfoRow(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor('#666666')
        .width(80)

      Text(value)
        .fontSize(14)
        .fontColor('#333333')
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
    }
    .width('100%')
  }
}
