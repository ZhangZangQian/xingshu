import { ExecutionLog, Macro } from '../models/Macro';
import { DatabaseService } from '../services/DatabaseService';
import Logger from '../utils/Logger';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';

/**
 * æ‰§è¡Œæ—¥å¿—é¡µ
 */
@Entry
@Component
struct ExecutionLogPage {
  @State logs: ExecutionLog[] = [];
  @State macros: Map<number, Macro> = new Map();
  @State loading: boolean = true;
  @State refreshing: boolean = false;
  private databaseService: DatabaseService = DatabaseService.getInstance();

  async aboutToAppear() {
    await this.loadLogs();
  }

  /**
   * åŠ è½½æ‰§è¡Œæ—¥å¿—
   */
  private async loadLogs() {
    try {
      this.loading = true;
      this.logs = await this.databaseService.getAllExecutionLogs(100);

      // åŠ è½½æ‰€æœ‰å…³è”çš„å®ä¿¡æ¯
      const uniqueIds: number[] = [];
      const idSet = new Set<number>();
      for (const log of this.logs) {
        if (!idSet.has(log.macroId)) {
          idSet.add(log.macroId);
          uniqueIds.push(log.macroId);
        }
      }
      for (const macroId of uniqueIds) {
        try {
          const macro = await this.databaseService.getMacroById(macroId);
          if (macro) {
            this.macros.set(macroId, macro);
          }
        } catch (error) {
          const errorMsg = (error as Error).message || 'Unknown error';
          Logger.warn('ExecutionLog', `Failed to load macro ${macroId}: ${errorMsg}`);
        }
      }

      Logger.info('ExecutionLog', `Loaded ${this.logs.length} logs`);
    } catch (error) {
      Logger.error('ExecutionLog', 'Failed to load logs', error as Error);
      promptAction.showToast({ message: 'åŠ è½½æ—¥å¿—å¤±è´¥' });
    } finally {
      this.loading = false;
    }
  }

  /**
   * ä¸‹æ‹‰åˆ·æ–°
   */
  private async onRefresh() {
    this.refreshing = true;
    await this.loadLogs();
    this.refreshing = false;
  }

  /**
   * ç‚¹å‡»æ—¥å¿—é¡¹ï¼Œè·³è½¬åˆ°è¯¦æƒ…é¡µ
   */
  private handleLogClick(log: ExecutionLog) {
    router.pushUrl({
      url: 'pages/ExecutionLogDetail',
      params: {
        logId: log.id
      }
    });
  }

  /**
   * è¿”å›é¦–é¡µ
   */
  private handleBack() {
    router.back();
  }

  /**
   * è·å–å®ä¿¡æ¯
   */
  private getMacro(macroId: number): Macro | undefined {
    return this.macros.get(macroId);
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´æˆ³
   */
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${month}-${day} ${hours}:${minutes}:${seconds}`;
  }

  /**
   * è·å–çŠ¶æ€é¢œè‰²
   */
  private getStatusColor(status: string): string {
    switch (status) {
      case 'success':
        return '#52c41a';
      case 'failed':
        return '#ff4d4f';
      case 'partial':
        return '#faad14';
      default:
        return '#999999';
    }
  }

  /**
   * è·å–çŠ¶æ€æ–‡æœ¬
   */
  private getStatusText(status: string): string {
    switch (status) {
      case 'success':
        return 'æˆåŠŸ';
      case 'failed':
        return 'å¤±è´¥';
      case 'partial':
        return 'éƒ¨åˆ†å¤±è´¥';
      default:
        return 'æœªçŸ¥';
    }
  }

  /**
   * è·å–çŠ¶æ€å›¾æ ‡
   */
  private getStatusIcon(status: string): string {
    switch (status) {
      case 'success':
        return 'âœ“';
      case 'failed':
        return 'âœ—';
      case 'partial':
        return '!';
      default:
        return '?';
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Button('è¿”å›')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => {
            this.handleBack();
          })

        Text('æ‰§è¡Œæ—¥å¿—')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒå¸ƒå±€å¯¹ç§°
        Text('')
          .width(60)
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#ffffff')

      // æ—¥å¿—åˆ—è¡¨
      if (this.loading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#007DFF')

          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.logs.length === 0) {
        Column() {
          Text('ğŸ“‹')
            .fontSize(64)
            .margin({ bottom: 16 })

          Text('æš‚æ— æ‰§è¡Œæ—¥å¿—')
            .fontSize(16)
            .fontColor('#999999')

          Text('æ‰§è¡Œå®åå°†æ˜¾ç¤ºæ—¥å¿—è®°å½•')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .margin({ top: 8 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        Refresh({ refreshing: $$this.refreshing }) {
          Scroll() {
            Column({ space: 12 }) {
              ForEach(this.logs, (log: ExecutionLog) => {
                Column({ space: 0 }) {
                  // é¡¶éƒ¨çŠ¶æ€æ 
                  Row() {
                    // çŠ¶æ€å›¾æ ‡
                    Text(this.getStatusIcon(log.status))
                      .fontSize(20)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#ffffff')
                      .width(32)
                      .height(32)
                      .borderRadius(16)
                      .backgroundColor(this.getStatusColor(log.status))
                      .textAlign(TextAlign.Center)

                    Column({ space: 4 }) {
                      // å®åç§°
                      Text(this.getMacro(log.macroId)?.name || `å® #${log.macroId}`)
                        .fontSize(16)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#333333')
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })

                      // è§¦å‘æ–¹å¼
                      Row({ space: 8 }) {
                        Text('è§¦å‘ï¼š')
                          .fontSize(12)
                          .fontColor('#999999')

                        Text(this.getTriggerTypeText(log.triggerType))
                          .fontSize(12)
                          .fontColor('#666666')
                      }
                    }
                    .alignItems(HorizontalAlign.Start)
                    .layoutWeight(1)
                    .margin({ left: 12 })

                    // çŠ¶æ€æ ‡ç­¾
                    Text(this.getStatusText(log.status))
                      .fontSize(12)
                      .fontColor(this.getStatusColor(log.status))
                      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                      .backgroundColor(this.getStatusColor(log.status) + '15')
                      .borderRadius(12)
                  }
                  .width('100%')
                  .padding(16)
                  .backgroundColor('#ffffff')
                  .borderRadius({ topLeft: 12, topRight: 12 })

                  // åº•éƒ¨ä¿¡æ¯æ 
                  Row() {
                    // æ—¶é—´
                    Row({ space: 4 }) {
                      Text('ğŸ•')
                        .fontSize(12)

                      Text(this.formatTime(log.executedAt))
                        .fontSize(12)
                        .fontColor('#999999')
                    }

                    // åˆ†éš”ç¬¦
                    Text('|')
                      .fontSize(12)
                      .fontColor('#DDDDDD')
                      .margin({ left: 8, right: 8 })

                    // æ‰§è¡Œæ—¶é•¿
                    Row({ space: 4 }) {
                      Text('â±')
                        .fontSize(12)

                      Text(`${log.duration}ms`)
                        .fontSize(12)
                        .fontColor('#999999')
                    }

                    Blank()

                    // æŸ¥çœ‹è¯¦æƒ…ç®­å¤´
                    Text('æŸ¥çœ‹è¯¦æƒ…')
                      .fontSize(12)
                      .fontColor('#007DFF')
                  }
                  .width('100%')
                  .padding(12)
                  .padding({ left: 16, right: 16 })
                  .backgroundColor('#FAFAFA')
                  .borderRadius({ bottomLeft: 12, bottomRight: 12 })
                  .onClick(() => {
                    this.handleLogClick(log);
                  })
                }
                .backgroundColor('#ffffff')
                .borderRadius(12)
                .shadow({
                  radius: 4,
                  color: 'rgba(0, 0, 0, 0.08)',
                  offsetX: 0,
                  offsetY: 2
                })
              }, (log: ExecutionLog) => log.id.toString())
            }
            .padding(16)
            .width('100%')
          }
          .flexGrow(1)
          .scrollBar(BarState.Auto)
        }
        .flexGrow(1)
        .onStateChange((status: RefreshStatus) => {
          if (status === RefreshStatus.Inactive && this.refreshing) {
            this.onRefresh();
          }
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
  }

  /**
   * è·å–è§¦å‘ç±»å‹æ–‡æœ¬
   */
  private getTriggerTypeText(triggerType: string): string {
    switch (triggerType) {
      case 'time':
        return 'å®šæ—¶';
      case 'network':
        return 'ç½‘ç»œ';
      case 'manual':
        return 'æ‰‹åŠ¨';
      case 'clipboard':
        return 'å‰ªè´´æ¿';
      default:
        return triggerType;
    }
  }
}
