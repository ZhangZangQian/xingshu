import { Macro, MacroInput, Trigger, Action, TriggerType, ActionType, TimeTriggerConfig, NetworkTriggerConfig, HttpHeaders, Folder } from '../models/Macro';
import { ActionViewModel, ActionViewModelFactory, TextSegment } from '../models/ActionViewModel';
import { DatabaseService } from '../services/DatabaseService';
import { VariableFlowAnalyzer } from '../utils/VariableFlowAnalyzer';
import { ActionConfigSummaryGenerator } from '../utils/ActionConfigSummaryGenerator';
import { VariableNameRecommender } from '../utils/VariableNameRecommender';
import { VariableOption } from '../components/VariableSelector';
import { CommonTopBar, TopBarConfig } from '../components/CommonTopBar';
import { ActionTypes } from '../constants/ActionTypes';
import Logger from '../utils/Logger';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';

/**
 * åŠ¨ä½œä¿¡æ¯æ¥å£
 */
interface ActionInfo {
  type: string;
  displayName: string;
  description: string;
  icon: string;
  color: string;
  category: string;
}

/**
 * å®ç¼–è¾‘é¡µï¼ˆiOSå¿«æ·æŒ‡ä»¤é£æ ¼ï¼‰
 * å‚è€ƒiPhoneå¿«æ·æŒ‡ä»¤appçš„ç•Œé¢è®¾è®¡
 */
@Entry
@Component
struct MacroEditor {
  @State macroName: string = '';
  @State macroDescription: string = '';
  @State macroEnabled: boolean = true;
  @State selectedFolderId: number | null = null;
  @State folders: Folder[] = [];
  @State isEditMode: boolean = false;
  @State triggers: Trigger[] = [];
  @State actions: Action[] = [];
  @State actionViewModels: ActionViewModel[] = [];
  @State highlightedVariable: string = '';
  @State showSettings: boolean = false; // è®¾ç½®é¢æ¿æ˜¾ç¤ºçŠ¶æ€
  @State showActionDrawer: boolean = false; // åŠ¨ä½œæŠ½å±‰æ˜¾ç¤ºçŠ¶æ€
  @State actionSearchText: string = ''; // åŠ¨ä½œæœç´¢æ–‡å­—
  @State selectedActionCategory: string = 'all'; // é€‰ä¸­çš„åŠ¨ä½œåˆ†ç±»
  @State inlineEditingIndex: number = -1; // å†…è”ç¼–è¾‘çš„åŠ¨ä½œç´¢å¼•
  @State inlineEditingField: string = ''; // å†…è”ç¼–è¾‘çš„å­—æ®µå
  @State inlineEditingValue: string = ''; // å†…è”ç¼–è¾‘çš„å€¼








  // åŠ¨ä½œé…ç½®ç¼–è¾‘å™¨çŠ¶æ€
  @State expandedActionIndex: number = -1;
  @State editingAction: Action | null = null;
  @State editingActionConfig: Record<string, Object> = {};
  @State availableVariablesForEditor: VariableOption[] = [];

  // æ–‡ä»¶å¤¹é€‰æ‹©å™¨çŠ¶æ€
  @State showFolderSelector: boolean = false;

  private macroId: number = 0;
  private databaseService: DatabaseService = DatabaseService.getInstance();

  async aboutToAppear() {
    await this.loadFolders();

    // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘æ¨¡å¼
    const params = router.getParams() as Record<string, Object>;
    if (params && params['macroId']) {
      this.isEditMode = true;
      this.macroId = params['macroId'] as number;
      await this.loadMacro();
    }
  }

  /**
   * åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
   */
  private async loadFolders() {
    try {
      this.folders = await this.databaseService.getAllFolders();
    } catch (error) {
      Logger.error('MacroEditor', 'Failed to load folders', error as Error);
    }
  }

  /**
   * åŠ è½½å®æ•°æ®
   */
  private async loadMacro() {
    try {
      const macro = await this.databaseService.getMacroById(this.macroId);
      if (macro) {
        this.macroName = macro.name;
        this.macroDescription = macro.description || '';
        this.macroEnabled = macro.enabled;
        this.selectedFolderId = macro.folderId || null;
      }

      // åŠ è½½è§¦å‘å™¨å’ŒåŠ¨ä½œ
      this.triggers = await this.databaseService.getTriggersByMacroId(this.macroId);
      this.actions = await this.databaseService.getActionsByMacroId(this.macroId);

      // æ›´æ–°åŠ¨ä½œè§†å›¾æ¨¡å‹
      this.updateActionViewModels();

    } catch (error) {
      Logger.error('MacroEditor', 'Failed to load macro', error as Error);
      promptAction.showToast({ message: 'åŠ è½½å®æ•°æ®å¤±è´¥' });
    }
  }

  /**
   * ä¿å­˜å®
   */
  private async handleSave() {
    // éªŒè¯è¾“å…¥
    if (!this.macroName || this.macroName.trim().length === 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å®åç§°' });
      return;
    }

    if (this.macroName.length > 50) {
      promptAction.showToast({ message: 'å®åç§°ä¸èƒ½è¶…è¿‡ 50 ä¸ªå­—ç¬¦' });
      return;
    }

    // éªŒè¯å¿…é¡»æœ‰è‡³å°‘1ä¸ªè§¦å‘å™¨å’Œ1ä¸ªåŠ¨ä½œ
    if (this.triggers.length === 0) {
      promptAction.showToast({ message: 'è¯·è‡³å°‘æ·»åŠ 1ä¸ªè§¦å‘å™¨' });
      return;
    }

    if (this.actions.length === 0) {
      promptAction.showToast({ message: 'è¯·è‡³å°‘æ·»åŠ 1ä¸ªåŠ¨ä½œ' });
      return;
    }

    try {
      const now = Date.now();

      if (this.isEditMode) {
        Logger.info('MacroEditor', `Saving macro ${this.macroId} in edit mode`);

        // æ›´æ–°å®åŸºæœ¬ä¿¡æ¯
        await this.databaseService.updateMacro(this.macroId, {
          name: this.macroName.trim(),
          description: this.macroDescription.trim(),
          enabled: this.macroEnabled,
          folderId: this.selectedFolderId
        });

        Logger.info('MacroEditor', 'Macro basic info updated');

        // ä¿å­˜è§¦å‘å™¨å’ŒåŠ¨ä½œï¼ˆå…ˆåˆ é™¤å†æ’å…¥ï¼‰
        // 1. åˆ é™¤æ‰€æœ‰æ—§çš„è§¦å‘å™¨å’ŒåŠ¨ä½œ
        await this.databaseService.deleteTriggersByMacroId(this.macroId);
        await this.databaseService.deleteActionsByMacroId(this.macroId);

        Logger.info('MacroEditor', 'Old triggers and actions deleted');

        // 2. é‡æ–°æ’å…¥è§¦å‘å™¨
        for (const trigger of this.triggers) {
          await this.databaseService.insertTrigger({
            macroId: this.macroId,
            type: trigger.type,
            config: trigger.config,
            enabled: trigger.enabled
          });
        }

        Logger.info('MacroEditor', `Inserted ${this.triggers.length} triggers`);

        // 3. é‡æ–°æ’å…¥åŠ¨ä½œ
        for (const action of this.actions) {
          await this.databaseService.insertAction({
            macroId: this.macroId,
            type: action.type,
            config: action.config,
            orderIndex: action.orderIndex
          });
        }

        Logger.info('MacroEditor', `Inserted ${this.actions.length} actions`);

        promptAction.showToast({ message: 'å®å·²æ›´æ–°' });
      } else {
        Logger.info('MacroEditor', 'Creating new macro');

        // åˆ›å»ºæ–°å®
        const macro: MacroInput = {
          name: this.macroName.trim(),
          description: this.macroDescription.trim(),
          enabled: this.macroEnabled,
          folderId: this.selectedFolderId ?? undefined,
          createdAt: now,
          updatedAt: now
        };
        this.macroId = await this.databaseService.insertMacro(macro);

        Logger.info('MacroEditor', `Macro created with ID: ${this.macroId}`);

        // ä¿å­˜è§¦å‘å™¨
        for (const trigger of this.triggers) {
          await this.databaseService.insertTrigger({
            macroId: this.macroId,
            type: trigger.type,
            config: trigger.config,
            enabled: trigger.enabled
          });
        }

        // ä¿å­˜åŠ¨ä½œ
        for (const action of this.actions) {
          await this.databaseService.insertAction({
            macroId: this.macroId,
            type: action.type,
            config: action.config,
            orderIndex: action.orderIndex
          });
        }

        promptAction.showToast({ message: 'å®å·²åˆ›å»º' });
      }

      // è¿”å›åˆ—è¡¨é¡µ
      router.back();
    } catch (error) {
      Logger.error('MacroEditor', 'Failed to save macro', error as Error);
      promptAction.showToast({ message: `ä¿å­˜å¤±è´¥: ${error.message}` });
    }
  }

  /**
   * å–æ¶ˆç¼–è¾‘
   */
  private handleCancel() {
    router.back();
  }

  /**
   * c
   * åˆ†æå˜é‡æµå‘å¹¶ç”Ÿæˆé…ç½®æ‘˜è¦
   */
  private updateActionViewModels() {
    Logger.info('MacroEditor', `Updating action view models, actions count: ${this.actions.length}`);

    // åˆ›å»ºæ–°çš„è§†å›¾æ¨¡å‹æ•°ç»„ï¼ˆç¡®ä¿å¼•ç”¨å˜åŒ–ä»¥è§¦å‘ UI æ›´æ–°ï¼‰
    const newViewModels: ActionViewModel[] = this.actions.map((action: Action, index: number): ActionViewModel => {
      Logger.info('MacroEditor', `Processing action ${index}, config: ${action.config}`);

      // è·å–ä¹‹å‰å·²å®šä¹‰çš„å˜é‡
      const definedVars = VariableFlowAnalyzer.getDefinedVariablesBeforeAction(
        this.actions,
        index
      );

      // éªŒè¯åŠ¨ä½œé…ç½®
      const validationResult = VariableFlowAnalyzer.validateAction(
        action,
        index,
        definedVars
      );

      // æå–è¾“å…¥/è¾“å‡ºå˜é‡
      const inputVars = ActionConfigSummaryGenerator.extractInputVariables(action);
      const outputVar = ActionConfigSummaryGenerator.extractOutputVariable(action);

      // ç”Ÿæˆé…ç½®æ‘˜è¦
      const summary = ActionConfigSummaryGenerator.generate(action);
      Logger.info('MacroEditor', `Generated summary for action ${index}: ${summary}`);

      // ç”Ÿæˆç»“æ„åŒ–é…ç½®æ‘˜è¦
      const segments = ActionConfigSummaryGenerator.generateSegments(action);

      return ActionViewModelFactory.create(
        action,
        inputVars,
        outputVar,
        summary,
        validationResult.isValid,
        validationResult.errors,
        segments
      );
    });

    // ä½¿ç”¨æ–°æ•°ç»„æ›¿æ¢ä»¥è§¦å‘ @State å“åº”å¼æ›´æ–°
    this.actionViewModels = newViewModels;
    Logger.info('MacroEditor', `View models updated, new count: ${this.actionViewModels.length}`);
  }

  /**
   * ç»“æŸç¼–è¾‘
   */
  private finishEditing() {
    this.inlineEditingIndex = -1;
    this.inlineEditingField = '';
    this.inlineEditingValue = '';
  }

  /**
   * å¤„ç†å˜é‡ç‚¹å‡»ï¼Œåˆ‡æ¢é«˜äº®çŠ¶æ€æˆ–å¼€å§‹å†…è”ç¼–è¾‘
   */
  private handleVariableClick(varName: string, field?: string, actionIndex: number = -1): void {
    if (field && actionIndex >= 0) {
      // å¼€å§‹å†…è”ç¼–è¾‘
      this.inlineEditingIndex = actionIndex;
      this.inlineEditingField = field;
      this.inlineEditingValue = this.getActionFieldValue(actionIndex, field);
    } else if (this.highlightedVariable === varName) {
      // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é«˜äº®çš„å˜é‡ï¼Œå–æ¶ˆé«˜äº®
      this.highlightedVariable = '';
    } else {
      // å¦åˆ™é«˜äº®è¯¥å˜é‡
      this.highlightedVariable = varName;
    }
  }

  /**
   * å‡†å¤‡å¯ç”¨å˜é‡åˆ—è¡¨
   * @param actionIndex å½“å‰ç¼–è¾‘çš„åŠ¨ä½œç´¢å¼•
   */
  private prepareAvailableVariables(actionIndex: number) {
    this.availableVariablesForEditor = [];

    // 1. æ·»åŠ ç³»ç»Ÿå˜é‡
    const systemVars: VariableOption[] = [
      {
        name: 'date',
        displayName: '{date}',
        type: 'system',
        description: 'å½“å‰æ—¥æœŸ (YYYY-MM-DD)'
      },
      {
        name: 'time',
        displayName: '{time}',
        type: 'system',
        description: 'å½“å‰æ—¶é—´ (HH:mm:ss)'
      },
      {
        name: 'timestamp',
        displayName: '{timestamp}',
        type: 'system',
        description: 'å½“å‰æ—¶é—´æˆ³'
      },
      {
        name: 'clipboard',
        displayName: '{clipboard}',
        type: 'system',
        description: 'ç³»ç»Ÿå‰ªè´´æ¿å†…å®¹'
      },
      {
        name: 'network_type',
        displayName: '{network_type}',
        type: 'system',
        description: 'ç½‘ç»œç±»å‹ (wifi/mobile)'
      },
      {
        name: 'battery_level',
        displayName: '{battery_level}',
        type: 'system',
        description: 'ç”µæ± ç”µé‡ç™¾åˆ†æ¯”'
      }
    ];
    this.availableVariablesForEditor.push(...systemVars);

    // 2. æ·»åŠ ä¹‹å‰åŠ¨ä½œè¾“å‡ºçš„å˜é‡
    for (let i = 0; i < actionIndex; i++) {
      const outputVar = ActionConfigSummaryGenerator.extractOutputVariable(this.actions[i]);
      if (outputVar) {
        const summary = ActionConfigSummaryGenerator.generate(this.actions[i]);
        this.availableVariablesForEditor.push({
          name: outputVar,
          displayName: `{${outputVar}}`,
          type: 'runtime',
          description: `æ¥è‡ªåŠ¨ä½œ ${i + 1}: ${summary}`,
          sourceActionIndex: i
        });
      }
    }
  }

  /**
   * ç¼–è¾‘åŠ¨ä½œï¼ˆå±•å¼€/æ”¶èµ·ï¼‰
   */
  private handleEditAction(index: number) {
    Logger.info('MacroEditor', `Toggling action editor for index ${index}`);

    // å¦‚æœç‚¹å‡»çš„æ˜¯å·²ç»å±•å¼€çš„åŠ¨ä½œï¼Œåˆ™æ”¶èµ·
    if (this.expandedActionIndex === index) {
      this.expandedActionIndex = -1;
      this.editingAction = null;
      this.editingActionConfig = {};
      return;
    }

    // å…ˆç»“æŸå½“å‰çš„å†…è”ç¼–è¾‘
    this.finishEditing();

    // å‡†å¤‡å¯ç”¨å˜é‡
    this.prepareAvailableVariables(index);

    // è®¾ç½®ç¼–è¾‘çŠ¶æ€
    this.expandedActionIndex = index;

    // æ·±æ‹·è´åŠ¨ä½œå¯¹è±¡å’Œé…ç½®
    this.editingAction = JSON.parse(JSON.stringify(this.actions[index])) as Action;
    try {
      this.editingActionConfig = JSON.parse(this.editingAction.config);
    } catch (error) {
      this.editingActionConfig = {};
    }
    Logger.info('MacroEditor', `Editing action: ${JSON.stringify(this.editingAction)}`);
  }

  /**
   * å®æ—¶ä¿å­˜åŠ¨ä½œé…ç½®å­—æ®µ
   */
  private saveActionConfigField(key: string, value: Object) {
    if (this.editingAction && this.expandedActionIndex >= 0 && this.expandedActionIndex < this.actions.length) {
      // æ›´æ–°ç¼–è¾‘ä¸­çš„é…ç½®
      this.editingActionConfig[key] = value;

      // æ›´æ–°åŠ¨ä½œé…ç½®
      this.editingAction.config = JSON.stringify(this.editingActionConfig);

      // æ›´æ–°åŠ¨ä½œåˆ—è¡¨ - ä½¿ç”¨ slice() åˆ›å»ºæ–°æ•°ç»„ä»¥è§¦å‘å“åº”å¼æ›´æ–°
      const newActions: Action[] = this.actions.slice();
      newActions[this.expandedActionIndex] = JSON.parse(JSON.stringify(this.editingAction)) as Action;
      this.actions = newActions;

      // ä½¿ç”¨ setTimeout ç¡®ä¿ UI æ›´æ–°
      setTimeout(() => {
        this.updateActionViewModels();
      }, 10);
    }
  }

  /**
   * ä½¿ç”¨"å¿«å°çº¢"æµç¨‹æ¨¡æ¿
   * å¿«é€Ÿåˆ›å»ºå°çº¢ä¹¦å†…å®¹é‡‡é›†åˆ°é£ä¹¦çš„å®Œæ•´æµç¨‹
   */
  private applyKuaiXiaoHongTemplate() {
    promptAction.showDialog({
      title: 'ä½¿ç”¨å¿«å°çº¢æ¨¡æ¿',
      message: 'å°†è‡ªåŠ¨åˆ›å»ºï¼š\n1. æ‰‹åŠ¨è§¦å‘å™¨\n2. è¾“å…¥å†…å®¹ï¼ˆå¸¦ç²˜è´´æŒ‰é’®ï¼‰\n3. æ­£åˆ™æå– URL\n4. ç”¨æˆ·å¯¹è¯æ¡†ï¼ˆé€‰æ‹©çˆ†æ¬¾æ ‡è®°ï¼‰\n5. ç”¨æˆ·å¯¹è¯æ¡†ï¼ˆé€‰æ‹©åˆ†ç±»æ ‡ç­¾ï¼‰\n6. HTTP POST è¯·æ±‚\n7. æ‰“å¼€é£ä¹¦è¡¨æ ¼\n\næ˜¯å¦ç»§ç»­ï¼Ÿ',
      buttons: [
        { text: 'å–æ¶ˆ', color: '#000000' },
        { text: 'åˆ›å»º', color: '#007DFF' }
      ]
    }).then((result) => {
      if (result.index === 1) {
        this.createKuaiXiaoHongTemplate();
      }
    });
  }

  /**
   * åˆ›å»ºå¿«å°çº¢æµç¨‹æ¨¡æ¿
   * å‚è€ƒ docs/å¿«å°çº¢å®æµç¨‹å®Œæ•´è§£æ.md
   */
  private createKuaiXiaoHongTemplate() {
    // 1. æ·»åŠ æ‰‹åŠ¨è§¦å‘å™¨
    const manualTrigger: Trigger = {
      id: Date.now(),
      macroId: this.macroId,
      type: TriggerType.MANUAL,
      config: JSON.stringify({ methods: ['button', 'shortcut'] }),
      enabled: true
    };
    this.triggers.push(manualTrigger);

    // 1. è®¾ç½®å˜é‡ - é£ä¹¦å¤šç»´è¡¨æ ¼æˆæƒç 
    const setAuthCodeAction: Action = {
      id: Date.now() + 1,
      macroId: this.macroId,
      type: ActionType.SET_VARIABLE,
      config: JSON.stringify({
        variableName: 'é£ä¹¦å¤šç»´è¡¨æ ¼æˆæƒç ',
        value: '',
        scope: 'runtime'
      }),
      orderIndex: 0
    };
    this.actions.push(setAuthCodeAction);

    // 2. è®¾ç½®å˜é‡ - è®¢å•å·
    const setOrderIdAction: Action = {
      id: Date.now() + 2,
      macroId: this.macroId,
      type: ActionType.SET_VARIABLE,
      config: JSON.stringify({
        variableName: 'è®¢å•å·',
        value: '',
        scope: 'runtime'
      }),
      orderIndex: 1
    };
    this.actions.push(setOrderIdAction);

    // 3. å‘é€é€šçŸ¥ - å¯åŠ¨æç¤º
    const startNotificationAction: Action = {
      id: Date.now() + 3,
      macroId: this.macroId,
      type: ActionType.NOTIFICATION,
      config: JSON.stringify({
        title: 'å¼€å§‹é‡‡é›†',
        content: 'è¯·æŒ‰æç¤ºé€æ­¥æ“ä½œ',
        enableSound: false,
        enableVibration: false
      }),
      orderIndex: 2
    };
    this.actions.push(startNotificationAction);

    // 4. ç”¨æˆ·è¾“å…¥å¯¹è¯æ¡†ï¼ˆæ”¯æŒç²˜è´´ï¼‰
    const inputDialogAction: Action = {
      id: Date.now() + 4,
      macroId: this.macroId,
      type: ActionType.USER_DIALOG,
      config: JSON.stringify({
        type: 'text_input',
        title: 'ğŸ“‹ è¯·è¾“å…¥å°çº¢ä¹¦é“¾æ¥',
        message: 'å¯ç›´æ¥ç²˜è´´å‰ªè´´æ¿å†…å®¹',
        placeholder: 'åœ¨æ­¤ç²˜è´´é“¾æ¥æˆ–è¾“å…¥å†…å®¹...',
        saveToVariable: 'clipboard_content'
      }),
      orderIndex: 3
    };
    this.actions.push(inputDialogAction);

    // 5. æ­£åˆ™æå– URL
    const textProcessAction: Action = {
      id: Date.now() + 5,
      macroId: this.macroId,
      type: ActionType.TEXT_PROCESS,
      config: JSON.stringify({
        operation: 'regex_extract',
        input: '{clipboard_content}',
        pattern: 'https?://[^\\s]+',
        groupIndex: 0,
        saveToVariable: 'extracted_url'
      }),
      orderIndex: 4
    };
    this.actions.push(textProcessAction);

    // 6. ç”¨æˆ·å¯¹è¯æ¡† - é€‰æ‹©çˆ†æ¬¾æ ‡è®°
    const qualityDialogAction: Action = {
      id: Date.now() + 6,
      macroId: this.macroId,
      type: ActionType.USER_DIALOG,
      config: JSON.stringify({
        type: 'single_select',
        title: 'ğŸ”¥ è¯·æ ‡è®°å†…å®¹ç«çˆ†ç¨‹åº¦',
        message: 'è¯·é€‰æ‹©å†…å®¹çš„è´¨é‡ç­‰çº§',
        options: ['âšª æ™®é€šæ¬¾', 'ğŸŸ¡ æ½œåŠ›æ¬¾', 'ğŸ”´ å¤§çˆ†æ¬¾'],
        saveToVariable: 'quality'
      }),
      orderIndex: 5
    };
    this.actions.push(qualityDialogAction);

    // 7. ç”¨æˆ·å¯¹è¯æ¡† - é€‰æ‹©åˆ†ç±»æ ‡ç­¾ï¼ˆ40ä¸ªé€‰é¡¹ï¼‰
    const labelDialogAction: Action = {
      id: Date.now() + 7,
      macroId: this.macroId,
      type: ActionType.USER_DIALOG,
      config: JSON.stringify({
        type: 'single_select',
        title: 'ğŸ“‘ è¯·é€‰æ‹©åˆ†ç±»æ ‡ç­¾',
        message: 'ä¾¿äºåˆ†ç±»ç®¡ç†',
        options: [
          'ğŸ’„æ—¶å°šç¾å¦†', 'ğŸŒæ—…æ¸¸å‡ºè¡Œ', 'ğŸœç¾é£Ÿæ¶ˆè´¹', 'ğŸ“šå­¦ä¹ æ•™è‚²',
          'ğŸ’¹å•†ä¸šè´¢ç»', 'ğŸ’¼èŒåœº', 'ğŸ’´ç”Ÿç±³é¡¹ç›®', 'âœ¨åˆ›æ„çµæ„Ÿ',
          'ğŸ“å¹²è´§åˆ†äº«', 'âš™ï¸æ•ˆç‡å·¥å…·', 'ğŸæ–°å¥‡å¥½ç‰©', 'ğŸ å®¶å±…å®¶è£…',
          'ğŸ‘¶äº²å­æ¯å©´', 'ğŸ’–æƒ…æ„Ÿå¿ƒç†', 'ğŸ¥åŒ»ç–—å¥åº·', 'ğŸ“ºå½±è§†ç»¼è‰º',
          'ğŸµéŸ³ä¹', 'ğŸ“°æ—¶æ”¿ç¤¾ä¼š', 'ğŸ¨æ–‡å­¦è‰ºæœ¯', 'ğŸ›ï¸äººæ–‡å†å²',
          'ğŸ­æ‰è‰ºæŠ€èƒ½', 'ğŸ“±ç§‘æŠ€æ•°ç ', 'ğŸ“¸æ‘„å½±', 'ğŸ®æ¸¸æˆ',
          'ğŸš—æ±½è½¦', 'ğŸŒäºŒæ¬¡å…ƒ', 'ğŸ‹ï¸è¿åŠ¨å¥èº«', 'ğŸ”®æ˜Ÿåº§å‘½ç†',
          'ğŸ““ç”Ÿæ´»è®°å½•', 'ğŸ¯å…´è¶£çˆ±å¥½', 'â“å…¶ä»–', 'ğŸ¤–AI',
          'ğŸ å°çº¢ä¹¦', 'ğŸµæŠ–éŸ³', 'ğŸ’¬å¾®ä¿¡ç§åŸŸ', 'ğŸ“ºBç«™å¥½ç‰©',
          'ğŸ¥è§†é¢‘å·', 'ğŸª½é£ä¹¦æ‰£å­', 'â–¶ï¸YouTube', 'ğŸ“åœ¨çº¿è¯¾ç¨‹'
        ],
        saveToVariable: 'label'
      }),
      orderIndex: 6
    };
    this.actions.push(labelDialogAction);

    // 8. ç”¨æˆ·å¯¹è¯æ¡† - å¯¹æ ‡å‚è€ƒåº¦è¯„åˆ†
    const scoreDialogAction: Action = {
      id: Date.now() + 8,
      macroId: this.macroId,
      type: ActionType.USER_DIALOG,
      config: JSON.stringify({
        type: 'single_select',
        title: 'ğŸ‘ è¯·æ ‡è®°å¯¹æ ‡å‚è€ƒåº¦',
        message: '1-5èµï¼Œ0è¡¨ç¤ºè·³è¿‡',
        options: ['5 èµğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘', '4 èµğŸ‘ğŸ‘ğŸ‘ğŸ‘', '3 èµğŸ‘ğŸ‘ğŸ‘', '2 èµğŸ‘ğŸ‘', '1 èµğŸ‘', '0 å…ˆä¸é€‰ï¼Œè·³è¿‡'],
        saveToVariable: 'quality_score'
      }),
      orderIndex: 7
    };
    this.actions.push(scoreDialogAction);

    // 9. ç”¨æˆ·å¯¹è¯æ¡† - å¤‡æ³¨è¯´æ˜è¾“å…¥
    const notesDialogAction: Action = {
      id: Date.now() + 9,
      macroId: this.macroId,
      type: ActionType.USER_DIALOG,
      config: JSON.stringify({
        type: 'text_input',
        title: 'ğŸ“ è¯·è¾“å…¥æ”¶è—å¤‡æ³¨',
        message: 'ï¼ˆé€‰å¡«ï¼‰',
        placeholder: 'è¾“å…¥å¤‡æ³¨å†…å®¹...',
        saveToVariable: 'notes'
      }),
      orderIndex: 8
    };
    this.actions.push(notesDialogAction);

    // 10. å‘é€é€šçŸ¥ - ä¸Šä¼ è¿›åº¦
    const uploadNotificationAction: Action = {
      id: Date.now() + 10,
      macroId: this.macroId,
      type: ActionType.NOTIFICATION,
      config: JSON.stringify({
        title: 'æ•°æ®ä¸Šä¼ ä¸­',
        content: 'è¯·è€å¿ƒç­‰å¾…...',
        enableSound: false,
        enableVibration: false
      }),
      orderIndex: 9
    };
    this.actions.push(uploadNotificationAction);

     // 11. HTTP POST è¯·æ±‚ - è°ƒç”¨ Coze APIï¼ˆç¬”è®°é‡‡é›†å·¥ä½œæµï¼‰
    const headers: HttpHeaders = { 'Content-Type': 'application/json' };
    const httpAction: Action = {
      id: Date.now() + 11,
      macroId: this.macroId,
      type: ActionType.HTTP_REQUEST,
      config: JSON.stringify({
        method: 'POST',
        url: 'https://api.coze.cn/v1/workflow/run',
        headers: headers,
        body: '{"workflow_id":"7550495126771449906","parameters":{"url":"{extracted_url}","quality":"{quality_score}","read":"{quality}","notes":"{notes}","label":["{label}"],"xhscookie":"{é£ä¹¦å¤šç»´è¡¨æ ¼æˆæƒç }","order_id":"{è®¢å•å·}"}}',
        bodyType: 'json',
        timeout: 30000,
        parseResponse: true,
        saveResponseTo: 'api_response',
        saveParsedResponse: 'api_response_json',
        saveStatusCodeTo: 'api_status'
      }),
      orderIndex: 10
    };
    this.actions.push(httpAction);

    // 12. JSON å¤„ç† - æŸ¥è¯¢å“åº”ä¸­çš„æç¤ºè¯­ï¼ˆä½¿ç”¨ JSONPathï¼‰
    const extractPromptAction: Action = {
      id: Date.now() + 12,
      macroId: this.macroId,
      type: ActionType.JSON_PROCESS,
      config: JSON.stringify({
        operation: 'json_query',
        input: '{api_response_json}',
        queryPath: 'data.message',
        saveToVariable: 'result_message'
      }),
      orderIndex: 11
    };
    this.actions.push(extractPromptAction);

    // 13. å‘é€é€šçŸ¥ - æˆåŠŸæç¤ºï¼ˆæ˜¾ç¤ºçŠ¶æ€ç ï¼‰
    const successNotificationAction: Action = {
      id: Date.now() + 13,
      macroId: this.macroId,
      type: ActionType.NOTIFICATION,
      config: JSON.stringify({
        title: 'âœ… é‡‡é›†æˆåŠŸ',
        content: '{result_message}\nçŠ¶æ€ç : {api_status}',
        enableSound: true,
        enableVibration: true
      }),
      orderIndex: 12
    };
    this.actions.push(successNotificationAction);

    // 14. JSON å¤„ç† - æŸ¥è¯¢æ›´å¤šæ•°æ®ï¼ˆå¯é€‰ï¼Œå±•ç¤º JSONPath èƒ½åŠ›ï¼‰
    const queryMoreDataAction: Action = {
      id: Date.now() + 14,
      macroId: this.macroId,
      type: ActionType.JSON_PROCESS,
      config: JSON.stringify({
        operation: 'json_query',
        input: '{api_response_json}',
        queryPath: 'data',
        saveToVariable: 'api_data'
      }),
      orderIndex: 13
    };
    this.actions.push(queryMoreDataAction);

    // 15. æ‰“å¼€é£ä¹¦å¤šç»´è¡¨æ ¼
    const openUrlAction: Action = {
      id: Date.now() + 15,
      macroId: this.macroId,
      type: ActionType.OPEN_URL,
      config: JSON.stringify({
        url: 'https://applink.feishu.cn/client/docs/open?url=https://example.feishu.cn/base/xxx',
        openWith: 'browser'
      }),
      orderIndex: 14
    };
    this.actions.push(openUrlAction);

    // æ›´æ–°è§†å›¾æ¨¡å‹
    this.updateActionViewModels();

    promptAction.showDialog({
      title: 'å¿«å°çº¢æ¨¡æ¿åˆ›å»ºæˆåŠŸ',
      message: 'å·²åˆ›å»ºåŒ…å«15ä¸ªåŠ¨ä½œçš„å®Œæ•´é‡‡é›†æµç¨‹ã€‚\n\næµç¨‹åŒ…å«ï¼š\n1. è®¾ç½®å˜é‡ï¼ˆé£ä¹¦æˆæƒç ï¼‰\n2. è®¾ç½®å˜é‡ï¼ˆè®¢å•å·ï¼‰\n3-15. é‡‡é›†ã€é€‰æ‹©ã€ä¸Šä¼ æµç¨‹\n\nâœ¨ JSON åŠŸèƒ½å¢å¼ºï¼š\n- HTTP å“åº”è‡ªåŠ¨è§£æä¸º JSON å¯¹è±¡\n- ä½¿ç”¨ JSONPath æå– API è¿”å›æ•°æ®\n- å¯è®¿é—®åµŒå¥—å­—æ®µï¼š\n  â€¢ {api_response_json.data.message} - æå–æ¶ˆæ¯\n  â€¢ {api_response_json.data} - è·å–å®Œæ•´æ•°æ®å¯¹è±¡\n  â€¢ {api_status} - è·å– HTTP çŠ¶æ€ç \n\nâš ï¸ è¯·ç¼–è¾‘å‰2ä¸ª"è®¾ç½®å˜é‡"åŠ¨ä½œï¼Œå¡«å…¥å®é™…çš„é£ä¹¦æˆæƒç å’Œè®¢å•å·ã€‚',
      buttons: [
        { text: 'çŸ¥é“äº†', color: '#007DFF' }
      ]
    });
  }

  /**
   * æ·»åŠ è§¦å‘å™¨
   */
  private handleAddTrigger() {
    // æ˜¾ç¤ºè§¦å‘å™¨ç±»å‹é€‰æ‹©å¯¹è¯æ¡†
    promptAction.showDialog({
      title: 'é€‰æ‹©è§¦å‘å™¨ç±»å‹',
      message: 'è¯·é€‰æ‹©ä¸€ç§è§¦å‘å™¨ç±»å‹',
      buttons: [
        { text: 'å®šæ—¶è§¦å‘', color: '#000000' },
        { text: 'ç½‘ç»œçŠ¶æ€è§¦å‘', color: '#000000' },
        { text: 'æ‰‹åŠ¨è§¦å‘', color: '#000000' }
      ]
    }).then((result) => {
      switch (result.index) {
        case 0:
          this.showTimeTriggerDialog();
          break;
        case 1:
          this.showNetworkTriggerDialog();
          break;
        case 2:
          this.addManualTrigger();
          break;
      }
    });
  }

  /**
   * æ˜¾ç¤ºå®šæ—¶è§¦å‘å™¨é…ç½®å¯¹è¯æ¡†
   */
  private showTimeTriggerDialog() {
    promptAction.showDialog({
      title: 'é…ç½®å®šæ—¶è§¦å‘å™¨',
      message: 'è¯·é€‰æ‹©è§¦å‘æ¨¡å¼',
      buttons: [
        { text: 'æ¯æ—¥é‡å¤', color: '#000000' },
        { text: 'æ¯å‘¨é‡å¤', color: '#000000' },
        { text: 'è‡ªå®šä¹‰é—´éš”', color: '#000000' }
      ]
    }).then((result) => {
      let config: TimeTriggerConfig;

      switch (result.index) {
        case 0:
          // æ¯æ—¥é‡å¤ - ç®€åŒ–ç‰ˆï¼šå›ºå®šæ—¶é—´ 09:00
          config = {
            mode: 'daily',
            dailyTime: { hour: 9, minute: 0, second: 0 }
          };
          break;
        case 1:
          // æ¯å‘¨é‡å¤ - ç®€åŒ–ç‰ˆï¼šå‘¨ä¸€è‡³å‘¨äº” 09:00
          config = {
            mode: 'weekly',
            weeklyTime: { weekdays: [1, 2, 3, 4, 5], hour: 9, minute: 0, second: 0 }
          };
          break;
        case 2:
          // è‡ªå®šä¹‰é—´éš” - ç®€åŒ–ç‰ˆï¼š60åˆ†é’Ÿ
          config = {
            mode: 'interval',
            intervalTime: { intervalMinutes: 60 }
          };
          break;
        default:
          return;
      }

      // æ·»åŠ è§¦å‘å™¨åˆ°åˆ—è¡¨
      const trigger: Trigger = {
        id: Date.now(), // ä¸´æ—¶ ID
        macroId: this.macroId,
        type: TriggerType.TIME,
        config: JSON.stringify(config),
        enabled: true
      };
      this.triggers.push(trigger);
      promptAction.showToast({ message: 'å®šæ—¶è§¦å‘å™¨å·²æ·»åŠ ' });
    });
  }

  /**
   * æ˜¾ç¤ºç½‘ç»œçŠ¶æ€è§¦å‘å™¨é…ç½®å¯¹è¯æ¡†
   */
  private showNetworkTriggerDialog() {
    promptAction.showDialog({
      title: 'é…ç½®ç½‘ç»œçŠ¶æ€è§¦å‘å™¨',
      message: 'è¯·é€‰æ‹©è§¦å‘æ¡ä»¶',
      buttons: [
        { text: 'Wi-Fi è¿æ¥', color: '#000000' },
        { text: 'ç§»åŠ¨æ•°æ®è¿æ¥', color: '#000000' },
        { text: 'ç½‘ç»œæ–­å¼€', color: '#000000' }
      ]
    }).then((result) => {
      let triggerOn: 'wifi_connected' | 'mobile_connected' | 'network_disconnected';

      switch (result.index) {
        case 0:
          triggerOn = 'wifi_connected';
          break;
        case 1:
          triggerOn = 'mobile_connected';
          break;
        case 2:
          triggerOn = 'network_disconnected';
          break;
        default:
          return;
      }

      const config: NetworkTriggerConfig = { triggerOn };
      const trigger: Trigger = {
        id: Date.now(),
        macroId: this.macroId,
        type: TriggerType.NETWORK,
        config: JSON.stringify(config),
        enabled: true
      };
      this.triggers.push(trigger);
      promptAction.showToast({ message: 'ç½‘ç»œçŠ¶æ€è§¦å‘å™¨å·²æ·»åŠ ' });
    });
  }

  /**
   * æ·»åŠ æ‰‹åŠ¨è§¦å‘å™¨
   */
  private addManualTrigger() {
    const trigger: Trigger = {
      id: Date.now(),
      macroId: this.macroId,
      type: TriggerType.MANUAL,
      config: JSON.stringify({ methods: ['button', 'shortcut'] }),
      enabled: true
    };
    this.triggers.push(trigger);
    promptAction.showToast({ message: 'æ‰‹åŠ¨è§¦å‘å™¨å·²æ·»åŠ ' });
  }

  /**
   * åˆ é™¤è§¦å‘å™¨
   */
  private deleteTrigger(index: number) {
    this.triggers.splice(index, 1);
  }

  /**
   * æ·»åŠ åŠ¨ä½œ
   */
  private handleAddAction() {
    // æ˜¾ç¤ºåŠ¨ä½œç±»å‹é€‰æ‹©å¯¹è¯æ¡†
    promptAction.showDialog({
      title: 'é€‰æ‹©åŠ¨ä½œç±»å‹',
      message: 'è¯·é€‰æ‹©è¦æ·»åŠ çš„åŠ¨ä½œ',
      buttons: [
        { text: 'å¯åŠ¨åº”ç”¨', color: '#000000' },
        { text: 'å‘é€é€šçŸ¥', color: '#000000' },
        { text: 'è¯»å–å‰ªè´´æ¿', color: '#000000' },
        { text: 'å†™å…¥å‰ªè´´æ¿', color: '#000000' },
        { text: 'HTTP è¯·æ±‚', color: '#000000' },
        { text: 'æ‰“å¼€ URL', color: '#000000' },
        { text: 'æ–‡æœ¬å¤„ç†', color: '#000000' },
        { text: 'JSON å¤„ç†', color: '#000000' },
        { text: 'ç”¨æˆ·å¯¹è¯æ¡†', color: '#000000' },
        { text: 'è®¾ç½®å˜é‡', color: '#000000' },
        { text: 'æ¡ä»¶åˆ†æ”¯', color: '#000000' }
      ]
    }).then((result) => {
      switch (result.index) {
        case 0:
          this.addLaunchAppAction();
          break;
        case 1:
          this.addNotificationAction();
          break;
        case 2:
          this.addClipboardReadAction();
          break;
        case 3:
          this.addClipboardWriteAction();
          break;
        case 4:
          this.addHttpRequestAction();
          break;
        case 5:
          this.addOpenUrlAction();
          break;
        case 6:
          this.addTextProcessAction();
          break;
        case 7:
          this.addJsonProcessAction();
          break;
        case 8:
          this.addUserDialogAction();
          break;
        case 9:
          this.addSetVariableAction();
          break;
        case 10:
          this.addIfElseAction();
          break;
      }
    });
  }

  /**
   * æ·»åŠ å¯åŠ¨åº”ç”¨åŠ¨ä½œ
   */
  private addLaunchAppAction() {
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.LAUNCH_APP,
      config: JSON.stringify({
        bundleName: 'com.huawei.hmos.contacts',
        mode: 'explicit',
        abilityName: 'com.huawei.hmos.contacts.MainAbility',
        parameters: {} as Record<string, Object>
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * æ·»åŠ å‘é€é€šçŸ¥åŠ¨ä½œ
   */
  private addNotificationAction() {
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.NOTIFICATION,
      config: JSON.stringify({
        title: 'é€šçŸ¥æ ‡é¢˜',
        content: 'é€šçŸ¥å†…å®¹',
        enableSound: true,
        enableVibration: true
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * æ·»åŠ è¯»å–å‰ªè´´æ¿åŠ¨ä½œ
   */
  private addClipboardReadAction() {
    // è·å–å·²å­˜åœ¨çš„å˜é‡å
    const existingVars = VariableNameRecommender.extractExistingVariableNames(
      this.actions
    );

    // æ¨èå˜é‡å
    const recommendedName = VariableNameRecommender.recommendOutputVariableName(
      ActionType.CLIPBOARD_READ,
      existingVars
    );

    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.CLIPBOARD_READ,
      config: JSON.stringify({
        operation: 'read',
        saveToVariable: recommendedName
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * æ·»åŠ å†™å…¥å‰ªè´´æ¿åŠ¨ä½œ
   */
  private addClipboardWriteAction() {
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.CLIPBOARD_WRITE,
      config: JSON.stringify({
        operation: 'write',
        content: '{clipboard_content}'
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * æ·»åŠ  HTTP è¯·æ±‚åŠ¨ä½œ
   */
  private addHttpRequestAction() {
    // è·å–å·²å­˜åœ¨çš„å˜é‡å
    const existingVars = VariableNameRecommender.extractExistingVariableNames(
      this.actions
    );

    // æ¨èå˜é‡å
    const recommendedName = VariableNameRecommender.recommendOutputVariableName(
      ActionType.HTTP_REQUEST,
      existingVars
    );

    const headers: HttpHeaders = { 'Content-Type': 'application/json' };
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.HTTP_REQUEST,
      config: JSON.stringify({
        method: 'POST',
        url: 'https://example.com/api',
        headers: headers,
        body: '{}',
        bodyType: 'json',
        timeout: 30000,
        saveResponseTo: recommendedName
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * æ·»åŠ æ‰“å¼€ URL åŠ¨ä½œ
   */
  private addOpenUrlAction() {
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.OPEN_URL,
      config: JSON.stringify({
        url: 'https://example.com',
        openWith: 'browser'
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * æ·»åŠ æ–‡æœ¬å¤„ç†åŠ¨ä½œ
   */
  private addTextProcessAction() {
    // è·å–å·²å­˜åœ¨çš„å˜é‡å
    const existingVars = VariableNameRecommender.extractExistingVariableNames(
      this.actions
    );

    // è·å–å‰ä¸€ä¸ªåŠ¨ä½œç±»å‹ï¼ˆç”¨äºä¸Šä¸‹æ–‡æ¨èï¼‰
    const previousActionType = this.actions.length > 0 ?
      this.actions[this.actions.length - 1].type : undefined;

    // æ¨èå˜é‡åï¼ˆä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼‰
    const recommendedName = VariableNameRecommender.recommendContextualVariableName(
      ActionType.TEXT_PROCESS,
      'regex_extract',
      previousActionType,
      existingVars
    );

    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.TEXT_PROCESS,
      config: JSON.stringify({
        operation: 'regex_extract',
        input: '{clipboard_content}',
        pattern: 'https?://[^\\s]+',
        groupIndex: 0,
        saveToVariable: recommendedName
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * æ·»åŠ ç”¨æˆ·å¯¹è¯æ¡†åŠ¨ä½œ
   */
  private addUserDialogAction() {
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.USER_DIALOG,
      config: JSON.stringify({
        type: 'text_input',
        title: 'è¯·è¾“å…¥å†…å®¹',
        message: 'æè¿°ä¿¡æ¯',
        placeholder: 'åœ¨æ­¤è¾“å…¥...',
        saveToVariable: 'user_input'
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * æ·»åŠ è®¾ç½®å˜é‡åŠ¨ä½œ
   */
  private addSetVariableAction() {
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.SET_VARIABLE,
      config: JSON.stringify({
        variableName: 'my_variable',
        value: '',
        scope: 'runtime'
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * æ·»åŠ æ¡ä»¶åˆ†æ”¯åŠ¨ä½œ
   */
  private addIfElseAction() {
    // åˆ›å»ºä¸€ä¸ªç®€å•çš„ IF_ELSE æ¨¡æ¿
    // å®šä¹‰åˆ†æ”¯é…ç½®çš„ç±»å‹
    interface Condition {
      field: string;
      operator: string;
      value: string;
    }

    interface NotificationConfig {
      title: string;
      content: string;
      enableSound: boolean;
      enableVibration: boolean;
    }

    interface ActionWithConfig {
      type: string;
      config: NotificationConfig;
    }

    interface IfElseBranchConfig {
      name: string;
      conditions: Condition[];
      actions: ActionWithConfig[];
    }

    const branches: IfElseBranchConfig[] = [
      {
        name: 'åˆ†æ”¯1',
        conditions: [
          {
            field: '{variable_name}',
            operator: '==',
            value: 'value1'
          }
        ],
        actions: [
          {
            type: 'notification',
            config: {
              title: 'åˆ†æ”¯1æ‰§è¡Œ',
              content: 'æ¡ä»¶æ»¡è¶³æ—¶æ‰§è¡Œæ­¤åˆ†æ”¯',
              enableSound: false,
              enableVibration: false
            }
          }
        ]
      },
      {
        name: 'elseåˆ†æ”¯',
        conditions: [],  // ç©ºæ¡ä»¶è¡¨ç¤º else
        actions: [
          {
            type: 'notification',
            config: {
              title: 'elseåˆ†æ”¯æ‰§è¡Œ',
              content: 'æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³æ—¶æ‰§è¡Œæ­¤åˆ†æ”¯',
              enableSound: false,
              enableVibration: false
            }
          }
        ]
      }
    ];

    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.IF_ELSE,
      config: JSON.stringify({ branches: branches }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * æ·»åŠ  JSON å¤„ç†åŠ¨ä½œ
   */
  private addJsonProcessAction() {
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.JSON_PROCESS,
      config: JSON.stringify({
        operation: 'json_query',
        input: '{api_response}',
        queryPath: 'data.message',
        saveToVariable: 'extracted_field'
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels();
    setTimeout(() => {
      this.handleEditAction(this.actions.length - 1);
    }, 10);
  }

  /**
   * åˆ é™¤åŠ¨ä½œ
   */
  private deleteAction(index: number) {
    // æ£€æŸ¥æ˜¯å¦ä¼šå½±å“å…¶ä»–åŠ¨ä½œ
    const affectedIndices = VariableFlowAnalyzer.getAffectedActionsByDeletion(
      this.actions,
      index
    );

    if (affectedIndices.length > 0) {
      const affectedActions = affectedIndices.map(i => `åŠ¨ä½œ ${i + 1}`).join('ã€');
      promptAction.showDialog({
        title: 'è­¦å‘Š',
        message: `åˆ é™¤æ­¤åŠ¨ä½œä¼šå½±å“ ${affectedActions}ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`,
        buttons: [
          { text: 'å–æ¶ˆ', color: '#000000' },
          { text: 'åˆ é™¤', color: '#ff4d4f' }
        ]
      }).then((result) => {
        if (result.index === 1) {
          this.actions.splice(index, 1);
          // é‡æ–°è°ƒæ•´ orderIndex
          this.actions.forEach((action, idx) => {
            action.orderIndex = idx;
          });
          this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
        }
      });
    } else {
      this.actions.splice(index, 1);
      // é‡æ–°è°ƒæ•´ orderIndex
      this.actions.forEach((action, idx) => {
        action.orderIndex = idx;
      });
      this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    }
  }

  /**
   * ä¸Šç§»åŠ¨ä½œ
   */
  private moveActionUp(index: number) {
    if (index > 0) {
      const temp = this.actions[index];
      this.actions[index] = this.actions[index - 1];
      this.actions[index - 1] = temp;
      // æ›´æ–° orderIndex
      this.actions.forEach((action, idx) => {
        action.orderIndex = idx;
      });
      this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    }
  }

  /**
   * ä¸‹ç§»åŠ¨ä½œ
   */
  private moveActionDown(index: number) {
    if (index < this.actions.length - 1) {
      const temp = this.actions[index];
      this.actions[index] = this.actions[index + 1];
      this.actions[index + 1] = temp;
      // æ›´æ–° orderIndex
      this.actions.forEach((action, idx) => {
        action.orderIndex = idx;
      });
      this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    }
  }

  /**
   * è·å–è§¦å‘å™¨æè¿°
   */
  private getTriggerDescription(trigger: Trigger): string {
    if (trigger.type === TriggerType.TIME) {
      const config = JSON.parse(trigger.config) as TimeTriggerConfig;
      switch (config.mode) {
        case 'daily':
          return `æ¯æ—¥ ${config.dailyTime?.hour || 0}:${String(config.dailyTime?.minute || 0).padStart(2, '0')}`;
        case 'weekly':
          return `æ¯å‘¨é‡å¤`;
        case 'interval':
          return `æ¯ ${config.intervalTime?.intervalMinutes || 0} åˆ†é’Ÿ`;
        default:
          return 'å®šæ—¶è§¦å‘';
      }
    } else if (trigger.type === TriggerType.NETWORK) {
      const config = JSON.parse(trigger.config) as NetworkTriggerConfig;
      const triggerNames: Record<string, string> = {
        'wifi_connected': 'Wi-Fi è¿æ¥æ—¶',
        'mobile_connected': 'ç§»åŠ¨æ•°æ®è¿æ¥æ—¶',
        'network_disconnected': 'ç½‘ç»œæ–­å¼€æ—¶'
      };
      return triggerNames[config.triggerOn] || 'ç½‘ç»œçŠ¶æ€è§¦å‘';
    } else if (trigger.type === TriggerType.MANUAL) {
      return 'æ‰‹åŠ¨è§¦å‘';
    }
    return trigger.type;
  }

  /**
   * è·å–åŠ¨ä½œæ˜¾ç¤ºåç§°
   */
  private getActionDisplayName(viewModel: ActionViewModel): string {
    return ActionTypes.getDisplayName(viewModel.type);
  }

  /**
   * æ„å»ºå†…è”é…ç½®è¡¨å•
   */
  @Builder
  buildActionConfigForm() {
    if (this.editingAction) {
      Column({ space: 0 }) {
        Divider()

        Column({ space: 16 }) {
          if (this.editingAction.type === ActionType.NOTIFICATION) {
            this.buildNotificationFormInline();
          } else if (this.editingAction.type === ActionType.TEXT_PROCESS) {
            this.buildTextProcessFormInline();
          } else if (this.editingAction.type === ActionType.HTTP_REQUEST) {
            this.buildHttpRequestFormInline();
          } else if (this.editingAction.type === ActionType.USER_DIALOG) {
            this.buildUserDialogFormInline();
          } else if (this.editingAction.type === ActionType.OPEN_URL) {
            this.buildOpenUrlFormInline();
          } else if (this.editingAction.type === ActionType.LAUNCH_APP) {
            this.buildLaunchAppFormInline();
          } else if (this.editingAction.type === ActionType.CLIPBOARD_READ || this.editingAction.type === ActionType.CLIPBOARD_WRITE) {
            this.buildClipboardFormInline();
          } else if (this.editingAction.type === ActionType.SET_VARIABLE) {
            this.buildSetVariableFormInline();
          } else if (this.editingAction.type === ActionType.IF_ELSE) {
            this.buildIfElseFormInline();
          } else if (this.editingAction.type === ActionType.JSON_PROCESS) {
            this.buildJsonProcessFormInline();
          } else {
            Text('æš‚ä¸æ”¯æŒæ­¤åŠ¨ä½œç±»å‹çš„é…ç½®')
              .fontSize(14)
              .fontColor('#999999')
              .textAlign(TextAlign.Center)
              .padding(20);
          }
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#F8F8F8')
        .borderRadius({ bottomLeft: 12, bottomRight: 12 })
      }
      .width('100%')
    }
  }

  @Builder
  buildNotificationFormInline() {
    Column({ space: 12 }) {
      Column({ space: 6 }) {
        Text('é€šçŸ¥æ ‡é¢˜')
          .fontSize(13)
          .fontColor('#666666')

        TextInput({ text: this.editingActionConfig['title'] as string })
          .fontSize(14)
          .onChange((value: string) => {
            this.saveActionConfigField('title', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      Column({ space: 6 }) {
        Text('é€šçŸ¥å†…å®¹')
          .fontSize(13)
          .fontColor('#666666')

        TextArea({ text: this.editingActionConfig['content'] as string })
          .fontSize(14)
          .height(60)
          .onChange((value: string) => {
            this.saveActionConfigField('content', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      Row({ space: 16 }) {
        Row({ space: 6 }) {
          Checkbox({ name: 'sound', group: 'notification' })
            .select(this.editingActionConfig['enableSound'] as boolean)
            .onChange((value: boolean) => {
              this.saveActionConfigField('enableSound', value);
            })
          Text('å£°éŸ³')
            .fontSize(14)
        }

        Row({ space: 6 }) {
          Checkbox({ name: 'vibration', group: 'notification' })
            .select(this.editingActionConfig['enableVibration'] as boolean)
            .onChange((value: boolean) => {
              this.saveActionConfigField('enableVibration', value);
            })
          Text('éœ‡åŠ¨')
            .fontSize(14)
        }
      }
    }
    .width('100%')
  }

  @Builder
  buildOpenUrlFormInline() {
    Column({ space: 12 }) {
      Column({ space: 6 }) {
        Text('URL')
          .fontSize(13)
          .fontColor('#666666')

        TextInput({ text: this.editingActionConfig['url'] as string })
          .fontSize(14)
          .onChange((value: string) => {
            this.saveActionConfigField('url', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')
    }
    .width('100%')
  }

  @Builder
  buildClipboardFormInline() {
    Column({ space: 12 }) {
      Column({ space: 6 }) {
        Text('æ“ä½œç±»å‹')
          .fontSize(13)
          .fontColor('#666666')

        Row({ space: 8 }) {
          Button('è¯»å–')
            .fontSize(13)
            .height(32)
            .backgroundColor((this.editingActionConfig['operation'] as string || 'read') === 'read' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['operation'] as string || 'read') === 'read' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('operation', 'read');
            })

          Button('å†™å…¥')
            .fontSize(13)
            .height(32)
            .backgroundColor((this.editingActionConfig['operation'] as string || 'read') === 'write' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['operation'] as string || 'read') === 'write' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('operation', 'write');
            })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      if ((this.editingActionConfig['operation'] as string || 'read') === 'read') {
        Column({ space: 6 }) {
          Text('ä¿å­˜åˆ°å˜é‡')
            .fontSize(13)
            .fontColor('#666666')

          TextInput({ text: this.editingActionConfig['saveToVariable'] as string })
            .fontSize(14)
            .onChange((value: string) => {
              this.saveActionConfigField('saveToVariable', value);
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
      }

      if ((this.editingActionConfig['operation'] as string || 'read') === 'write') {
        Column({ space: 6 }) {
          Text('å†™å…¥å†…å®¹')
            .fontSize(13)
            .fontColor('#666666')

          TextArea({ text: this.editingActionConfig['content'] as string })
            .fontSize(14)
            .height(60)
            .onChange((value: string) => {
              this.saveActionConfigField('content', value);
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
      }
    }
    .width('100%')
  }

  @Builder
  buildSetVariableFormInline() {
    Column({ space: 12 }) {
      Column({ space: 6 }) {
        Text('å˜é‡å')
          .fontSize(13)
          .fontColor('#666666')

        TextInput({ text: this.editingActionConfig['variableName'] as string })
          .fontSize(14)
          .onChange((value: string) => {
            this.saveActionConfigField('variableName', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      Column({ space: 6 }) {
        Text('å˜é‡å€¼')
          .fontSize(13)
          .fontColor('#666666')

        TextArea({ text: this.editingActionConfig['value'] as string })
          .fontSize(14)
          .height(60)
          .onChange((value: string) => {
            this.saveActionConfigField('value', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')
    }
    .width('100%')
  }

  @Builder
  buildJsonProcessFormInline() {
    Column({ space: 12 }) {
      Column({ space: 6 }) {
        Text('æ“ä½œç±»å‹')
          .fontSize(13)
          .fontColor('#666666')

        Row({ space: 8 }) {
          Button('JSONæŸ¥è¯¢')
            .fontSize(13)
            .height(32)
            .backgroundColor((this.editingActionConfig['operation'] as string || 'json_query') === 'json_query' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['operation'] as string || 'json_query') === 'json_query' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('operation', 'json_query');
            })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      if ((this.editingActionConfig['operation'] as string || 'json_query') === 'json_query') {
        Column({ space: 6 }) {
          Text('è¾“å…¥æ¥æº')
            .fontSize(13)
            .fontColor('#666666')

          TextInput({ text: this.editingActionConfig['input'] as string })
            .fontSize(14)
            .onChange((value: string) => {
              this.saveActionConfigField('input', value);
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')

        Column({ space: 6 }) {
          Text('JSONPathæŸ¥è¯¢')
            .fontSize(13)
            .fontColor('#666666')

          TextInput({ text: this.editingActionConfig['queryPath'] as string })
            .fontSize(14)
            .onChange((value: string) => {
              this.saveActionConfigField('queryPath', value);
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')

        Column({ space: 6 }) {
          Text('ä¿å­˜åˆ°å˜é‡')
            .fontSize(13)
            .fontColor('#666666')

          TextInput({ text: this.editingActionConfig['saveToVariable'] as string })
            .fontSize(14)
            .onChange((value: string) => {
              this.saveActionConfigField('saveToVariable', value);
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
      }
    }
    .width('100%')
  }

  @Builder
  buildTextProcessFormInline() {
    Column({ space: 12 }) {
      Column({ space: 6 }) {
        Text('æ“ä½œç±»å‹')
          .fontSize(13)
          .fontColor('#666666')

        Row({ space: 6 }) {
          Button('æ­£åˆ™æå–')
            .fontSize(12)
            .height(32)
            .backgroundColor((this.editingActionConfig['operation'] as string || 'regex_extract') === 'regex_extract' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['operation'] as string || 'regex_extract') === 'regex_extract' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('operation', 'regex_extract');
            })

          Button('æ›¿æ¢')
            .fontSize(12)
            .height(32)
            .backgroundColor((this.editingActionConfig['operation'] as string || 'regex_extract') === 'replace' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['operation'] as string || 'regex_extract') === 'replace' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('operation', 'replace');
            })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      Column({ space: 6 }) {
        Text('è¾“å…¥æ¥æº')
          .fontSize(13)
          .fontColor('#666666')

        TextInput({ text: this.editingActionConfig['input'] as string })
          .fontSize(14)
          .onChange((value: string) => {
            this.saveActionConfigField('input', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      if ((this.editingActionConfig['operation'] as string || 'regex_extract') === 'regex_extract') {
        Column({ space: 6 }) {
          Text('æ­£åˆ™è¡¨è¾¾å¼')
            .fontSize(13)
            .fontColor('#666666')

          TextInput({ text: this.editingActionConfig['pattern'] as string })
            .fontSize(14)
            .onChange((value: string) => {
              this.saveActionConfigField('pattern', value);
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
      }

      Column({ space: 6 }) {
        Text('ä¿å­˜åˆ°å˜é‡')
          .fontSize(13)
          .fontColor('#666666')

        TextInput({ text: this.editingActionConfig['saveToVariable'] as string })
          .fontSize(14)
          .onChange((value: string) => {
            this.saveActionConfigField('saveToVariable', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')
    }
    .width('100%')
  }

  @Builder
  buildHttpRequestFormInline() {
    Column({ space: 12 }) {
      Column({ space: 6 }) {
        Text('è¯·æ±‚æ–¹æ³•')
          .fontSize(13)
          .fontColor('#666666')

        Row({ space: 6 }) {
          Button('GET')
            .fontSize(12)
            .height(32)
            .backgroundColor(this.editingActionConfig['method'] === 'GET' ? '#007DFF' : '#F2F2F7')
            .fontColor(this.editingActionConfig['method'] === 'GET' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('method', 'GET');
            })

          Button('POST')
            .fontSize(12)
            .height(32)
            .backgroundColor(this.editingActionConfig['method'] === 'POST' ? '#007DFF' : '#F2F2F7')
            .fontColor(this.editingActionConfig['method'] === 'POST' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('method', 'POST');
            })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      Column({ space: 6 }) {
        Text('URL')
          .fontSize(13)
          .fontColor('#666666')

        TextInput({ text: this.editingActionConfig['url'] as string })
          .fontSize(14)
          .onChange((value: string) => {
            this.saveActionConfigField('url', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      if (this.editingActionConfig['method'] === 'POST') {
        Column({ space: 6 }) {
          Text('è¯·æ±‚ä½“')
            .fontSize(13)
            .fontColor('#666666')

          TextArea({ text: this.editingActionConfig['body'] as string })
            .fontSize(14)
            .height(80)
            .onChange((value: string) => {
              this.saveActionConfigField('body', value);
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
      }

      Column({ space: 6 }) {
        Text('ä¿å­˜å“åº”åˆ°å˜é‡')
          .fontSize(13)
          .fontColor('#666666')

        TextInput({ text: this.editingActionConfig['saveResponseTo'] as string })
          .fontSize(14)
          .onChange((value: string) => {
            this.saveActionConfigField('saveResponseTo', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')
    }
    .width('100%')
  }

  @Builder
  buildUserDialogFormInline() {
    Column({ space: 12 }) {
      Column({ space: 6 }) {
        Text('å¯¹è¯æ¡†ç±»å‹')
          .fontSize(13)
          .fontColor('#666666')

        Row({ space: 6 }) {
          Button('æ–‡æœ¬è¾“å…¥')
            .fontSize(12)
            .height(32)
            .backgroundColor((this.editingActionConfig['type'] as string || 'text_input') === 'text_input' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['type'] as string || 'text_input') === 'text_input' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('type', 'text_input');
            })

          Button('ç¡®è®¤å¯¹è¯æ¡†')
            .fontSize(12)
            .height(32)
            .backgroundColor((this.editingActionConfig['type'] as string || 'text_input') === 'confirm' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['type'] as string || 'text_input') === 'confirm' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('type', 'confirm');
            })

          Button('å•é€‰')
            .fontSize(12)
            .height(32)
            .backgroundColor((this.editingActionConfig['type'] as string || 'text_input') === 'single_select' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['type'] as string || 'text_input') === 'single_select' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('type', 'single_select');
            })

          Button('å¤šé€‰')
            .fontSize(12)
            .height(32)
            .backgroundColor((this.editingActionConfig['type'] as string || 'text_input') === 'multi_select' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['type'] as string || 'text_input') === 'multi_select' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('type', 'multi_select');
            })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      Column({ space: 6 }) {
        Text('æ ‡é¢˜')
          .fontSize(13)
          .fontColor('#666666')

        TextInput({ text: this.editingActionConfig['title'] as string })
          .fontSize(14)
          .onChange((value: string) => {
            this.saveActionConfigField('title', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      if ((this.editingActionConfig['type'] as string || 'text_input') === 'single_select' || (this.editingActionConfig['type'] as string || 'text_input') === 'multi_select') {
        Column({ space: 6 }) {
          Text('é€‰é¡¹ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰')
            .fontSize(13)
            .fontColor('#666666')

          TextArea({
            text: this.editingActionConfig['options'] ? (this.editingActionConfig['options'] as string[]).join('\n') : ''
          })
            .fontSize(14)
            .height(80)
            .onChange((value: string) => {
              this.saveActionConfigField('options', value.split('\n').filter(line => line.trim().length > 0));
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
      }

      Column({ space: 6 }) {
        Text('ä¿å­˜åˆ°å˜é‡')
          .fontSize(13)
          .fontColor('#666666')

        TextInput({ text: this.editingActionConfig['saveToVariable'] as string })
          .fontSize(14)
          .onChange((value: string) => {
            this.saveActionConfigField('saveToVariable', value);
          })
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')
    }
    .width('100%')
  }

  @Builder
  buildLaunchAppFormInline() {
    Column({ space: 12 }) {
      Column({ space: 6 }) {
        Text('å¯åŠ¨æ¨¡å¼')
          .fontSize(13)
          .fontColor('#666666')

        Row({ space: 6 }) {
          Button('æ˜¾å¼')
            .fontSize(12)
            .height(32)
            .backgroundColor((this.editingActionConfig['mode'] as string || 'explicit') === 'explicit' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['mode'] as string || 'explicit') === 'explicit' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('mode', 'explicit');
            })

          Button('éšå¼')
            .fontSize(12)
            .height(32)
            .backgroundColor((this.editingActionConfig['mode'] as string || 'explicit') === 'implicit' ? '#007DFF' : '#F2F2F7')
            .fontColor((this.editingActionConfig['mode'] as string || 'explicit') === 'implicit' ? '#FFFFFF' : '#1A1A1A')
            .onClick(() => {
              this.saveActionConfigField('mode', 'implicit');
            })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      if ((this.editingActionConfig['mode'] as string || 'explicit') === 'explicit') {
        Column({ space: 6 }) {
          Text('åº”ç”¨åŒ…å')
            .fontSize(13)
            .fontColor('#666666')

          TextInput({ text: this.editingActionConfig['bundleName'] as string })
            .fontSize(14)
            .onChange((value: string) => {
              this.saveActionConfigField('bundleName', value);
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')

        Column({ space: 6 }) {
          Text('ç»„ä»¶å')
            .fontSize(13)
            .fontColor('#666666')

          TextInput({ text: this.editingActionConfig['abilityName'] as string })
            .fontSize(14)
            .onChange((value: string) => {
              this.saveActionConfigField('abilityName', value);
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
      }

      if ((this.editingActionConfig['mode'] as string || 'explicit') === 'implicit') {
        Column({ space: 6 }) {
          Text('URI')
            .fontSize(13)
            .fontColor('#666666')

          TextInput({ text: this.editingActionConfig['uri'] as string })
            .fontSize(14)
            .onChange((value: string) => {
              this.saveActionConfigField('uri', value);
            })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
      }
    }
    .width('100%')
  }

  @Builder
  buildIfElseFormInline() {
    Column({ space: 12 }) {
      Text('æ¡ä»¶åˆ†æ”¯åŠŸèƒ½è¾ƒå¤æ‚ï¼Œå»ºè®®åœ¨æ¡Œé¢ç«¯ç¼–è¾‘å™¨ä¸­é…ç½®')
        .fontSize(13)
        .fontColor('#999999')
        .textAlign(TextAlign.Center)
        .padding(20)
    }
    .width('100%')
  }

  /**
   * è·å–åŠ¨ä½œæè¿°
   */
  private getActionDescription(action: Action): string {
    const actionNames: Record<string, string> = {
      'notification': 'å‘é€é€šçŸ¥',
      'clipboard_read': 'è¯»å–å‰ªè´´æ¿',
      'clipboard_write': 'å†™å…¥å‰ªè´´æ¿',
      'http_request': 'HTTP è¯·æ±‚',
      'open_url': 'æ‰“å¼€ URL',
      'text_process': 'æ–‡æœ¬å¤„ç†',
      'launch_app': 'å¯åŠ¨åº”ç”¨',
      'user_dialog': 'ç”¨æˆ·å¯¹è¯æ¡†',
      'set_variable': 'è®¾ç½®å˜é‡',
      'if_else': 'æ¡ä»¶åˆ†æ”¯',
      'json_process': 'JSON å¤„ç†'
    };
    const name: string = actionNames[action.type] || action.type;
    return name;
  }

  @Builder
  SettingsPanelBuilder() {
    Column() {
      Column() {
        Row() {
          Text('è®¾ç½®')
            .fontSize(17)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .flexGrow(1)

          Button() {
            SymbolGlyph($r('sys.symbol.xmark'))
              .fontSize(20)
              .fontColor(['#8E8E93'])
          }
          .width(36)
          .height(36)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showSettings = false;
          })
        }
        .width('100%')
        .margin({ bottom: 16 })

        Scroll() {
          Column({ space: 16 }) {
            Column({ space: 12 }) {
              Text('åŸºæœ¬ä¿¡æ¯')
                .fontSize(13)
                .fontColor('#8E8E93')
                .width('100%')

              Column({ space: 8 }) {
                Text('å®åç§°')
                  .fontSize(15)
                  .fontColor('#1A1A1A')

                TextInput({ placeholder: 'è¯·è¾“å…¥å®åç§°', text: this.macroName })
                  .fontSize(16)
                  .backgroundColor('#F2F2F7')
                  .borderRadius(10)
                  .onChange((value: string) => {
                    this.macroName = value;
                  })
              }
              .alignItems(HorizontalAlign.Start)
              .width('100%')

              Column({ space: 8 }) {
                Text('æè¿°')
                  .fontSize(15)
                  .fontColor('#1A1A1A')

                TextArea({ placeholder: 'è¯·è¾“å…¥å®æè¿°', text: this.macroDescription })
                  .fontSize(16)
                  .height(80)
                  .backgroundColor('#F2F2F7')
                  .borderRadius(10)
                  .onChange((value: string) => {
                    this.macroDescription = value;
                  })
              }
              .alignItems(HorizontalAlign.Start)
              .width('100%')
            }
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)

            Column({ space: 12 }) {
              Row() {
                Text('è§¦å‘å™¨')
                  .fontSize(13)
                  .fontColor('#8E8E93')
                  .flexGrow(1)

                Text('+ æ·»åŠ ')
                  .fontSize(15)
                  .fontColor('#007AFF')
                  .onClick(() => {
                    this.handleAddTrigger();
                  })
              }
              .width('100%')

              if (this.triggers.length === 0) {
                Text('æš‚æ— è§¦å‘å™¨')
                  .fontSize(15)
                  .fontColor('#8E8E93')
                  .width('100%')
                  .textAlign(TextAlign.Center)
                  .padding(20)
              } else {
                Column({ space: 8 }) {
                  ForEach(this.triggers, (trigger: Trigger, index: number) => {
                    Row({ space: 12 }) {
                      Column({ space: 4 }) {
                        Text(this.getTriggerDescription(trigger))
                          .fontSize(16)
                          .fontWeight(FontWeight.Medium)
                          .fontColor('#1A1A1A')

                        Text(trigger.type)
                          .fontSize(12)
                          .fontColor('#8E8E93')
                      }
                      .flexGrow(1)
                      .alignItems(HorizontalAlign.Start)

                      Button() {
                        SymbolGlyph($r('sys.symbol.trash'))
                          .fontSize(16)
                          .fontColor(['#FF3B30'])
                      }
                      .width(32)
                      .height(32)
                      .backgroundColor(Color.Transparent)
                      .onClick(() => {
                        this.deleteTrigger(index);
                      })
                    }
                    .width('100%')
                    .padding(12)
                    .backgroundColor('#F2F2F7')
                    .borderRadius(10)
                  }, (trigger: Trigger, index: number) => index.toString())
                }
                .width('100%')
              }
            }
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)

            Column({ space: 12 }) {
              Text('å¿«é€Ÿå¼€å§‹')
                .fontSize(13)
                .fontColor('#8E8E93')
                .width('100%')

              Button() {
                Row({ space: 12 }) {
                  Text('ğŸ“±')
                    .fontSize(24)

                  Column({ space: 4 }) {
                    Text('å¿«å°çº¢æµç¨‹')
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#1A1A1A')

                    Text('å°çº¢ä¹¦å†…å®¹é‡‡é›†åˆ°é£ä¹¦')
                      .fontSize(12)
                      .fontColor('#8E8E93')
                  }
                  .alignItems(HorizontalAlign.Start)
                  .flexGrow(1)

                  SymbolGlyph($r('sys.symbol.chevron_right'))
                    .fontSize(16)
                    .fontColor(['#C7C7CC'])
                }
                .width('100%')
                .padding(12)
              }
              .width('100%')
              .backgroundColor('#F0F9FF')
              .borderRadius(10)
              .onClick(() => {
                this.applyKuaiXiaoHongTemplate();
              })
            }
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
          }
          .width('100%')
        }
        .layoutWeight(1)
        .width('100%')
      }
      .width(320)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .padding(24)
      .shadow({
        radius: 24,
        color: '#30000000',
        offsetX: 0,
        offsetY: 8
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#66000000')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.showSettings = false;
    })
    .zIndex(3)
  }

  @Builder
  ActionDrawerBuilder() {
    Column() {
      Column() {
        Row() {
          Row()
            .width(36)
            .height(5)
            .backgroundColor('#C7C7CC')
            .borderRadius(3)
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ top: 8, bottom: 16 })

        Row() {
          Text('æ·»åŠ åŠ¨ä½œ')
            .fontSize(17)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .flexGrow(1)

          Button() {
            SymbolGlyph($r('sys.symbol.xmark'))
              .fontSize(20)
              .fontColor(['#8E8E93'])
          }
          .width(36)
          .height(36)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showActionDrawer = false;
          })
        }
        .width('100%')
        .margin({ bottom: 16 })

        Row({ space: 8 }) {
          SymbolGlyph($r('sys.symbol.magnifyingglass'))
            .fontSize(16)
            .fontColor(['#8E8E93'])

          TextInput({ placeholder: 'æœç´¢ App å’Œæ“ä½œ', text: this.actionSearchText })
            .fontSize(16)
            .backgroundColor(Color.Transparent)
            .border({ width: 0 })
            .layoutWeight(1)
            .onChange((value: string) => {
              this.actionSearchText = value;
            })
        }
        .width('100%')
        .padding({ left: 12, right: 12, top: 10, bottom: 10 })
        .backgroundColor('#F2F2F7')
        .borderRadius(10)
        .margin({ bottom: 16 })

        Row({ space: 8 }) {
          Button('å…¨éƒ¨')
            .fontSize(14)
            .fontWeight(this.selectedActionCategory === 'all' ? FontWeight.Medium : FontWeight.Normal)
            .fontColor(this.selectedActionCategory === 'all' ? '#FFFFFF' : '#007AFF')
            .backgroundColor(this.selectedActionCategory === 'all' ? '#007AFF' : '#F2F2F7')
            .borderRadius(20)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .onClick(() => {
              this.selectedActionCategory = 'all';
            })

          Button('æ–‡æœ¬')
            .fontSize(14)
            .fontWeight(this.selectedActionCategory === 'text' ? FontWeight.Medium : FontWeight.Normal)
            .fontColor(this.selectedActionCategory === 'text' ? '#FFFFFF' : '#FF9500')
            .backgroundColor(this.selectedActionCategory === 'text' ? '#FF9500' : '#F2F2F7')
            .borderRadius(20)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .onClick(() => {
              this.selectedActionCategory = 'text';
            })

          Button('ç½‘ç»œ')
            .fontSize(14)
            .fontWeight(this.selectedActionCategory === 'network' ? FontWeight.Medium : FontWeight.Normal)
            .fontColor(this.selectedActionCategory === 'network' ? '#FFFFFF' : '#34C759')
            .backgroundColor(this.selectedActionCategory === 'network' ? '#34C759' : '#F2F2F7')
            .borderRadius(20)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .onClick(() => {
              this.selectedActionCategory = 'network';
            })

          Button('ç³»ç»Ÿ')
            .fontSize(14)
            .fontWeight(this.selectedActionCategory === 'system' ? FontWeight.Medium : FontWeight.Normal)
            .fontColor(this.selectedActionCategory === 'system' ? '#FFFFFF' : '#5856D6')
            .backgroundColor(this.selectedActionCategory === 'system' ? '#5856D6' : '#F2F2F7')
            .borderRadius(20)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .onClick(() => {
              this.selectedActionCategory = 'system';
            })
        }
        .width('100%')
        .margin({ bottom: 16 })

        Scroll() {
          Column({ space: 0 }) {
            ForEach(this.getFilteredActions(), (actionInfo: ActionInfo) => {
              Button() {
                Row({ space: 12 }) {
                  Row() {
                    Text(actionInfo.icon)
                      .fontSize(20)
                  }
                  .width(40)
                  .height(40)
                  .backgroundColor(actionInfo.color)
                  .borderRadius(10)
                  .justifyContent(FlexAlign.Center)

                  Column({ space: 2 }) {
                    Text(actionInfo.displayName)
                      .fontSize(16)
                      .fontColor('#1A1A1A')

                    Text(actionInfo.description)
                      .fontSize(13)
                      .fontColor('#8E8E93')
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .flexGrow(1)

                  SymbolGlyph($r('sys.symbol.plus'))
                    .fontSize(20)
                    .fontColor(['#007AFF'])
                }
                .width('100%')
                .padding({ left: 4, right: 4, top: 4, bottom: 4 })
              }
              .width('100%')
              .backgroundColor(Color.Transparent)
              .onClick(() => {
                this.addActionByType(actionInfo.type);
              })
            }, (actionInfo: ActionInfo) => actionInfo.type)
          }
          .width('100%')
        }
        .layoutWeight(1)
        .width('100%')
      }
      .width('100%')
      .height('70%')
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 16, topRight: 16 })
      .padding({ left: 20, right: 20, top: 8, bottom: 34 })
      .shadow({
        radius: 24,
        color: '#20000000',
        offsetX: 0,
        offsetY: -4
      })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.End)
    .backgroundColor('#66000000')
    .onClick(() => {
      this.showActionDrawer = false;
    })
    .zIndex(4)
  }

  @Builder
  CategoryTabBuilder(name: string, value: string, color: string) {
    Button(name)
      .fontSize(14)
      .fontWeight(this.selectedActionCategory === value ? FontWeight.Medium : FontWeight.Normal)
      .fontColor(this.selectedActionCategory === value ? '#FFFFFF' : color)
      .backgroundColor(this.selectedActionCategory === value ? color : '#F2F2F7')
      .borderRadius(20)
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .onClick(() => {
        this.selectedActionCategory = value;
      })
  }

  @Builder
  ActionCardBuilder(viewModel: ActionViewModel, index: number) {
    Column({ space: 0 }) {
      Column({ space: 12 }) {
        Row({ space: 12 }) {
          Row() {
            Text(this.getActionIcon(viewModel))
              .fontSize(20)
          }
          .width(40)
          .height(40)
          .backgroundColor(this.getActionColor(viewModel))
          .borderRadius(10)
          .justifyContent(FlexAlign.Center)

          Column({ space: 4 }) {
            if (viewModel.configSegments && viewModel.configSegments.length > 0) {
              this.ConfigSummaryRenderer(viewModel.configSegments, index)
            } else if (viewModel.configSummary) {
              Text(viewModel.configSummary)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1A1A1A')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
          }
          .alignItems(HorizontalAlign.Start)
          .flexGrow(1)

          Button() {
            SymbolGlyph(this.expandedActionIndex === index ? $r('sys.symbol.chevron_up') : $r('sys.symbol.chevron_down'))
              .fontSize(14)
              .fontColor(['#8E8E93'])
          }
          .width(32)
          .height(32)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.handleEditAction(index);
          })

          Button() {
            SymbolGlyph($r('sys.symbol.xmark'))
              .fontSize(16)
              .fontColor(['#8E8E93'])
          }
          .width(32)
          .height(32)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.deleteAction(index);
          })
        }
        .width('100%')

        if (!viewModel.isValid && viewModel.validationErrors.length > 0) {
          Row({ space: 6 }) {
            SymbolGlyph($r('sys.symbol.exclamationmark_triangle_fill'))
              .fontSize(14)
              .fontColor(['#FF3B30'])

            Text(viewModel.validationErrors[0])
              .fontSize(13)
              .fontColor('#FF3B30')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .flexGrow(1)
          }
          .width('100%')
          .padding(8)
          .backgroundColor('#FFF0F0')
          .borderRadius(8)
        }
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .border({
        width: 1,
        color: viewModel.isValid ? '#E5E5EA' : '#FF3B30'
      })
      .onClick(() => {
        this.handleEditAction(index);
      })

      if (this.expandedActionIndex === index && this.editingAction) {
        this.buildActionConfigForm()
      }
    }
    .width('100%')
    .margin({ bottom: 8 })
  }

  @Builder
  ConfigSummaryRenderer(segments: TextSegment[], actionIndex: number) {
    Row() {
      ForEach(segments, (segment: TextSegment, segIndex: number) => {
        if (segment.isClickable && segment.field &&
          this.inlineEditingIndex === actionIndex && this.inlineEditingField === segment.field) {
          TextInput({
            placeholder: segment.text,
            text: this.inlineEditingValue
          })
            .fontSize(14)
            .width(100)
            .height(32)
            .backgroundColor('#F2F2F7')
            .borderRadius(4)
            .onChange((value: string) => {
              this.inlineEditingValue = value;
            })
            .onBlur(() => {
              this.updateActionFieldValue(actionIndex, segment.field!, this.inlineEditingValue);
              this.finishEditing();
            })
        } else if (segment.isClickable) {
          Text(segment.text)
            .fontSize(14)
            .fontColor(segment.color || '#007AFF')
            .backgroundColor(segment.backgroundColor || Color.Transparent)
            .padding({ left:4, right: 4, top: 2, bottom: 2 })
            .borderRadius(4)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .onClick(() => {
              if (segment.field) {
                this.handleVariableClick(segment.value || '', segment.field, actionIndex);
              }
            })
        } else {
          Text(segment.text)
            .fontSize(14)
            .fontColor(segment.color || '#8E8E93')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
      }, (segment: TextSegment, index: number) => `segment_${index}_${segment.text}`)
    }
    .width('100%')
  }

  /**
   * æ›´æ–°åŠ¨ä½œå­—æ®µå€¼
   */
  private updateActionFieldValue(actionIndex: number, field: string, value: string): void {
    const action = this.actions[actionIndex];
    const config: Record<string, Object> = JSON.parse(action.config) as Record<string, Object>;
    config[field] = value;
    action.config = JSON.stringify(config);

    const newActions = this.actions.slice();
    newActions[actionIndex] = action;
    this.actions = newActions;

    setTimeout(() => {
      this.updateActionViewModels();
    }, 10);
  }

  /**
   * è·å–åŠ¨ä½œå­—æ®µå€¼
   */
  private getActionFieldValue(actionIndex: number, field: string): string {
    const action = this.actions[actionIndex];
    try {
      const config: Record<string, Object> = JSON.parse(action.config) as Record<string, Object>;
      return String(config[field] || '');
    } catch (error) {
      return '';
    }

    setTimeout(() => {
      this.updateActionViewModels();
    }, 10);
  }

  build() {
    Stack() {
      Column() {
        // iOSé£æ ¼é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          // å·¦ä¾§è¿”å›æŒ‰é’®ï¼ˆçº¢è‰²ï¼‰
          Button() {
            SymbolGlyph($r('sys.symbol.chevron_left'))
              .fontSize(20)
              .fontColor(['#ffffff'])
          }
          .width(36)
          .height(36)
          .backgroundColor('#FF3B30')
          .borderRadius(18)
          .onClick(() => {
            this.handleCancel();
          })

          // ä¸­é—´æ ‡é¢˜
          Text(this.macroName || 'æœªå‘½åå®')
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .flexGrow(1)
            .textAlign(TextAlign.Center)
            .margin({ left: 8, right: 8 })

          // å³ä¾§æŒ‰é’®ç»„
          Row({ space: 8 }) {
            // è®¾ç½®æŒ‰é’®ï¼ˆè“è‰²ï¼‰
            Button() {
              SymbolGlyph($r('sys.symbol.gearshape'))
                .fontSize(20)
                .fontColor(['#ffffff'])
            }
            .width(36)
            .height(36)
            .backgroundColor('#007AFF')
            .borderRadius(18)
            .onClick(() => {
              this.showSettings = true;
            })

            // å…³é—­æŒ‰é’®ï¼ˆç°è‰²ï¼‰
            Button() {
            SymbolGlyph($r('sys.symbol.xmark'))
                .fontSize(20)
                .fontColor(['#ffffff'])
            }
            .width(36)
            .height(36)
            .backgroundColor('#8E8E93')
            .borderRadius(18)
            .onClick(() => {
              router.back();
            })
          }
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#F2F2F7')
        .border({ width: { bottom: 1 }, color: '#E5E5EA' })

        // ä¸»è¦å†…å®¹åŒºåŸŸï¼ˆåŠ¨ä½œåˆ—è¡¨ï¼‰
        Scroll() {
          Column({ space: 0 }) {
            // åŠ¨ä½œåˆ—è¡¨
            if (this.actionViewModels.length === 0) {
              Column({ space: 12 }) {
                SymbolGlyph($r('sys.symbol.list_bullet'))
                  .fontSize(64)
                  .fontColor(['#C7C7CC'])

                Text('æš‚æ— åŠ¨ä½œ')
                  .fontSize(17)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#8E8E93')

                Text('ç‚¹å‡»ä¸‹æ–¹æœç´¢æ æ·»åŠ åŠ¨ä½œ')
                  .fontSize(14)
                  .fontColor('#8E8E93')
              }
              .width('100%')
              .padding({ top: 80 })
            } else {
              Column({ space: 0 }) {
                ForEach(this.actionViewModels, (viewModel: ActionViewModel, index: number) => {
                  this.ActionCardBuilder(viewModel, index)
                }, (viewModel: ActionViewModel, index: number) => {
                  const id = viewModel.id || 0;
                  const summary = viewModel.configSummary || '';
                  const valid = viewModel.isValid ? '1' : '0';
                  return `${index}_${id}_${summary}_${valid}`;
                })
              }
              .width('100%')
            }
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 16, bottom: 80 })
        }
        .flexGrow(1)
        .scrollBar(BarState.Auto)
        .backgroundColor('#F2F2F7')

        // åº•éƒ¨æ“ä½œæ 
        Column() {
          Row({ space: 12 }) {
            // æ’¤é”€æŒ‰é’®
            Button() {
              SymbolGlyph($r('sys.symbol.undo'))
                .fontSize(20)
                .fontColor(['#007AFF'])
            }
            .width(44)
            .height(44)
            .backgroundColor('#F2F2F7')
            .borderRadius(22)
            .onClick(() => {
              // TODO: å®ç°æ’¤é”€åŠŸèƒ½
            })

            // é‡åšæŒ‰é’®
            Button() {
              SymbolGlyph($r('sys.symbol.redo'))
                .fontSize(20)
                .fontColor(['#007AFF'])
            }
            .width(44)
            .height(44)
            .backgroundColor('#F2F2F7')
            .borderRadius(22)
            .onClick(() => {
              // TODO: å®ç°é‡åšåŠŸèƒ½
            })

            // åˆ†äº«æŒ‰é’®
            Button() {
              SymbolGlyph($r('sys.symbol.share'))
                .fontSize(20)
                .fontColor(['#007AFF'])
            }
            .width(44)
            .height(44)
            .backgroundColor('#F2F2F7')
            .borderRadius(22)
            .onClick(() => {
              // TODO: å®ç°åˆ†äº«åŠŸèƒ½
            })

            Blank()

            // è¿è¡ŒæŒ‰é’®ï¼ˆè“è‰²ä¸‰è§’å½¢ï¼‰
            Button() {
              SymbolGlyph($r('sys.symbol.play_fill'))
                .fontSize(24)
                .fontColor(['#ffffff'])
            }
            .width(56)
            .height(56)
            .backgroundColor('#007AFF')
            .borderRadius(28)
            .onClick(() => {
              // TODO: å®ç°è¿è¡ŒåŠŸèƒ½
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .backgroundColor('#ffffff')
          .border({ width: { top: 1 }, color: '#E5E5EA' })
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F2F2F7')

      // è®¾ç½®é¢æ¿
      if (this.showSettings) {
        this.SettingsPanelBuilder()
      }

      // åŠ¨ä½œæŠ½å±‰
      if (this.showActionDrawer) {
        this.ActionDrawerBuilder()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F2F7')
  }
  // è·å–è¿‡æ»¤åçš„åŠ¨ä½œåˆ—è¡¨
  private getFilteredActions(): ActionInfo[] {
    let actions: ActionInfo[] = this.getAllActionInfos();

    if (this.selectedActionCategory !== 'all') {
      actions = actions.filter((action: ActionInfo): boolean => action.category === this.selectedActionCategory);
    }

    if (this.actionSearchText) {
      const searchLower = this.actionSearchText.toLowerCase();
      actions = actions.filter((action: ActionInfo): boolean =>
        action.displayName.toLowerCase().includes(searchLower) ||
        action.description.toLowerCase().includes(searchLower)
      );
    }

    return actions;
  }

  // è·å–æ‰€æœ‰åŠ¨ä½œä¿¡æ¯
  private getAllActionInfos(): ActionInfo[] {
    return [
      {
        type: ActionTypes.LAUNCH_APP,
        displayName: 'å¯åŠ¨åº”ç”¨',
        description: 'æ‰“å¼€æŒ‡å®šçš„åº”ç”¨ç¨‹åº',
        icon: 'ğŸ“±',
        color: '#007AFF',
        category: 'system'
      },
      {
        type: ActionTypes.NOTIFICATION,
        displayName: 'å‘é€é€šçŸ¥',
        description: 'æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥',
        icon: 'ğŸ””',
        color: '#FF9500',
        category: 'system'
      },
      {
        type: ActionTypes.CLIPBOARD_READ,
        displayName: 'è¯»å–å‰ªè´´æ¿',
        description: 'è·å–å‰ªè´´æ¿å†…å®¹',
        icon: 'ğŸ“‹',
        color: '#5856D6',
        category: 'text'
      },
      {
        type: ActionTypes.CLIPBOARD_WRITE,
        displayName: 'å†™å…¥å‰ªè´´æ¿',
        description: 'è®¾ç½®å‰ªè´´æ¿å†…å®¹',
        icon: 'ğŸ“',
        color: '#5856D6',
        category: 'text'
      },
      {
        type: ActionTypes.HTTP_REQUEST,
        displayName: 'HTTP è¯·æ±‚',
        description: 'å‘é€ç½‘ç»œè¯·æ±‚',
        icon: 'ğŸŒ',
        color: '#34C759',
        category: 'network'
      },
      {
        type: ActionTypes.OPEN_URL,
        displayName: 'æ‰“å¼€ URL',
        description: 'åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€é“¾æ¥',
        icon: 'ğŸ”—',
        color: '#34C759',
        category: 'network'
      },
      {
        type: ActionTypes.TEXT_PROCESS,
        displayName: 'æ–‡æœ¬å¤„ç†',
        description: 'æ­£åˆ™ã€æ›¿æ¢ç­‰æ“ä½œ',
        icon: 'ğŸ”§',
        color: '#FF9500',
        category: 'text'
      },
      {
        type: ActionTypes.JSON_PROCESS,
        displayName: 'JSON å¤„ç†',
        description: 'è§£æå’ŒæŸ¥è¯¢ JSON',
        icon: 'ğŸ“¦',
        color: '#FF9500',
        category: 'text'
      },
      {
        type: ActionTypes.USER_DIALOG,
        displayName: 'ç”¨æˆ·å¯¹è¯æ¡†',
        description: 'æ˜¾ç¤ºè¾“å…¥æˆ–é€‰æ‹©å¯¹è¯æ¡†',
        icon: 'ğŸ’¬',
        color: '#AF52DE',
        category: 'system'
      },
      {
        type: ActionTypes.SET_VARIABLE,
        displayName: 'è®¾ç½®å˜é‡',
        description: 'å®šä¹‰æˆ–ä¿®æ”¹å˜é‡å€¼',
        icon: 'ğŸ”‘',
        color: '#5856D6',
        category: 'text'
      },
      {
        type: ActionTypes.IF_ELSE,
        displayName: 'æ¡ä»¶åˆ†æ”¯',
        description: 'æ ¹æ®æ¡ä»¶æ‰§è¡Œä¸åŒåŠ¨ä½œ',
        icon: 'ğŸ”€',
        color: '#FF3B30',
        category: 'system'
      }
    ];
  }

  // æ ¹æ®ç±»å‹æ·»åŠ åŠ¨ä½œ
  private addActionByType(type: string) {
    switch (type) {
      case ActionTypes.LAUNCH_APP:
        this.addLaunchAppAction();
        break;
      case ActionTypes.NOTIFICATION:
        this.addNotificationAction();
        break;
      case ActionTypes.CLIPBOARD_READ:
        this.addClipboardReadAction();
        break;
      case ActionTypes.CLIPBOARD_WRITE:
        this.addClipboardWriteAction();
        break;
      case ActionTypes.HTTP_REQUEST:
        this.addHttpRequestAction();
        break;
      case ActionTypes.OPEN_URL:
        this.addOpenUrlAction();
        break;
      case ActionTypes.TEXT_PROCESS:
        this.addTextProcessAction();
        break;
      case ActionTypes.JSON_PROCESS:
        this.addJsonProcessAction();
        break;
      case ActionTypes.USER_DIALOG:
        this.addUserDialogAction();
        break;
      case ActionTypes.SET_VARIABLE:
        this.addSetVariableAction();
        break;
      case ActionTypes.IF_ELSE:
        this.addIfElseAction();
        break;
    }

    this.showActionDrawer = false;
  }

  // è·å–åŠ¨ä½œå›¾æ ‡
  private getActionIcon(viewModel: ActionViewModel): string {
    const actionInfo = this.getAllActionInfos().find((info: ActionInfo): boolean => info.type === viewModel.type);
    return actionInfo?.icon || 'âš™ï¸';
  }

  // è·å–åŠ¨ä½œé¢œè‰²
  private getActionColor(viewModel: ActionViewModel): string {
    const actionInfo = this.getAllActionInfos().find((info: ActionInfo): boolean => info.type === viewModel.type);
    return actionInfo?.color || '#8E8E93';
  }

}
