import { Macro, MacroInput, Trigger, Action, TriggerType, ActionType, TimeTriggerConfig, NetworkTriggerConfig, HttpHeaders } from '../models/Macro';
import { Variable, VariableScope, VariableType } from '../models/Variable';
import { ActionViewModel, ActionViewModelFactory } from '../models/ActionViewModel';
import { DatabaseService } from '../services/DatabaseService';
import { VariableFlowAnalyzer } from '../utils/VariableFlowAnalyzer';
import { ActionConfigSummaryGenerator } from '../utils/ActionConfigSummaryGenerator';
import { VariableNameRecommender } from '../utils/VariableNameRecommender';
import { ActionConfigEditor } from '../components/ActionConfigEditor';
import { VariableOption } from '../components/VariableSelector';
import { CommonTopBar, TopBarConfig } from '../components/CommonTopBar';
import Logger from '../utils/Logger';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';

/**
 * å®ç¼–è¾‘é¡µï¼ˆå®Œæ•´ç‰ˆï¼‰
 * æ”¯æŒåŸºæœ¬ä¿¡æ¯ã€è§¦å‘å™¨ã€åŠ¨ä½œã€å˜é‡é…ç½®
 */
@Entry
@Component
struct MacroEditor {
  @State macroName: string = '';
  @State macroDescription: string = '';
  @State macroEnabled: boolean = true;
  @State isEditMode: boolean = false;
  @State triggers: Trigger[] = [];
  @State actions: Action[] = [];
  @State actionViewModels: ActionViewModel[] = []; // åŠ¨ä½œè§†å›¾æ¨¡å‹
  @State highlightedVariable: string = ''; // å½“å‰é«˜äº®çš„å˜é‡å
  @State variables: Variable[] = [];
  @State showVariableEditor: boolean = false;
  @State isVariableEditMode: boolean = false;
  @State editingVariableIndex: number = -1;
  @State varEditorName: string = '';
  @State varEditorType: VariableType = VariableType.STRING;
  @State varEditorValue: string = '';

  // åŠ¨ä½œé…ç½®ç¼–è¾‘å™¨çŠ¶æ€
  @State showActionConfigEditor: boolean = false;
  @State editingAction: Action | null = null;
  @State editingActionIndex: number = -1;
  @State availableVariablesForEditor: VariableOption[] = [];

  // åŠ¨ä½œé…ç½®ç¼–è¾‘å™¨å¯¹è¯æ¡†æ§åˆ¶å™¨
  private actionConfigDialogController: CustomDialogController | null = null;

  private macroId: number = 0;
  private databaseService: DatabaseService = DatabaseService.getInstance();

  async aboutToAppear() {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘æ¨¡å¼
    const params = router.getParams() as Record<string, Object>;
    if (params && params['macroId']) {
      this.isEditMode = true;
      this.macroId = params['macroId'] as number;
      await this.loadMacro();
    }
  }

  /**
   * åŠ è½½å®æ•°æ®
   */
  private async loadMacro() {
    try {
      const macro = await this.databaseService.getMacroById(this.macroId);
      if (macro) {
        this.macroName = macro.name;
        this.macroDescription = macro.description || '';
        this.macroEnabled = macro.enabled;
      }

      // åŠ è½½è§¦å‘å™¨ã€åŠ¨ä½œå’Œå˜é‡
      this.triggers = await this.databaseService.getTriggersByMacroId(this.macroId);
      this.actions = await this.databaseService.getActionsByMacroId(this.macroId);
      this.variables = await this.databaseService.getVariablesByMacroId(this.macroId);

      // æ›´æ–°åŠ¨ä½œè§†å›¾æ¨¡å‹
      this.updateActionViewModels();

    } catch (error) {
      Logger.error('MacroEditor', 'Failed to load macro', error as Error);
      promptAction.showToast({ message: 'åŠ è½½å®æ•°æ®å¤±è´¥' });
    }
  }

  /**
   * ä¿å­˜å®
   */
  private async handleSave() {
    // éªŒè¯è¾“å…¥
    if (!this.macroName || this.macroName.trim().length === 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å®åç§°' });
      return;
    }

    if (this.macroName.length > 50) {
      promptAction.showToast({ message: 'å®åç§°ä¸èƒ½è¶…è¿‡ 50 ä¸ªå­—ç¬¦' });
      return;
    }

    // éªŒè¯å¿…é¡»æœ‰è‡³å°‘1ä¸ªè§¦å‘å™¨å’Œ1ä¸ªåŠ¨ä½œ
    if (this.triggers.length === 0) {
      promptAction.showToast({ message: 'è¯·è‡³å°‘æ·»åŠ 1ä¸ªè§¦å‘å™¨' });
      return;
    }

    if (this.actions.length === 0) {
      promptAction.showToast({ message: 'è¯·è‡³å°‘æ·»åŠ 1ä¸ªåŠ¨ä½œ' });
      return;
    }

    try {
      const now = Date.now();

      if (this.isEditMode) {
        Logger.info('MacroEditor', `Saving macro ${this.macroId} in edit mode`);

        // æ›´æ–°å®åŸºæœ¬ä¿¡æ¯
        await this.databaseService.updateMacro(this.macroId, {
          name: this.macroName.trim(),
          description: this.macroDescription.trim(),
          enabled: this.macroEnabled
        });

        Logger.info('MacroEditor', 'Macro basic info updated');

        // ä¿å­˜è§¦å‘å™¨å’ŒåŠ¨ä½œï¼ˆå…ˆåˆ é™¤å†æ’å…¥ï¼‰
        // 1. åˆ é™¤æ‰€æœ‰æ—§çš„è§¦å‘å™¨ã€åŠ¨ä½œã€å˜é‡
        await this.databaseService.deleteTriggersByMacroId(this.macroId);
        await this.databaseService.deleteActionsByMacroId(this.macroId);
        await this.databaseService.deleteVariablesByMacroId(this.macroId);

        Logger.info('MacroEditor', 'Old triggers, actions, variables deleted');

        // 2. é‡æ–°æ’å…¥è§¦å‘å™¨
        for (const trigger of this.triggers) {
          await this.databaseService.insertTrigger({
            macroId: this.macroId,
            type: trigger.type,
            config: trigger.config,
            enabled: trigger.enabled
          });
        }

        Logger.info('MacroEditor', `Inserted ${this.triggers.length} triggers`);

        // 3. é‡æ–°æ’å…¥åŠ¨ä½œ
        for (const action of this.actions) {
          await this.databaseService.insertAction({
            macroId: this.macroId,
            type: action.type,
            config: action.config,
            orderIndex: action.orderIndex
          });
        }

        Logger.info('MacroEditor', `Inserted ${this.actions.length} actions`);

        // 4. é‡æ–°æ’å…¥å˜é‡
        for (const variable of this.variables) {
          await this.databaseService.insertVariable({
            scope: VariableScope.MACRO,
            macroId: this.macroId,
            name: variable.name,
            type: variable.type,
            value: variable.value,
            createdAt: now,
            updatedAt: now
          });
        }

        Logger.info('MacroEditor', `Inserted ${this.variables.length} variables`);

        promptAction.showToast({ message: 'å®å·²æ›´æ–°' });
      } else {
        Logger.info('MacroEditor', 'Creating new macro');

        // åˆ›å»ºæ–°å®
        const macro: MacroInput = {
          name: this.macroName.trim(),
          description: this.macroDescription.trim(),
          enabled: this.macroEnabled,
          createdAt: now,
          updatedAt: now
        };
        this.macroId = await this.databaseService.insertMacro(macro);

        Logger.info('MacroEditor', `Macro created with ID: ${this.macroId}`);

        // ä¿å­˜è§¦å‘å™¨
        for (const trigger of this.triggers) {
          await this.databaseService.insertTrigger({
            macroId: this.macroId,
            type: trigger.type,
            config: trigger.config,
            enabled: trigger.enabled
          });
        }

        // ä¿å­˜åŠ¨ä½œ
        for (const action of this.actions) {
          await this.databaseService.insertAction({
            macroId: this.macroId,
            type: action.type,
            config: action.config,
            orderIndex: action.orderIndex
          });
        }

        // ä¿å­˜å˜é‡
        for (const variable of this.variables) {
          await this.databaseService.insertVariable({
            scope: VariableScope.MACRO,
            macroId: this.macroId,
            name: variable.name,
            type: variable.type,
            value: variable.value,
            createdAt: now,
            updatedAt: now
          });
        }

        promptAction.showToast({ message: 'å®å·²åˆ›å»º' });
      }

      // è¿”å›åˆ—è¡¨é¡µ
      router.back();
    } catch (error) {
      Logger.error('MacroEditor', 'Failed to save macro', error as Error);
      promptAction.showToast({ message: `ä¿å­˜å¤±è´¥: ${error.message}` });
    }
  }

  /**
   * å–æ¶ˆç¼–è¾‘
   */
  private handleCancel() {
    router.back();
  }

  /**
   * c
   * åˆ†æå˜é‡æµå‘å¹¶ç”Ÿæˆé…ç½®æ‘˜è¦
   */
  private updateActionViewModels() {
    Logger.info('MacroEditor', `Updating action view models, actions count: ${this.actions.length}`);

    // åˆ›å»ºæ–°çš„è§†å›¾æ¨¡å‹æ•°ç»„ï¼ˆç¡®ä¿å¼•ç”¨å˜åŒ–ä»¥è§¦å‘ UI æ›´æ–°ï¼‰
    const newViewModels: ActionViewModel[] = this.actions.map((action, index) => {
      Logger.info('MacroEditor', `Processing action ${index}, config: ${action.config}`);

      // è·å–ä¹‹å‰å·²å®šä¹‰çš„å˜é‡
      const definedVars = VariableFlowAnalyzer.getDefinedVariablesBeforeAction(
        this.actions,
        index,
        this.variables
      );

      // éªŒè¯åŠ¨ä½œé…ç½®
      const validationResult = VariableFlowAnalyzer.validateAction(
        action,
        index,
        definedVars
      );

      // æå–è¾“å…¥/è¾“å‡ºå˜é‡
      const inputVars = ActionConfigSummaryGenerator.extractInputVariables(action);
      const outputVar = ActionConfigSummaryGenerator.extractOutputVariable(action);

      // ç”Ÿæˆé…ç½®æ‘˜è¦
      const summary = ActionConfigSummaryGenerator.generate(action);
      Logger.info('MacroEditor', `Generated summary for action ${index}: ${summary}`);

      return ActionViewModelFactory.create(
        action,
        inputVars,
        outputVar,
        summary,
        validationResult.isValid,
        validationResult.errors
      );
    });

    // ä½¿ç”¨æ–°æ•°ç»„æ›¿æ¢ä»¥è§¦å‘ @State å“åº”å¼æ›´æ–°
    this.actionViewModels = newViewModels;
    Logger.info('MacroEditor', `View models updated, new count: ${this.actionViewModels.length}`);
  }

  /**
   * å¤„ç†å˜é‡ç‚¹å‡»ï¼Œåˆ‡æ¢é«˜äº®çŠ¶æ€
   */
  private handleVariableClick(varName: string) {
    if (this.highlightedVariable === varName) {
      // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é«˜äº®çš„å˜é‡ï¼Œå–æ¶ˆé«˜äº®
      this.highlightedVariable = '';
    } else {
      // å¦åˆ™é«˜äº®è¯¥å˜é‡
      this.highlightedVariable = varName;
    }
  }

  /**
   * å‡†å¤‡å¯ç”¨å˜é‡åˆ—è¡¨
   * @param actionIndex å½“å‰ç¼–è¾‘çš„åŠ¨ä½œç´¢å¼•
   */
  private prepareAvailableVariables(actionIndex: number) {
    this.availableVariablesForEditor = [];

    // 1. æ·»åŠ ç³»ç»Ÿå˜é‡
    const systemVars: VariableOption[] = [
      {
        name: 'date',
        displayName: '{date}',
        type: 'system',
        description: 'å½“å‰æ—¥æœŸ (YYYY-MM-DD)'
      },
      {
        name: 'time',
        displayName: '{time}',
        type: 'system',
        description: 'å½“å‰æ—¶é—´ (HH:mm:ss)'
      },
      {
        name: 'timestamp',
        displayName: '{timestamp}',
        type: 'system',
        description: 'å½“å‰æ—¶é—´æˆ³'
      },
      {
        name: 'clipboard',
        displayName: '{clipboard}',
        type: 'system',
        description: 'ç³»ç»Ÿå‰ªè´´æ¿å†…å®¹'
      },
      {
        name: 'network_type',
        displayName: '{network_type}',
        type: 'system',
        description: 'ç½‘ç»œç±»å‹ (wifi/mobile)'
      },
      {
        name: 'battery_level',
        displayName: '{battery_level}',
        type: 'system',
        description: 'ç”µæ± ç”µé‡ç™¾åˆ†æ¯”'
      }
    ];
    this.availableVariablesForEditor.push(...systemVars);

    // 2. æ·»åŠ å®å˜é‡
    this.variables.forEach(variable => {
      this.availableVariablesForEditor.push({
        name: variable.name,
        displayName: `{${variable.name}}`,
        type: 'macro',
        description: `å®å˜é‡ (${this.getVariableTypeLabel(variable.type)})`
      });
    });

    // 3. æ·»åŠ ä¹‹å‰åŠ¨ä½œè¾“å‡ºçš„å˜é‡
    for (let i = 0; i < actionIndex; i++) {
      const outputVar = ActionConfigSummaryGenerator.extractOutputVariable(this.actions[i]);
      if (outputVar) {
        const summary = ActionConfigSummaryGenerator.generate(this.actions[i]);
        this.availableVariablesForEditor.push({
          name: outputVar,
          displayName: `{${outputVar}}`,
          type: 'runtime',
          description: `æ¥è‡ªåŠ¨ä½œ ${i + 1}: ${summary}`,
          sourceActionIndex: i
        });
      }
    }
  }

  /**
   * ç¼–è¾‘åŠ¨ä½œ
   */
  private handleEditAction(index: number) {
    Logger.info('MacroEditor', `Opening action editor for index ${index}`);

    // å‡†å¤‡å¯ç”¨å˜é‡
    this.prepareAvailableVariables(index);

    // è®¾ç½®ç¼–è¾‘çŠ¶æ€
    this.editingActionIndex = index;

    // æ·±æ‹·è´åŠ¨ä½œå¯¹è±¡ï¼ˆç¡®ä¿æ¯æ¬¡éƒ½æ˜¯æ–°å¯¹è±¡å¼•ç”¨ï¼‰
    this.editingAction = JSON.parse(JSON.stringify(this.actions[index])) as Action;
    Logger.info('MacroEditor', `Editing action: ${JSON.stringify(this.editingAction)}`);

    // é”€æ¯æ—§çš„å¯¹è¯æ¡†æ§åˆ¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (this.actionConfigDialogController) {
      Logger.info('MacroEditor', 'Destroying old dialog controller');
      this.actionConfigDialogController = null;
    }

    // åˆ›å»ºæ–°çš„ç¼–è¾‘å™¨å¯¹è¯æ¡†
    this.actionConfigDialogController = new CustomDialogController({
      builder: ActionConfigEditor({
        action: this.editingAction!,
        isEditMode: true,
        availableVariables: this.availableVariablesForEditor,
        onSave: (updatedAction: Action) => {
          this.handleActionConfigSave(updatedAction);
        },
        onCancel: () => {
          this.handleActionConfigCancel();
        }
      }),
      autoCancel: false,
      customStyle: true
    });

    Logger.info('MacroEditor', 'Opening dialog');
    this.actionConfigDialogController.open();
  }

  /**
   * ä¿å­˜åŠ¨ä½œé…ç½®ï¼ˆä»…æ›´æ–°å†…å­˜ï¼Œä¸æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼‰
   */
  private handleActionConfigSave(updatedAction: Action) {
    Logger.info('MacroEditor', `Saving action config at index ${this.editingActionIndex}`);
    Logger.info('MacroEditor', `Updated action ID: ${updatedAction.id}, config: ${updatedAction.config}`);

    if (this.editingActionIndex >= 0 && this.editingActionIndex < this.actions.length) {
      // ç¡®ä¿ä¿ç•™æ­£ç¡®çš„ orderIndex
      updatedAction.orderIndex = this.editingActionIndex;

      // æ›´æ–°åŠ¨ä½œé…ç½® - ä½¿ç”¨ slice() åˆ›å»ºæ–°æ•°ç»„ä»¥è§¦å‘å“åº”å¼æ›´æ–°ï¼ˆArkTS å…¼å®¹ï¼‰
      const newActions: Action[] = this.actions.slice();
      newActions[this.editingActionIndex] = updatedAction;
      this.actions = newActions;

      Logger.info('MacroEditor', `Actions array updated, length: ${this.actions.length}`);
      Logger.info('MacroEditor', `Updated action at index ${this.editingActionIndex}, new config: ${this.actions[this.editingActionIndex].config}`);

      // å¼ºåˆ¶æ¸…ç©ºè§†å›¾æ¨¡å‹ï¼Œç„¶åæ›´æ–°ï¼ˆç¡®ä¿ ForEach é‡æ–°æ¸²æŸ“ï¼‰
      this.actionViewModels = [];

      // ä½¿ç”¨ setTimeout ç¡®ä¿ UI æ›´æ–°
      setTimeout(() => {
        this.updateActionViewModels();
        Logger.info('MacroEditor', `View models updated, length: ${this.actionViewModels.length}`);
      }, 10);

      promptAction.showToast({ message: 'åŠ¨ä½œé…ç½®å·²æ›´æ–°ï¼ˆç‚¹å‡»ä¿å­˜å®åç”Ÿæ•ˆï¼‰' });
    }

    // å…³é—­ç¼–è¾‘å™¨
    if (this.actionConfigDialogController) {
      this.actionConfigDialogController.close();
      this.actionConfigDialogController = null;
    }

    // é‡ç½®ç¼–è¾‘çŠ¶æ€
    this.editingAction = null;
    this.editingActionIndex = -1;
  }

  /**
   * å–æ¶ˆç¼–è¾‘åŠ¨ä½œé…ç½®
   */
  private handleActionConfigCancel() {
    // å…³é—­ç¼–è¾‘å™¨
    if (this.actionConfigDialogController) {
      this.actionConfigDialogController.close();
      this.actionConfigDialogController = null;
    }

    // é‡ç½®ç¼–è¾‘çŠ¶æ€
    this.editingAction = null;
    this.editingActionIndex = -1;
  }

  /**
   * ä½¿ç”¨"å¿«å°çº¢"æµç¨‹æ¨¡æ¿
   * å¿«é€Ÿåˆ›å»ºå°çº¢ä¹¦å†…å®¹é‡‡é›†åˆ°é£ä¹¦çš„å®Œæ•´æµç¨‹
   */
  private applyKuaiXiaoHongTemplate() {
    promptAction.showDialog({
      title: 'ä½¿ç”¨å¿«å°çº¢æ¨¡æ¿',
      message: 'å°†è‡ªåŠ¨åˆ›å»ºï¼š\n1. æ‰‹åŠ¨è§¦å‘å™¨\n2. è¯»å–å‰ªè´´æ¿\n3. æ­£åˆ™æå– URL\n4. ç”¨æˆ·å¯¹è¯æ¡†ï¼ˆé€‰æ‹©çˆ†æ¬¾æ ‡è®°ï¼‰\n5. ç”¨æˆ·å¯¹è¯æ¡†ï¼ˆé€‰æ‹©åˆ†ç±»æ ‡ç­¾ï¼‰\n6. HTTP POST è¯·æ±‚\n7. æ‰“å¼€é£ä¹¦è¡¨æ ¼\n\næ˜¯å¦ç»§ç»­ï¼Ÿ',
      buttons: [
        { text: 'å–æ¶ˆ', color: '#000000' },
        { text: 'åˆ›å»º', color: '#007DFF' }
      ]
    }).then((result) => {
      if (result.index === 1) {
        this.createKuaiXiaoHongTemplate();
      }
    });
  }

  /**
   * åˆ›å»ºå¿«å°çº¢æµç¨‹æ¨¡æ¿
   * å‚è€ƒ docs/å¿«å°çº¢å®æµç¨‹å®Œæ•´è§£æ.md
   */
  private createKuaiXiaoHongTemplate() {
    // 1. æ·»åŠ æ‰‹åŠ¨è§¦å‘å™¨
    const manualTrigger: Trigger = {
      id: Date.now(),
      macroId: this.macroId,
      type: TriggerType.MANUAL,
      config: JSON.stringify({ methods: ['button', 'shortcut'] }),
      enabled: true
    };
    this.triggers.push(manualTrigger);

    // 2. å‘é€é€šçŸ¥ - å¯åŠ¨æç¤º
    const startNotificationAction: Action = {
      id: Date.now() + 1,
      macroId: this.macroId,
      type: ActionType.NOTIFICATION,
      config: JSON.stringify({
        title: 'å¼€å§‹é‡‡é›†',
        content: 'è¯·æŒ‰æç¤ºé€æ­¥æ“ä½œ',
        enableSound: false,
        enableVibration: false
      }),
      orderIndex: 0
    };
    this.actions.push(startNotificationAction);

    // 3. è¯»å–å‰ªè´´æ¿
    const clipboardAction: Action = {
      id: Date.now() + 2,
      macroId: this.macroId,
      type: ActionType.CLIPBOARD_READ,
      config: JSON.stringify({
        operation: 'read',
        saveToVariable: 'clipboard_content'
      }),
      orderIndex: 1
    };
    this.actions.push(clipboardAction);

    // 4. æ­£åˆ™æå– URL
    const textProcessAction: Action = {
      id: Date.now() + 3,
      macroId: this.macroId,
      type: ActionType.TEXT_PROCESS,
      config: JSON.stringify({
        operation: 'regex_extract',
        input: '{clipboard_content}',
        pattern: 'https?://[^\\s]+',
        groupIndex: 0,
        saveToVariable: 'extracted_url'
      }),
      orderIndex: 2
    };
    this.actions.push(textProcessAction);

    // 5. ç”¨æˆ·å¯¹è¯æ¡† - é€‰æ‹©çˆ†æ¬¾æ ‡è®°
    const qualityDialogAction: Action = {
      id: Date.now() + 4,
      macroId: this.macroId,
      type: ActionType.USER_DIALOG,
      config: JSON.stringify({
        dialogType: 'single_select',
        title: 'ğŸ”¥ è¯·æ ‡è®°å†…å®¹ç«çˆ†ç¨‹åº¦',
        message: 'è¯·é€‰æ‹©å†…å®¹çš„è´¨é‡ç­‰çº§',
        options: ['âšª æ™®é€šæ¬¾', 'ğŸŸ¡ æ½œåŠ›æ¬¾', 'ğŸ”´ å¤§çˆ†æ¬¾'],
        saveToVariable: 'quality'
      }),
      orderIndex: 3
    };
    this.actions.push(qualityDialogAction);

    // 6. ç”¨æˆ·å¯¹è¯æ¡† - é€‰æ‹©åˆ†ç±»æ ‡ç­¾ï¼ˆ40ä¸ªé€‰é¡¹ï¼‰
    const labelDialogAction: Action = {
      id: Date.now() + 5,
      macroId: this.macroId,
      type: ActionType.USER_DIALOG,
      config: JSON.stringify({
        dialogType: 'single_select',
        title: 'ğŸ“‘ è¯·é€‰æ‹©åˆ†ç±»æ ‡ç­¾',
        message: 'ä¾¿äºåˆ†ç±»ç®¡ç†',
        options: [
          'ğŸ’„æ—¶å°šç¾å¦†', 'ğŸŒæ—…æ¸¸å‡ºè¡Œ', 'ğŸœç¾é£Ÿæ¶ˆè´¹', 'ğŸ“šå­¦ä¹ æ•™è‚²',
          'ğŸ’¹å•†ä¸šè´¢ç»', 'ğŸ’¼èŒåœº', 'ğŸ’´ç”Ÿç±³é¡¹ç›®', 'âœ¨åˆ›æ„çµæ„Ÿ',
          'ğŸ“å¹²è´§åˆ†äº«', 'âš™ï¸æ•ˆç‡å·¥å…·', 'ğŸæ–°å¥‡å¥½ç‰©', 'ğŸ å®¶å±…å®¶è£…',
          'ğŸ‘¶äº²å­æ¯å©´', 'ğŸ’–æƒ…æ„Ÿå¿ƒç†', 'ğŸ¥åŒ»ç–—å¥åº·', 'ğŸ“ºå½±è§†ç»¼è‰º',
          'ğŸµéŸ³ä¹', 'ğŸ“°æ—¶æ”¿ç¤¾ä¼š', 'ğŸ¨æ–‡å­¦è‰ºæœ¯', 'ğŸ›ï¸äººæ–‡å†å²',
          'ğŸ­æ‰è‰ºæŠ€èƒ½', 'ğŸ“±ç§‘æŠ€æ•°ç ', 'ğŸ“¸æ‘„å½±', 'ğŸ®æ¸¸æˆ',
          'ğŸš—æ±½è½¦', 'ğŸŒäºŒæ¬¡å…ƒ', 'ğŸ‹ï¸è¿åŠ¨å¥èº«', 'ğŸ”®æ˜Ÿåº§å‘½ç†',
          'ğŸ““ç”Ÿæ´»è®°å½•', 'ğŸ¯å…´è¶£çˆ±å¥½', 'â“å…¶ä»–', 'ğŸ¤–AI',
          'ğŸ å°çº¢ä¹¦', 'ğŸµæŠ–éŸ³', 'ğŸ’¬å¾®ä¿¡ç§åŸŸ', 'ğŸ“ºBç«™å¥½ç‰©',
          'ğŸ¥è§†é¢‘å·', 'ğŸª½é£ä¹¦æ‰£å­', 'â–¶ï¸YouTube', 'ğŸ“åœ¨çº¿è¯¾ç¨‹'
        ],
        saveToVariable: 'label'
      }),
      orderIndex: 4
    };
    this.actions.push(labelDialogAction);

    // 7. ç”¨æˆ·å¯¹è¯æ¡† - å¯¹æ ‡å‚è€ƒåº¦è¯„åˆ†
    const scoreDialogAction: Action = {
      id: Date.now() + 6,
      macroId: this.macroId,
      type: ActionType.USER_DIALOG,
      config: JSON.stringify({
        dialogType: 'single_select',
        title: 'ğŸ‘ è¯·æ ‡è®°å¯¹æ ‡å‚è€ƒåº¦',
        message: '1-5èµï¼Œ0è¡¨ç¤ºè·³è¿‡',
        options: ['5 èµğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘', '4 èµğŸ‘ğŸ‘ğŸ‘ğŸ‘', '3 èµğŸ‘ğŸ‘ğŸ‘', '2 èµğŸ‘ğŸ‘', '1 èµğŸ‘', '0 å…ˆä¸é€‰ï¼Œè·³è¿‡'],
        saveToVariable: 'quality_score'
      }),
      orderIndex: 5
    };
    this.actions.push(scoreDialogAction);

    // 8. ç”¨æˆ·å¯¹è¯æ¡† - å¤‡æ³¨è¯´æ˜è¾“å…¥
    const notesDialogAction: Action = {
      id: Date.now() + 7,
      macroId: this.macroId,
      type: ActionType.USER_DIALOG,
      config: JSON.stringify({
        dialogType: 'text_input',
        title: 'ğŸ“ è¯·è¾“å…¥æ”¶è—å¤‡æ³¨',
        message: 'ï¼ˆé€‰å¡«ï¼‰',
        placeholder: 'è¾“å…¥å¤‡æ³¨å†…å®¹...',
        saveToVariable: 'notes'
      }),
      orderIndex: 6
    };
    this.actions.push(notesDialogAction);

    // 9. å‘é€é€šçŸ¥ - ä¸Šä¼ è¿›åº¦
    const uploadNotificationAction: Action = {
      id: Date.now() + 8,
      macroId: this.macroId,
      type: ActionType.NOTIFICATION,
      config: JSON.stringify({
        title: 'æ•°æ®ä¸Šä¼ ä¸­',
        content: 'è¯·è€å¿ƒç­‰å¾…...',
        enableSound: false,
        enableVibration: false
      }),
      orderIndex: 7
    };
    this.actions.push(uploadNotificationAction);

    // 10. HTTP POST è¯·æ±‚ - è°ƒç”¨ Coze APIï¼ˆç¬”è®°é‡‡é›†å·¥ä½œæµï¼‰
    const headers: HttpHeaders = { 'Content-Type': 'application/json' };
    const httpAction: Action = {
      id: Date.now() + 9,
      macroId: this.macroId,
      type: ActionType.HTTP_REQUEST,
      config: JSON.stringify({
        method: 'POST',
        url: 'https://api.coze.cn/v1/workflow/run',
        headers: headers,
        body: '{"workflow_id":"7550495126771449906","parameters":{"url":"{extracted_url}","quality":"{quality_score}","read":"{quality}","notes":"{notes}","label":["{label}"],"xhscookie":""}}',
        timeout: 30000,
        saveResponseTo: 'api_response'
      }),
      orderIndex: 8
    };
    this.actions.push(httpAction);

    // 11. æ–‡æœ¬å¤„ç† - æå–å“åº”ä¸­çš„æç¤ºè¯­
    const extractPromptAction: Action = {
      id: Date.now() + 10,
      macroId: this.macroId,
      type: ActionType.TEXT_PROCESS,
      config: JSON.stringify({
        operation: 'regex_extract',
        input: '{api_response}',
        pattern: '"prompt":"([^"]+)"',
        groupIndex: 1,
        saveToVariable: 'result_message'
      }),
      orderIndex: 9
    };
    this.actions.push(extractPromptAction);

    // 12. å‘é€é€šçŸ¥ - æˆåŠŸæç¤º
    const successNotificationAction: Action = {
      id: Date.now() + 11,
      macroId: this.macroId,
      type: ActionType.NOTIFICATION,
      config: JSON.stringify({
        title: 'âœ… é‡‡é›†æˆåŠŸ',
        content: '{result_message}',
        enableSound: true,
        enableVibration: true
      }),
      orderIndex: 10
    };
    this.actions.push(successNotificationAction);

    // 13. æ‰“å¼€é£ä¹¦å¤šç»´è¡¨æ ¼
    const openUrlAction: Action = {
      id: Date.now() + 12,
      macroId: this.macroId,
      type: ActionType.OPEN_URL,
      config: JSON.stringify({
        url: 'https://applink.feishu.cn/client/docs/open?url=https://example.feishu.cn/base/xxx',
        openWith: 'browser'
      }),
      orderIndex: 11
    };
    this.actions.push(openUrlAction);

    // 14. æ·»åŠ å¿…éœ€çš„å…¨å±€å˜é‡ï¼ˆæç¤ºç”¨æˆ·é…ç½®ï¼‰
    this.variables.push({
      id: Date.now() + 100,
      scope: VariableScope.MACRO,
      macroId: this.macroId,
      name: 'é£ä¹¦å¤šç»´è¡¨æ ¼æˆæƒç ',
      type: VariableType.STRING,
      value: '',
      createdAt: Date.now(),
      updatedAt: Date.now()
    });

    this.variables.push({
      id: Date.now() + 101,
      scope: VariableScope.MACRO,
      macroId: this.macroId,
      name: 'è®¢å•å·',
      type: VariableType.STRING,
      value: '',
      createdAt: Date.now(),
      updatedAt: Date.now()
    });

    // æ›´æ–°è§†å›¾æ¨¡å‹
    this.updateActionViewModels();

    promptAction.showDialog({
      title: 'å¿«å°çº¢æ¨¡æ¿åˆ›å»ºæˆåŠŸ',
      message: 'å·²åˆ›å»ºåŒ…å«13ä¸ªåŠ¨ä½œçš„å®Œæ•´é‡‡é›†æµç¨‹ã€‚\n\nâš ï¸ è¯·åœ¨å®ç¼–è¾‘é¡µé¢é…ç½®ä»¥ä¸‹å¿…éœ€å˜é‡ï¼š\n1. é£ä¹¦å¤šç»´è¡¨æ ¼æˆæƒç \n2. è®¢å•å·\n\nç„¶åå°†ç¬¬10æ­¥çš„ body ä¸­çš„æˆæƒç å’Œè®¢å•å·æ›¿æ¢ä¸º {é£ä¹¦å¤šç»´è¡¨æ ¼æˆæƒç } å’Œ {è®¢å•å·}ã€‚',
      buttons: [
        { text: 'çŸ¥é“äº†', color: '#007DFF' }
      ]
    });
  }

  /**
   * æ·»åŠ è§¦å‘å™¨
   */
  private handleAddTrigger() {
    // æ˜¾ç¤ºè§¦å‘å™¨ç±»å‹é€‰æ‹©å¯¹è¯æ¡†
    promptAction.showDialog({
      title: 'é€‰æ‹©è§¦å‘å™¨ç±»å‹',
      message: 'è¯·é€‰æ‹©ä¸€ç§è§¦å‘å™¨ç±»å‹',
      buttons: [
        { text: 'å®šæ—¶è§¦å‘', color: '#000000' },
        { text: 'ç½‘ç»œçŠ¶æ€è§¦å‘', color: '#000000' },
        { text: 'æ‰‹åŠ¨è§¦å‘', color: '#000000' }
      ]
    }).then((result) => {
      switch (result.index) {
        case 0:
          this.showTimeTriggerDialog();
          break;
        case 1:
          this.showNetworkTriggerDialog();
          break;
        case 2:
          this.addManualTrigger();
          break;
      }
    });
  }

  /**
   * æ˜¾ç¤ºå®šæ—¶è§¦å‘å™¨é…ç½®å¯¹è¯æ¡†
   */
  private showTimeTriggerDialog() {
    promptAction.showDialog({
      title: 'é…ç½®å®šæ—¶è§¦å‘å™¨',
      message: 'è¯·é€‰æ‹©è§¦å‘æ¨¡å¼',
      buttons: [
        { text: 'æ¯æ—¥é‡å¤', color: '#000000' },
        { text: 'æ¯å‘¨é‡å¤', color: '#000000' },
        { text: 'è‡ªå®šä¹‰é—´éš”', color: '#000000' }
      ]
    }).then((result) => {
      let config: TimeTriggerConfig;

      switch (result.index) {
        case 0:
          // æ¯æ—¥é‡å¤ - ç®€åŒ–ç‰ˆï¼šå›ºå®šæ—¶é—´ 09:00
          config = {
            mode: 'daily',
            dailyTime: { hour: 9, minute: 0, second: 0 }
          };
          break;
        case 1:
          // æ¯å‘¨é‡å¤ - ç®€åŒ–ç‰ˆï¼šå‘¨ä¸€è‡³å‘¨äº” 09:00
          config = {
            mode: 'weekly',
            weeklyTime: { weekdays: [1, 2, 3, 4, 5], hour: 9, minute: 0, second: 0 }
          };
          break;
        case 2:
          // è‡ªå®šä¹‰é—´éš” - ç®€åŒ–ç‰ˆï¼š60åˆ†é’Ÿ
          config = {
            mode: 'interval',
            intervalTime: { intervalMinutes: 60 }
          };
          break;
        default:
          return;
      }

      // æ·»åŠ è§¦å‘å™¨åˆ°åˆ—è¡¨
      const trigger: Trigger = {
        id: Date.now(), // ä¸´æ—¶ ID
        macroId: this.macroId,
        type: TriggerType.TIME,
        config: JSON.stringify(config),
        enabled: true
      };
      this.triggers.push(trigger);
      promptAction.showToast({ message: 'å®šæ—¶è§¦å‘å™¨å·²æ·»åŠ ' });
    });
  }

  /**
   * æ˜¾ç¤ºç½‘ç»œçŠ¶æ€è§¦å‘å™¨é…ç½®å¯¹è¯æ¡†
   */
  private showNetworkTriggerDialog() {
    promptAction.showDialog({
      title: 'é…ç½®ç½‘ç»œçŠ¶æ€è§¦å‘å™¨',
      message: 'è¯·é€‰æ‹©è§¦å‘æ¡ä»¶',
      buttons: [
        { text: 'Wi-Fi è¿æ¥', color: '#000000' },
        { text: 'ç§»åŠ¨æ•°æ®è¿æ¥', color: '#000000' },
        { text: 'ç½‘ç»œæ–­å¼€', color: '#000000' }
      ]
    }).then((result) => {
      let triggerOn: 'wifi_connected' | 'mobile_connected' | 'network_disconnected';

      switch (result.index) {
        case 0:
          triggerOn = 'wifi_connected';
          break;
        case 1:
          triggerOn = 'mobile_connected';
          break;
        case 2:
          triggerOn = 'network_disconnected';
          break;
        default:
          return;
      }

      const config: NetworkTriggerConfig = { triggerOn };
      const trigger: Trigger = {
        id: Date.now(),
        macroId: this.macroId,
        type: TriggerType.NETWORK,
        config: JSON.stringify(config),
        enabled: true
      };
      this.triggers.push(trigger);
      promptAction.showToast({ message: 'ç½‘ç»œçŠ¶æ€è§¦å‘å™¨å·²æ·»åŠ ' });
    });
  }

  /**
   * æ·»åŠ æ‰‹åŠ¨è§¦å‘å™¨
   */
  private addManualTrigger() {
    const trigger: Trigger = {
      id: Date.now(),
      macroId: this.macroId,
      type: TriggerType.MANUAL,
      config: JSON.stringify({ methods: ['button', 'shortcut'] }),
      enabled: true
    };
    this.triggers.push(trigger);
    promptAction.showToast({ message: 'æ‰‹åŠ¨è§¦å‘å™¨å·²æ·»åŠ ' });
  }

  /**
   * åˆ é™¤è§¦å‘å™¨
   */
  private deleteTrigger(index: number) {
    this.triggers.splice(index, 1);
  }

  /**
   * æ·»åŠ åŠ¨ä½œ
   */
  private handleAddAction() {
    // æ˜¾ç¤ºåŠ¨ä½œç±»å‹é€‰æ‹©å¯¹è¯æ¡†
    promptAction.showDialog({
      title: 'é€‰æ‹©åŠ¨ä½œç±»å‹',
      message: 'è¯·é€‰æ‹©è¦æ·»åŠ çš„åŠ¨ä½œ',
      buttons: [
        { text: 'å‘é€é€šçŸ¥', color: '#000000' },
        { text: 'è¯»å–å‰ªè´´æ¿', color: '#000000' },
        { text: 'HTTP è¯·æ±‚', color: '#000000' },
        { text: 'æ‰“å¼€ URL', color: '#000000' },
        { text: 'æ–‡æœ¬å¤„ç†', color: '#000000' },
        { text: 'è®¾ç½®å˜é‡', color: '#000000' },
        { text: 'æ¡ä»¶åˆ†æ”¯', color: '#000000' }
      ]
    }).then((result) => {
      switch (result.index) {
        case 0:
          this.addNotificationAction();
          break;
        case 1:
          this.addClipboardReadAction();
          break;
        case 2:
          this.addHttpRequestAction();
          break;
        case 3:
          this.addOpenUrlAction();
          break;
        case 4:
          this.addTextProcessAction();
          break;
        case 5:
          this.addSetVariableAction();
          break;
        case 6:
          this.addIfElseAction();
          break;
      }
    });
  }

  /**
   * æ·»åŠ å‘é€é€šçŸ¥åŠ¨ä½œ
   */
  private addNotificationAction() {
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.NOTIFICATION,
      config: JSON.stringify({
        title: 'é€šçŸ¥æ ‡é¢˜',
        content: 'é€šçŸ¥å†…å®¹',
        enableSound: true,
        enableVibration: true
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    promptAction.showToast({ message: 'å‘é€é€šçŸ¥åŠ¨ä½œå·²æ·»åŠ ' });
  }

  /**
   * æ·»åŠ è¯»å–å‰ªè´´æ¿åŠ¨ä½œ
   */
  private addClipboardReadAction() {
    // è·å–å·²å­˜åœ¨çš„å˜é‡å
    const existingVars = VariableNameRecommender.extractExistingVariableNames(
      this.actions,
      this.variables
    );

    // æ¨èå˜é‡å
    const recommendedName = VariableNameRecommender.recommendOutputVariableName(
      ActionType.CLIPBOARD_READ,
      existingVars
    );

    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.CLIPBOARD_READ,
      config: JSON.stringify({
        operation: 'read',
        saveToVariable: recommendedName
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    promptAction.showToast({ message: `è¯»å–å‰ªè´´æ¿åŠ¨ä½œå·²æ·»åŠ ï¼Œä¿å­˜åˆ°å˜é‡ ${recommendedName}` });
  }

  /**
   * æ·»åŠ  HTTP è¯·æ±‚åŠ¨ä½œ
   */
  private addHttpRequestAction() {
    // è·å–å·²å­˜åœ¨çš„å˜é‡å
    const existingVars = VariableNameRecommender.extractExistingVariableNames(
      this.actions,
      this.variables
    );

    // æ¨èå˜é‡å
    const recommendedName = VariableNameRecommender.recommendOutputVariableName(
      ActionType.HTTP_REQUEST,
      existingVars
    );

    const headers: HttpHeaders = { 'Content-Type': 'application/json' };
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.HTTP_REQUEST,
      config: JSON.stringify({
        method: 'POST',
        url: 'https://example.com/api',
        headers: headers,
        body: '{}',
        timeout: 30000,
        saveResponseTo: recommendedName
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    promptAction.showToast({ message: `HTTP è¯·æ±‚åŠ¨ä½œå·²æ·»åŠ ï¼Œä¿å­˜åˆ°å˜é‡ ${recommendedName}` });
  }

  /**
   * æ·»åŠ æ‰“å¼€ URL åŠ¨ä½œ
   */
  private addOpenUrlAction() {
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.OPEN_URL,
      config: JSON.stringify({
        url: 'https://example.com',
        openWith: 'browser'
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    promptAction.showToast({ message: 'æ‰“å¼€ URL åŠ¨ä½œå·²æ·»åŠ ' });
  }

  /**
   * æ·»åŠ æ–‡æœ¬å¤„ç†åŠ¨ä½œ
   */
  private addTextProcessAction() {
    // è·å–å·²å­˜åœ¨çš„å˜é‡å
    const existingVars = VariableNameRecommender.extractExistingVariableNames(
      this.actions,
      this.variables
    );

    // è·å–å‰ä¸€ä¸ªåŠ¨ä½œç±»å‹ï¼ˆç”¨äºä¸Šä¸‹æ–‡æ¨èï¼‰
    const previousActionType = this.actions.length > 0 ?
      this.actions[this.actions.length - 1].type : undefined;

    // æ¨èå˜é‡åï¼ˆä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼‰
    const recommendedName = VariableNameRecommender.recommendContextualVariableName(
      ActionType.TEXT_PROCESS,
      'regex_extract',
      previousActionType,
      existingVars
    );

    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.TEXT_PROCESS,
      config: JSON.stringify({
        operation: 'regex_extract',
        input: '{clipboard_content}',
        pattern: 'https?://[^\\s]+',
        groupIndex: 0,
        saveToVariable: recommendedName
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    promptAction.showToast({ message: `æ–‡æœ¬å¤„ç†åŠ¨ä½œå·²æ·»åŠ ï¼Œä¿å­˜åˆ°å˜é‡ ${recommendedName}` });
  }

  /**
   * æ·»åŠ è®¾ç½®å˜é‡åŠ¨ä½œ
   */
  private addSetVariableAction() {
    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.SET_VARIABLE,
      config: JSON.stringify({
        variableName: 'my_variable',
        value: '',
        scope: 'runtime'
      }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    promptAction.showToast({ message: 'è®¾ç½®å˜é‡åŠ¨ä½œå·²æ·»åŠ ' });
  }

  /**
   * æ·»åŠ æ¡ä»¶åˆ†æ”¯åŠ¨ä½œ
   */
  private addIfElseAction() {
    // åˆ›å»ºä¸€ä¸ªç®€å•çš„ IF_ELSE æ¨¡æ¿
    // å®šä¹‰åˆ†æ”¯é…ç½®çš„ç±»å‹
    interface Condition {
      field: string;
      operator: string;
      value: string;
    }

    interface NotificationConfig {
      title: string;
      content: string;
      enableSound: boolean;
      enableVibration: boolean;
    }

    interface ActionWithConfig {
      type: string;
      config: NotificationConfig;
    }

    interface IfElseBranchConfig {
      name: string;
      conditions: Condition[];
      actions: ActionWithConfig[];
    }

    const branches: IfElseBranchConfig[] = [
      {
        name: 'åˆ†æ”¯1',
        conditions: [
          {
            field: '{variable_name}',
            operator: '==',
            value: 'value1'
          }
        ],
        actions: [
          {
            type: 'notification',
            config: {
              title: 'åˆ†æ”¯1æ‰§è¡Œ',
              content: 'æ¡ä»¶æ»¡è¶³æ—¶æ‰§è¡Œæ­¤åˆ†æ”¯',
              enableSound: false,
              enableVibration: false
            }
          }
        ]
      },
      {
        name: 'elseåˆ†æ”¯',
        conditions: [],  // ç©ºæ¡ä»¶è¡¨ç¤º else
        actions: [
          {
            type: 'notification',
            config: {
              title: 'elseåˆ†æ”¯æ‰§è¡Œ',
              content: 'æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³æ—¶æ‰§è¡Œæ­¤åˆ†æ”¯',
              enableSound: false,
              enableVibration: false
            }
          }
        ]
      }
    ];

    const action: Action = {
      id: Date.now(),
      macroId: this.macroId,
      type: ActionType.IF_ELSE,
      config: JSON.stringify({ branches: branches }),
      orderIndex: this.actions.length
    };
    this.actions.push(action);
    this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    promptAction.showToast({ message: 'æ¡ä»¶åˆ†æ”¯åŠ¨ä½œå·²æ·»åŠ ï¼Œè¯·åœ¨é…ç½®é¢æ¿ç¼–è¾‘' });
  }

  /**
   * åˆ é™¤åŠ¨ä½œ
   */
  private deleteAction(index: number) {
    // æ£€æŸ¥æ˜¯å¦ä¼šå½±å“å…¶ä»–åŠ¨ä½œ
    const affectedIndices = VariableFlowAnalyzer.getAffectedActionsByDeletion(
      this.actions,
      index
    );

    if (affectedIndices.length > 0) {
      const affectedActions = affectedIndices.map(i => `åŠ¨ä½œ ${i + 1}`).join('ã€');
      promptAction.showDialog({
        title: 'è­¦å‘Š',
        message: `åˆ é™¤æ­¤åŠ¨ä½œä¼šå½±å“ ${affectedActions}ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`,
        buttons: [
          { text: 'å–æ¶ˆ', color: '#000000' },
          { text: 'åˆ é™¤', color: '#ff4d4f' }
        ]
      }).then((result) => {
        if (result.index === 1) {
          this.actions.splice(index, 1);
          // é‡æ–°è°ƒæ•´ orderIndex
          this.actions.forEach((action, idx) => {
            action.orderIndex = idx;
          });
          this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
        }
      });
    } else {
      this.actions.splice(index, 1);
      // é‡æ–°è°ƒæ•´ orderIndex
      this.actions.forEach((action, idx) => {
        action.orderIndex = idx;
      });
      this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    }
  }

  /**
   * ä¸Šç§»åŠ¨ä½œ
   */
  private moveActionUp(index: number) {
    if (index > 0) {
      const temp = this.actions[index];
      this.actions[index] = this.actions[index - 1];
      this.actions[index - 1] = temp;
      // æ›´æ–° orderIndex
      this.actions.forEach((action, idx) => {
        action.orderIndex = idx;
      });
      this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    }
  }

  /**
   * ä¸‹ç§»åŠ¨ä½œ
   */
  private moveActionDown(index: number) {
    if (index < this.actions.length - 1) {
      const temp = this.actions[index];
      this.actions[index] = this.actions[index + 1];
      this.actions[index + 1] = temp;
      // æ›´æ–° orderIndex
      this.actions.forEach((action, idx) => {
        action.orderIndex = idx;
      });
      this.updateActionViewModels(); // æ›´æ–°è§†å›¾æ¨¡å‹
    }
  }

  /**
   * è·å–è§¦å‘å™¨æè¿°
   */
  private getTriggerDescription(trigger: Trigger): string {
    if (trigger.type === TriggerType.TIME) {
      const config = JSON.parse(trigger.config) as TimeTriggerConfig;
      switch (config.mode) {
        case 'daily':
          return `æ¯æ—¥ ${config.dailyTime?.hour || 0}:${String(config.dailyTime?.minute || 0).padStart(2, '0')}`;
        case 'weekly':
          return `æ¯å‘¨é‡å¤`;
        case 'interval':
          return `æ¯ ${config.intervalTime?.intervalMinutes || 0} åˆ†é’Ÿ`;
        default:
          return 'å®šæ—¶è§¦å‘';
      }
    } else if (trigger.type === TriggerType.NETWORK) {
      const config = JSON.parse(trigger.config) as NetworkTriggerConfig;
      const triggerNames: Record<string, string> = {
        'wifi_connected': 'Wi-Fi è¿æ¥æ—¶',
        'mobile_connected': 'ç§»åŠ¨æ•°æ®è¿æ¥æ—¶',
        'network_disconnected': 'ç½‘ç»œæ–­å¼€æ—¶'
      };
      return triggerNames[config.triggerOn] || 'ç½‘ç»œçŠ¶æ€è§¦å‘';
    } else if (trigger.type === TriggerType.MANUAL) {
      return 'æ‰‹åŠ¨è§¦å‘';
    }
    return trigger.type;
  }

  /**
   * è·å–åŠ¨ä½œæè¿°
   */
  private getActionDescription(action: Action): string {
    const actionNames: Record<string, string> = {
      'notification': 'å‘é€é€šçŸ¥',
      'clipboard_read': 'è¯»å–å‰ªè´´æ¿',
      'clipboard_write': 'å†™å…¥å‰ªè´´æ¿',
      'http_request': 'HTTP è¯·æ±‚',
      'open_url': 'æ‰“å¼€ URL',
      'text_process': 'æ–‡æœ¬å¤„ç†',
      'launch_app': 'å¯åŠ¨åº”ç”¨',
      'user_dialog': 'ç”¨æˆ·å¯¹è¯æ¡†',
      'set_variable': 'è®¾ç½®å˜é‡'
    };
    return actionNames[action.type] || action.type;
  }

  // ==================== å˜é‡ç®¡ç† ====================

  /**
   * æ·»åŠ å®å˜é‡
   */
  private handleAddVariable() {
    this.isVariableEditMode = false;
    this.editingVariableIndex = -1;
    this.varEditorName = '';
    this.varEditorType = VariableType.STRING;
    this.varEditorValue = '';
    this.showVariableEditor = true;
  }

  /**
   * ç¼–è¾‘å®å˜é‡
   */
  private handleEditVariable(variable: Variable, index: number) {
    this.isVariableEditMode = true;
    this.editingVariableIndex = index;
    this.varEditorName = variable.name;
    this.varEditorType = variable.type;
    this.varEditorValue = this.formatVariableValueForInput(variable);
    this.showVariableEditor = true;
  }

  /**
   * æ ¼å¼åŒ–å˜é‡å€¼ç”¨äºè¾“å…¥
   */
  private formatVariableValueForInput(variable: Variable): string {
    if (variable.type === VariableType.BOOLEAN) {
      return variable.value ? 'true' : 'false';
    }
    return String(variable.value);
  }

  /**
   * ä¿å­˜å®å˜é‡
   */
  private handleSaveVariable() {
    // éªŒè¯è¾“å…¥
    if (!this.varEditorName || this.varEditorName.trim().length === 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å˜é‡åç§°' });
      return;
    }

    // éªŒè¯å˜é‡åæ ¼å¼
    const namePattern = /^[a-zA-Z_][a-zA-Z0-9_]*$/;
    if (!namePattern.test(this.varEditorName)) {
      promptAction.showToast({ message: 'å˜é‡ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œä¸”ä¸èƒ½ä»¥æ•°å­—å¼€å¤´' });
      return;
    }

    let value: string | number | boolean;

    // æ ¹æ®ç±»å‹è§£æå€¼
    if (this.varEditorType === VariableType.STRING) {
      value = this.varEditorValue;
    } else if (this.varEditorType === VariableType.NUMBER) {
      value = Number(this.varEditorValue);
      if (isNaN(value)) {
        promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—' });
        return;
      }
    } else {
      value = this.varEditorValue.toLowerCase() === 'true';
    }

    if (this.isVariableEditMode && this.editingVariableIndex >= 0) {
      // æ›´æ–°å˜é‡
      this.variables[this.editingVariableIndex].name = this.varEditorName.trim();
      this.variables[this.editingVariableIndex].type = this.varEditorType;
      this.variables[this.editingVariableIndex].value = value;
      this.variables[this.editingVariableIndex].updatedAt = Date.now();
      promptAction.showToast({ message: 'å˜é‡å·²æ›´æ–°' });
    } else {
      // æ·»åŠ æ–°å˜é‡
      const variable: Variable = {
        id: Date.now(),
        scope: VariableScope.MACRO,
        macroId: this.macroId,
        name: this.varEditorName.trim(),
        type: this.varEditorType,
        value: value,
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      this.variables.push(variable);
      promptAction.showToast({ message: 'å˜é‡å·²æ·»åŠ ' });
    }

    this.showVariableEditor = false;
  }

  /**
   * å–æ¶ˆç¼–è¾‘å˜é‡
   */
  private handleCancelVariableEdit() {
    this.showVariableEditor = false;
  }

  /**
   * åˆ é™¤å˜é‡
   */
  private deleteVariable(index: number) {
    this.variables.splice(index, 1);
  }

  /**
   * è·å–å˜é‡ç±»å‹æ˜¾ç¤ºæ–‡æœ¬
   */
  private getVariableTypeLabel(type: VariableType): string {
    const labels: Record<string, string> = {
      'string': 'æ–‡æœ¬',
      'number': 'æ•°å­—',
      'boolean': 'å¸ƒå°”'
    };
    return labels[type] || type;
  }

  /**
   * æ ¼å¼åŒ–å˜é‡å€¼æ˜¾ç¤º
   */
  private formatVariableValue(variable: Variable): string {
    if (variable.type === VariableType.BOOLEAN) {
      return variable.value ? 'æ˜¯' : 'å¦';
    }
    return String(variable.value);
  }

  build() {
    Column() {
      // ç»Ÿä¸€é¡¶éƒ¨æ ‡é¢˜æ 
      CommonTopBar({
        title: this.isEditMode ? 'ç¼–è¾‘å®' : 'åˆ›å»ºå®',
        onLeftClick: () => { this.handleCancel(); },
        onRightClick: () => { this.handleSave(); }
      })

      // è¡¨å•å†…å®¹
      Scroll() {
        Column({ space: 16 }) {
          // åŸºæœ¬ä¿¡æ¯åŒºåŸŸ
          Column({ space: 16 }) {
            Text('åŸºæœ¬ä¿¡æ¯')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)

            // å®åç§°
            Column({ space: 8 }) {
              Text('å®åç§° *')
                .fontSize(14)
                .fontColor('#666666')

              TextInput({ placeholder: 'è¯·è¾“å…¥å®åç§°ï¼ˆ1-50 å­—ç¬¦ï¼‰', text: this.macroName })
                .fontSize(16)
                .onChange((value: string) => {
                  this.macroName = value;
                })
            }
            .alignItems(HorizontalAlign.Start)
            .width('100%')

            // å®æè¿°
            Column({ space: 8 }) {
              Text('æè¿°ï¼ˆå¯é€‰ï¼‰')
                .fontSize(14)
                .fontColor('#666666')

              TextArea({ placeholder: 'è¯·è¾“å…¥å®æè¿°', text: this.macroDescription })
                .fontSize(16)
                .height(100)
                .onChange((value: string) => {
                  this.macroDescription = value;
                })
            }
            .alignItems(HorizontalAlign.Start)
            .width('100%')

            // å¯ç”¨çŠ¶æ€
            Row() {
              Text('å¯ç”¨å®')
                .fontSize(16)
                .flexGrow(1)

              Toggle({ type: ToggleType.Switch, isOn: this.macroEnabled })
                .onChange((isOn: boolean) => {
                  this.macroEnabled = isOn;
                })
            }
            .width('100%')
          }
          .padding(16)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start)

          // æ¨¡æ¿åŒºåŸŸ
          Column({ space: 12 }) {
            Text('å¿«é€Ÿå¼€å§‹')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)

            Text('ä½¿ç”¨é¢„è®¾æ¨¡æ¿å¿«é€Ÿåˆ›å»ºå®')
              .fontSize(12)
              .fontColor('#999999')

            // å¿«å°çº¢æ¨¡æ¿æŒ‰é’®
            Row({ space: 12 }) {
              Column({ space: 8 }) {
                Row({ space: 8 }) {
                  Text('ğŸ“±')
                    .fontSize(24)

                  Column({ space: 4 }) {
                    Text('å¿«å°çº¢æµç¨‹')
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)

                    Text('å°çº¢ä¹¦å†…å®¹é‡‡é›†åˆ°é£ä¹¦')
                      .fontSize(12)
                      .fontColor('#666666')
                  }
                  .alignItems(HorizontalAlign.Start)
                  .flexGrow(1)
                }

                Text('åŒ…å«ï¼šè¯»å–å‰ªè´´æ¿ â†’ URLæå– â†’ ç”¨æˆ·é€‰æ‹© â†’ APIè°ƒç”¨ â†’ æ‰“å¼€é£ä¹¦')
                  .fontSize(11)
                  .fontColor('#999999')
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
              .flexGrow(1)
              .padding(12)
              .backgroundColor('#f0f9ff')
              .borderRadius(8)
              .border({ width: 1, color: '#91d5ff' })
              .onClick(() => {
                this.applyKuaiXiaoHongTemplate();
              })
            }
            .width('100%')
          }
          .padding(16)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start)

          // è§¦å‘å™¨åŒºåŸŸ
          Column({ space: 12 }) {
            Row() {
              Text('è§¦å‘å™¨')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .flexGrow(1)

              Text('è‡³å°‘æ·»åŠ  1 ä¸ª')
                .fontSize(12)
                .fontColor('#999999')
            }
            .width('100%')

            // è§¦å‘å™¨åˆ—è¡¨
            if (this.triggers.length === 0) {
              Text('æš‚æ— è§¦å‘å™¨')
                .fontSize(14)
                .fontColor('#999999')
                .width('100%')
                .textAlign(TextAlign.Center)
                .padding(20)
            } else {
              Column({ space: 8 }) {
                ForEach(this.triggers, (trigger: Trigger, index: number) => {
                  Row({ space: 12 }) {
                    Column({ space: 4 }) {
                      Text(this.getTriggerDescription(trigger))
                        .fontSize(16)
                        .fontWeight(FontWeight.Medium)

                      Text(trigger.type)
                        .fontSize(12)
                        .fontColor('#666666')
                    }
                    .flexGrow(1)
                    .alignItems(HorizontalAlign.Start)

                    Button('åˆ é™¤')
                      .fontSize(14)
                      .height(32)
                      .backgroundColor('#ff4444')
                      .onClick(() => {
                        this.deleteTrigger(index);
                      })
                  }
                  .width('100%')
                  .padding(12)
                  .backgroundColor('#f5f5f5')
                  .borderRadius(8)
                }, (trigger: Trigger, index: number) => index.toString())
              }
              .width('100%')
            }

            // æ·»åŠ è§¦å‘å™¨æŒ‰é’®
            Button('+ æ·»åŠ è§¦å‘å™¨')
              .width('100%')
              .height(40)
              .fontSize(16)
              .backgroundColor('#007DFF')
              .onClick(() => {
                this.handleAddTrigger();
              })
          }
          .padding(16)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start)

          // åŠ¨ä½œåŒºåŸŸ
          Column({ space: 12 }) {
            Row() {
              Text('åŠ¨ä½œåˆ—è¡¨')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .flexGrow(1)

              Text('è‡³å°‘æ·»åŠ  1 ä¸ª')
                .fontSize(12)
                .fontColor('#999999')
            }
            .width('100%')

            // åŠ¨ä½œåˆ—è¡¨
            if (this.actionViewModels.length === 0) {
              Text('æš‚æ— åŠ¨ä½œ')
                .fontSize(14)
                .fontColor('#999999')
                .width('100%')
                .textAlign(TextAlign.Center)
                .padding(20)
            } else {
              Column({ space: 12 }) {
                ForEach(this.actionViewModels, (viewModel: ActionViewModel, index: number) => {
                  Column({ space: 8 }) {
                    // åŠ¨ä½œå¡ç‰‡
                    Column({ space: 12 }) {
                      // æ ‡é¢˜è¡Œ
                      Row({ space: 12 }) {
                        // åºå·å’ŒåŠ¨ä½œç±»å‹
                        Row({ space: 8 }) {
                          // åºå·åœ†åœˆ
                          Text(`${index + 1}`)
                            .fontSize(14)
                            .fontWeight(FontWeight.Bold)
                            .fontColor('#ffffff')
                            .width(28)
                            .height(28)
                            .textAlign(TextAlign.Center)
                            .borderRadius(14)
                            .backgroundColor(viewModel.isValid ? '#007DFF' : '#ff4d4f')

                          Column({ space: 4 }) {
                            Text(this.getActionDescription(viewModel))
                              .fontSize(16)
                              .fontWeight(FontWeight.Bold)

                            if (viewModel.configSummary) {
                              Text(viewModel.configSummary)
                                .fontSize(12)
                                .fontColor('#666666')
                                .maxLines(2)
                                .textOverflow({ overflow: TextOverflow.Ellipsis })
                            }
                          }
                          .alignItems(HorizontalAlign.Start)
                          .flexGrow(1)
                        }
                        .flexGrow(1)

                        // ç¼–è¾‘æŒ‰é’®
                        Button('ç¼–è¾‘')
                          .fontSize(12)
                          .height(28)
                          .padding({ left: 12, right: 12 })
                          .backgroundColor('#e6f7ff')
                          .fontColor('#1890ff')
                          .onClick(() => {
                            this.handleEditAction(index);
                          })
                      }
                      .width('100%')

                      // è¾“å…¥å˜é‡æ ‡ç­¾
                      if (viewModel.inputVariables.length > 0) {
                        Row({ space: 8 }) {
                          Text('ä½¿ç”¨å˜é‡:')
                            .fontSize(12)
                            .fontColor('#999999')

                          Flex({ wrap: FlexWrap.Wrap }) {
                            ForEach(viewModel.inputVariables, (varName: string) => {
                              Text(`{${varName}}`)
                                .fontSize(11)
                                .fontColor(this.highlightedVariable === varName ? '#ffffff' : '#52c41a')
                                .backgroundColor(this.highlightedVariable === varName ? '#52c41a' : '#f6ffed')
                                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                                .borderRadius(4)
                                .margin({ right: 4, bottom: 4 })
                                .border({
                                  width: this.highlightedVariable === varName ? 2 : 1,
                                  color: this.highlightedVariable === varName ? '#52c41a' : '#b7eb8f'
                                })
                                .onClick(() => {
                                  this.handleVariableClick(varName);
                                })
                            })
                          }
                        }
                        .width('100%')
                      }

                      // è¾“å‡ºå˜é‡æ ‡ç­¾
                      if (viewModel.outputVariable) {
                        Row({ space: 8 }) {
                          Text('è¾“å‡º â†’')
                            .fontSize(12)
                            .fontColor('#999999')

                          Text(`[${viewModel.outputVariable}]`)
                            .fontSize(11)
                            .fontColor(this.highlightedVariable === viewModel.outputVariable ? '#ffffff' : '#1890ff')
                            .fontWeight(FontWeight.Bold)
                            .backgroundColor(this.highlightedVariable === viewModel.outputVariable ? '#1890ff' : '#e6f7ff')
                            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                            .borderRadius(4)
                            .border({
                              width: this.highlightedVariable === viewModel.outputVariable ? 2 : 1,
                              color: this.highlightedVariable === viewModel.outputVariable ? '#1890ff' : '#91d5ff'
                            })
                            .onClick(() => {
                              this.handleVariableClick(viewModel.outputVariable!);
                            })
                        }
                        .width('100%')
                      }

                      // éªŒè¯é”™è¯¯æç¤º
                      if (!viewModel.isValid && viewModel.validationErrors.length > 0) {
                        Column({ space: 4 }) {
                          ForEach(viewModel.validationErrors, (error: string) => {
                            Row({ space: 6 }) {
                              Text('âš ï¸')
                                .fontSize(12)

                              Text(error)
                                .fontSize(12)
                                .fontColor('#ff4d4f')
                                .flexGrow(1)
                            }
                          })
                        }
                        .width('100%')
                        .padding(8)
                        .backgroundColor('#fff1f0')
                        .borderRadius(4)
                        .border({ width: 1, color: '#ffa39e' })
                      }

                      // æ“ä½œæŒ‰é’®è¡Œ
                      Row({ space: 8 }) {
                        // æ’åºæŒ‰é’®
                        Row({ space: 4 }) {
                          Button('â†‘')
                            .fontSize(14)
                            .height(28)
                            .width(36)
                            .padding(0)
                            .backgroundColor(index > 0 ? '#f0f0f0' : '#e0e0e0')
                            .fontColor(index > 0 ? '#333333' : '#999999')
                            .enabled(index > 0)
                            .onClick(() => {
                              this.moveActionUp(index);
                            })

                          Button('â†“')
                            .fontSize(14)
                            .height(28)
                            .width(36)
                            .padding(0)
                            .backgroundColor(index < this.actionViewModels.length - 1 ? '#f0f0f0' : '#e0e0e0')
                            .fontColor(index < this.actionViewModels.length - 1 ? '#333333' : '#999999')
                            .enabled(index < this.actionViewModels.length - 1)
                            .onClick(() => {
                              this.moveActionDown(index);
                            })
                        }

                        Blank()

                        Button('åˆ é™¤')
                          .fontSize(12)
                          .height(28)
                          .padding({ left: 12, right: 12 })
                          .backgroundColor('#fff1f0')
                          .fontColor('#ff4d4f')
                          .onClick(() => {
                            this.deleteAction(index);
                          })
                      }
                      .width('100%')
                    }
                    .width('100%')
                    .padding(16)
                    .backgroundColor('#ffffff')
                    .borderRadius(8)
                    .border({
                      width: viewModel.isValid ? 1 : 2,
                      color: viewModel.isValid ? '#e8e8e8' : '#ff4d4f'
                    })

                    // å˜é‡æµå‘è¿çº¿ï¼ˆä½¿ç”¨ Unicode ç®­å¤´ï¼‰
                    if (index < this.actionViewModels.length - 1) {
                      // æ£€æŸ¥å½“å‰åŠ¨ä½œæ˜¯å¦æœ‰è¾“å‡ºå˜é‡ï¼Œä¸”ä¸‹ä¸€ä¸ªåŠ¨ä½œä½¿ç”¨äº†è¯¥å˜é‡
                      if (viewModel.outputVariable &&
                        this.actionViewModels[index + 1].inputVariables.includes(viewModel.outputVariable)) {
                        // æœ‰å˜é‡ä¼ é€’ï¼Œæ˜¾ç¤ºå˜é‡æ ‡ç­¾
                        Row() {
                          Text('â†“')
                            .fontSize(20)
                            .fontColor(this.highlightedVariable === viewModel.outputVariable ? '#52c41a' : '#1890ff')
                            .width('100%')
                            .textAlign(TextAlign.Center)

                          Text(`{${viewModel.outputVariable}}`)
                            .fontSize(11)
                            .fontColor(this.highlightedVariable === viewModel.outputVariable ? '#ffffff' : '#1890ff')
                            .backgroundColor(this.highlightedVariable === viewModel.outputVariable ? '#52c41a' : '#e6f7ff')
                            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                            .borderRadius(4)
                            .border({
                              width: this.highlightedVariable === viewModel.outputVariable ? 2 : 1,
                              color: this.highlightedVariable === viewModel.outputVariable ? '#52c41a' : '#91d5ff'
                            })
                            .position({ x: '50%', y: 10 })
                            .translate({ x: '-50%', y: 0 })
                            .onClick(() => {
                              this.handleVariableClick(viewModel.outputVariable!);
                            })
                        }
                        .width('100%')
                        .height(32)
                        .justifyContent(FlexAlign.Center)
                      } else if (viewModel.outputVariable) {
                        // æœ‰è¾“å‡ºä½†æœªè¢«ä½¿ç”¨ï¼Œæ˜¾ç¤ºæ™®é€šè¿çº¿
                        Text('â†“')
                          .fontSize(16)
                          .fontColor('#d9d9d9')
                          .width('100%')
                          .textAlign(TextAlign.Center)
                          .height(24)
                      } else {
                        // æ²¡æœ‰è¾“å‡ºå˜é‡ï¼Œæ˜¾ç¤ºæ™®é€šè¿çº¿
                        Text('â†“')
                          .fontSize(16)
                          .fontColor('#d9d9d9')
                          .width('100%')
                          .textAlign(TextAlign.Center)
                          .height(24)
                      }
                    }
                  }
                  .width('100%')
                }, (viewModel: ActionViewModel, index: number) => {
                  // ä½¿ç”¨å¤šä¸ªå±æ€§ç»„åˆä½œä¸º keyï¼Œç¡®ä¿é…ç½®å˜åŒ–æ—¶è§¦å‘é‡æ–°æ¸²æŸ“
                  const id = viewModel.id || 0;
                  const summary = viewModel.configSummary || '';
                  const valid = viewModel.isValid ? '1' : '0';
                  return `${index}_${id}_${summary}_${valid}`;
                })
              }
              .width('100%')
            }

            // æ·»åŠ åŠ¨ä½œæŒ‰é’®
            Button('+ æ·»åŠ åŠ¨ä½œ')
              .width('100%')
              .height(40)
              .fontSize(16)
              .backgroundColor('#007DFF')
              .onClick(() => {
                this.handleAddAction();
              })
          }
          .padding(16)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start)

          // å®å˜é‡åŒºåŸŸ
          Column({ space: 12 }) {
            Row() {
              Text('å®å˜é‡')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .flexGrow(1)

              Text('å¯é€‰')
                .fontSize(12)
                .fontColor('#999999')
            }
            .width('100%')

            // å˜é‡ç¼–è¾‘å™¨
            if (this.showVariableEditor) {
              Column({ space: 16 }) {
                Text(this.isVariableEditMode ? 'ç¼–è¾‘å˜é‡' : 'æ·»åŠ å˜é‡')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)

                // å˜é‡åç§°
                Column({ space: 8 }) {
                  Text('å˜é‡åç§° *')
                    .fontSize(14)
                    .fontColor('#666666')

                  TextInput({ placeholder: 'ä¾‹å¦‚ï¼šcounter', text: this.varEditorName })
                    .fontSize(14)
                    .onChange((value: string) => {
                      this.varEditorName = value;
                    })

                  Text('åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œä¸”ä¸èƒ½ä»¥æ•°å­—å¼€å¤´')
                    .fontSize(12)
                    .fontColor('#999999')
                }
                .alignItems(HorizontalAlign.Start)
                .width('100%')

                // å˜é‡ç±»å‹
                Column({ space: 8 }) {
                  Text('å˜é‡ç±»å‹ *')
                    .fontSize(14)
                    .fontColor('#666666')

                  Row({ space: 8 }) {
                    Button('æ–‡æœ¬')
                      .fontSize(12)
                      .height(28)
                      .backgroundColor(this.varEditorType === VariableType.STRING ? '#007DFF' : '#f0f0f0')
                      .fontColor(this.varEditorType === VariableType.STRING ? '#ffffff' : '#333333')
                      .onClick(() => {
                        this.varEditorType = VariableType.STRING;
                        if (this.varEditorValue === 'true' || this.varEditorValue === 'false') {
                          this.varEditorValue = '';
                        }
                      })
                      .enabled(!this.isVariableEditMode)

                    Button('æ•°å­—')
                      .fontSize(12)
                      .height(28)
                      .backgroundColor(this.varEditorType === VariableType.NUMBER ? '#007DFF' : '#f0f0f0')
                      .fontColor(this.varEditorType === VariableType.NUMBER ? '#ffffff' : '#333333')
                      .onClick(() => {
                        this.varEditorType = VariableType.NUMBER;
                        this.varEditorValue = '0';
                      })
                      .enabled(!this.isVariableEditMode)

                    Button('å¸ƒå°”')
                      .fontSize(12)
                      .height(28)
                      .backgroundColor(this.varEditorType === VariableType.BOOLEAN ? '#007DFF' : '#f0f0f0')
                      .fontColor(this.varEditorType === VariableType.BOOLEAN ? '#ffffff' : '#333333')
                      .onClick(() => {
                        this.varEditorType = VariableType.BOOLEAN;
                        this.varEditorValue = 'true';
                      })
                      .enabled(!this.isVariableEditMode)
                  }
                }
                .alignItems(HorizontalAlign.Start)
                .width('100%')

                // å˜é‡å€¼
                Column({ space: 8 }) {
                  Text('å˜é‡å€¼ *')
                    .fontSize(14)
                    .fontColor('#666666')

                  if (this.varEditorType === VariableType.BOOLEAN) {
                    // å¸ƒå°”ç±»å‹
                    Row({ space: 8 }) {
                      Button('false')
                        .fontSize(12)
                        .height(28)
                        .backgroundColor(this.varEditorValue === 'false' ? '#007DFF' : '#f0f0f0')
                        .fontColor(this.varEditorValue === 'false' ? '#ffffff' : '#333333')
                        .onClick(() => {
                          this.varEditorValue = 'false';
                        })

                      Button('true')
                        .fontSize(12)
                        .height(28)
                        .backgroundColor(this.varEditorValue === 'true' ? '#007DFF' : '#f0f0f0')
                        .fontColor(this.varEditorValue === 'true' ? '#ffffff' : '#333333')
                        .onClick(() => {
                          this.varEditorValue = 'true';
                        })
                    }
                  } else if (this.varEditorType === VariableType.NUMBER) {
                    // æ•°å­—ç±»å‹
                    TextInput({ placeholder: 'ä¾‹å¦‚ï¼š0', text: this.varEditorValue })
                      .fontSize(14)
                      .type(InputType.Number)
                      .onChange((value: string) => {
                        this.varEditorValue = value;
                      })
                  } else {
                    // æ–‡æœ¬ç±»å‹
                    TextInput({ placeholder: 'ä¾‹å¦‚ï¼šé»˜è®¤å€¼', text: this.varEditorValue })
                      .fontSize(14)
                      .onChange((value: string) => {
                        this.varEditorValue = value;
                      })
                  }
                }
                .alignItems(HorizontalAlign.Start)
                .width('100%')

                // æ“ä½œæŒ‰é’®
                Row({ space: 8 }) {
                  Button('å–æ¶ˆ')
                    .fontSize(14)
                    .height(32)
                    .flexGrow(1)
                    .backgroundColor('#f0f0f0')
                    .fontColor('#333333')
                    .onClick(() => {
                      this.handleCancelVariableEdit();
                    })

                  Button('ä¿å­˜')
                    .fontSize(14)
                    .height(32)
                    .flexGrow(1)
                    .backgroundColor('#007DFF')
                    .onClick(() => {
                      this.handleSaveVariable();
                    })
                }
                .width('100%')
              }
              .padding(12)
              .backgroundColor('#e8f4ff')
              .borderRadius(8)
              .width('100%')
            }

            // å˜é‡åˆ—è¡¨
            if (this.variables.length === 0 && !this.showVariableEditor) {
              Text('æš‚æ— å®å˜é‡')
                .fontSize(14)
                .fontColor('#999999')
                .width('100%')
                .textAlign(TextAlign.Center)
                .padding(20)
            } else if (!this.showVariableEditor) {
              Column({ space: 8 }) {
                ForEach(this.variables, (variable: Variable, index: number) => {
                  Row({ space: 12 }) {
                    Column({ space: 4 }) {
                      Text(variable.name)
                        .fontSize(16)
                        .fontWeight(FontWeight.Medium)

                      Row({ space: 8 }) {
                        Text(this.getVariableTypeLabel(variable.type))
                          .fontSize(12)
                          .fontColor('#666666')

                        Text(`å€¼: ${this.formatVariableValue(variable)}`)
                          .fontSize(12)
                          .fontColor('#666666')
                      }
                    }
                    .flexGrow(1)
                    .alignItems(HorizontalAlign.Start)

                    Row({ space: 8 }) {
                      Button('ç¼–è¾‘')
                        .fontSize(14)
                        .height(32)
                        .backgroundColor('#f0f0f0')
                        .fontColor('#333333')
                        .onClick(() => {
                          this.handleEditVariable(variable, index);
                        })

                      Button('åˆ é™¤')
                        .fontSize(14)
                        .height(32)
                        .backgroundColor('#ff4444')
                        .onClick(() => {
                          this.deleteVariable(index);
                        })
                    }
                  }
                  .width('100%')
                  .padding(12)
                  .backgroundColor('#f5f5f5')
                  .borderRadius(8)
                }, (variable: Variable, index: number) => index.toString())
              }
              .width('100%')
            }

            // æ·»åŠ å˜é‡æŒ‰é’®
            if (!this.showVariableEditor) {
              Button('+ æ·»åŠ å®å˜é‡')
                .width('100%')
                .height(40)
                .fontSize(16)
                .backgroundColor('#007DFF')
                .onClick(() => {
                  this.handleAddVariable();
                })
            }
          }
          .padding(16)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start)
        }
        .padding({ left: 16, right: 16, top: 16, bottom: 80 })
        .width('100%')
      }
      .flexGrow(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}
