import { ConfigOption, VariableInfo } from '../models/WorkflowModels';

/**
 * é€‰é¡¹é€‰æ‹©å¼¹çª—
 * ç”¨äºŽ select ç±»åž‹é…ç½®é¡¹ï¼Œæ˜¾ç¤ºé™æ€é€‰é¡¹åˆ—è¡¨ä¾›ç”¨æˆ·é€‰æ‹©
 */
@CustomDialog
export struct OptionsSelectDialog {
  controller: CustomDialogController;
  title: string = 'é€‰æ‹©é€‰é¡¹';
  options: ConfigOption[] = [];
  currentValue: string = '';
  onSelect: (value: string, label: string) => void = () => {};

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text(this.title)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#000000')

        Blank()

        Button() {
          Text('âœ•')
            .fontSize(18)
            .fontColor('#9CA3AF')
        }
        .type(ButtonType.Normal)
        .backgroundColor('transparent')
        .width(32)
        .height(32)
        .onClick(() => {
          this.controller.close();
        })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })
      .border({ width: { bottom: 1 }, color: '#E5E5EA' })

      // é€‰é¡¹åˆ—è¡¨
      List() {
        ForEach(this.options, (option: ConfigOption) => {
          ListItem() {
            Row() {
              Text(option.label)
                .fontSize(16)
                .fontColor('#000000')

              Blank()

              if (option.value === this.currentValue) {
                Text('âœ“')
                  .fontSize(20)
                  .fontColor('#007AFF')
                  .fontWeight(FontWeight.Bold)
              }
            }
            .width('100%')
            .padding({ left: 20, right: 20, top: 14, bottom: 14 })
            .backgroundColor(option.value === this.currentValue ? '#F3F4F6' : 'transparent')
            .onClick(() => {
              this.onSelect(option.value, option.label);
              this.controller.close();
            })
          }
        })
      }
      .width('100%')
      .height(280)
      .divider({ strokeWidth: 1, color: '#F3F4F6', startMargin: 20, endMargin: 20 })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius({ topLeft: 20, topRight: 20 })
  }
}

/**
 * å˜é‡é€‰æ‹©å¼¹çª—
 * ç”¨äºŽ variable ç±»åž‹é…ç½®é¡¹ï¼Œæ˜¾ç¤ºä¸Šä¸‹æ–‡å˜é‡åˆ—è¡¨ä¾›ç”¨æˆ·é€‰æ‹©
 */
@CustomDialog
export struct VariableSelectDialog {
  controller: CustomDialogController;
  title: string = 'é€‰æ‹©å˜é‡';
  variables: VariableInfo[] = [];
  onSelect: (variable: VariableInfo) => void = () => {};

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text(this.title)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#000000')

        Blank()

        Button() {
          Text('âœ•')
            .fontSize(18)
            .fontColor('#9CA3AF')
        }
        .type(ButtonType.Normal)
        .backgroundColor('transparent')
        .width(32)
        .height(32)
        .onClick(() => {
          this.controller.close();
        })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })
      .border({ width: { bottom: 1 }, color: '#E5E5EA' })

      if (this.variables.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ðŸ“¦')
            .fontSize(48)
            .margin({ bottom: 16 })

          Text('æš‚æ— å¯ç”¨å˜é‡')
            .fontSize(16)
            .fontColor('#9CA3AF')
            .margin({ bottom: 8 })

          Text('è¯·å…ˆæ·»åŠ "è®¾ç½®å˜é‡"åŠ¨ä½œ')
            .fontSize(14)
            .fontColor('#C4C4C4')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        // å˜é‡åˆ—è¡¨
        List() {
          ForEach(this.variables, (variable: VariableInfo) => {
            ListItem() {
              Row() {
                // å˜é‡å›¾æ ‡
                Row() {
                  Text(variable.icon || 'ðŸ“¦')
                    .fontSize(18)
                }
                .width(36)
                .height(36)
                .backgroundColor('#FEF3C7')
                .borderRadius(10)
                .justifyContent(FlexAlign.Center)

                Column() {
                  Text(variable.name)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#000000')

                  Text(variable.source || 'ç”¨æˆ·å®šä¹‰')
                    .fontSize(12)
                    .fontColor('#9CA3AF')
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)
                .margin({ left: 12 })

                Blank()

                // å˜é‡ç±»åž‹æ ‡ç­¾
                Text(this.getTypeLabel(variable.type))
                  .fontSize(11)
                  .fontColor('#6B7280')
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .backgroundColor('#F3F4F6')
                  .borderRadius(4)
              }
              .width('100%')
              .padding({ left: 20, right: 20, top: 12, bottom: 12 })
              .onClick(() => {
                this.onSelect(variable);
                this.controller.close();
              })
            }
          })
        }
        .width('100%')
        .height(320)
        .divider({ strokeWidth: 1, color: '#F3F4F6', startMargin: 68, endMargin: 20 })
      }
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius({ topLeft: 20, topRight: 20 })
  }

  getTypeLabel(type: string): string {
    switch (type) {
      case 'string': return 'æ–‡æœ¬';
      case 'number': return 'æ•°å­—';
      case 'boolean': return 'å¸ƒå°”';
      case 'object': return 'å¯¹è±¡';
      default: return type;
    }
  }
}

/**
 * æ•°å­—è¾“å…¥å¼¹çª—
 * ç”¨äºŽ number ç±»åž‹é…ç½®é¡¹
 */
@CustomDialog
export struct NumberInputDialog {
  controller: CustomDialogController;
  title: string = 'è¾“å…¥æ•°å€¼';
  currentValue: number = 0;
  min?: number;
  max?: number;
  placeholder?: string;
  onConfirm: (value: number) => void = () => {};
  @State inputValue: string = '';

  aboutToAppear() {
    this.inputValue = String(this.currentValue);
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button() {
          Text('å–æ¶ˆ')
            .fontSize(16)
            .fontColor('#007AFF')
        }
        .type(ButtonType.Normal)
        .backgroundColor('transparent')
        .onClick(() => {
          this.controller.close();
        })

        Blank()

        Text(this.title)
          .fontSize(17)
          .fontWeight(FontWeight.Bold)
          .fontColor('#000000')

        Blank()

        Button() {
          Text('ç¡®å®š')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#007AFF')
        }
        .type(ButtonType.Normal)
        .backgroundColor('transparent')
        .onClick(() => {
          const num = Number(this.inputValue);
          if (!isNaN(num)) {
            // èŒƒå›´æ ¡éªŒ
            let finalValue = num;
            if (this.min !== undefined && num < this.min) {
              finalValue = this.min;
            }
            if (this.max !== undefined && num > this.max) {
              finalValue = this.max;
            }
            this.onConfirm(finalValue);
          }
          this.controller.close();
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .border({ width: { bottom: 1 }, color: '#E5E5EA' })

      // è¾“å…¥åŒºåŸŸ
      Column() {
        TextInput({ text: this.inputValue, placeholder: this.placeholder || 'è¯·è¾“å…¥æ•°å€¼' })
          .type(InputType.Number)
          .fontSize(24)
          .fontColor('#000000')
          .textAlign(TextAlign.Center)
          .backgroundColor('#F9FAFB')
          .borderRadius(12)
          .padding(16)
          .onChange((value: string) => {
            this.inputValue = value;
          })

        if (this.min !== undefined || this.max !== undefined) {
          Text(`èŒƒå›´: ${this.min ?? '-âˆž'} ~ ${this.max ?? '+âˆž'}`)
            .fontSize(12)
            .fontColor('#9CA3AF')
            .margin({ top: 12 })
        }
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 24, bottom: 32 })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius({ topLeft: 20, topRight: 20 })
  }
}

/**
 * æ–‡æœ¬è¾“å…¥å¼¹çª—
 * ç”¨äºŽ text ç±»åž‹é…ç½®é¡¹
 */
@CustomDialog
export struct TextInputDialog {
  controller: CustomDialogController;
  title: string = 'è¾“å…¥æ–‡æœ¬';
  currentValue: string = '';
  placeholder?: string;
  onConfirm: (value: string) => void = () => {};
  @State inputValue: string = '';

  aboutToAppear() {
    this.inputValue = this.currentValue;
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button() {
          Text('å–æ¶ˆ')
            .fontSize(16)
            .fontColor('#007AFF')
        }
        .type(ButtonType.Normal)
        .backgroundColor('transparent')
        .onClick(() => {
          this.controller.close();
        })

        Blank()

        Text(this.title)
          .fontSize(17)
          .fontWeight(FontWeight.Bold)
          .fontColor('#000000')

        Blank()

        Button() {
          Text('ç¡®å®š')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#007AFF')
        }
        .type(ButtonType.Normal)
        .backgroundColor('transparent')
        .onClick(() => {
          this.onConfirm(this.inputValue);
          this.controller.close();
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .border({ width: { bottom: 1 }, color: '#E5E5EA' })

      // è¾“å…¥åŒºåŸŸ
      Column() {
        TextInput({ text: this.inputValue, placeholder: this.placeholder || 'è¯·è¾“å…¥' })
          .fontSize(16)
          .fontColor('#000000')
          .backgroundColor('#F9FAFB')
          .borderRadius(12)
          .padding(16)
          .onChange((value: string) => {
            this.inputValue = value;
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 24, bottom: 32 })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius({ topLeft: 20, topRight: 20 })
  }
}
